@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject ILogger<RedirectToLogin> Logger
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Redirecting to Login - Evermail</PageTitle>

@* This should never be visible - redirect happens immediately *@
<div class="container mt-5 text-center">
    <div class="alert alert-warning">
        <h4>ðŸ”´ RedirectToLogin Component Rendered</h4>
        <p>If you see this, the redirect didn't work!</p>
    </div>
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Redirecting...</span>
    </div>
    <p class="mt-3 text-muted">Redirecting to login page...</p>
</div>

@code {
    protected override void OnInitialized()
    {
        Logger.LogWarning("ðŸ”´ RedirectToLogin.OnInitialized - Component initialized");
        
        var returnUrl = Navigation.ToBaseRelativePath(Navigation.Uri);
        Logger.LogWarning("ðŸ”´ RedirectToLogin - Current URL: {Uri}, Return URL: {ReturnUrl}", 
            Navigation.Uri, returnUrl);
        
        // Don't redirect if already on login or register page
        if (returnUrl.StartsWith("login", StringComparison.OrdinalIgnoreCase) ||
            returnUrl.StartsWith("register", StringComparison.OrdinalIgnoreCase))
        {
            Logger.LogWarning("ðŸ”´ RedirectToLogin - Already on login/register page, skipping redirect");
            return;
        }

        Logger.LogWarning("ðŸ”´ RedirectToLogin - Preparing redirect to login. Return URL: {ReturnUrl}", returnUrl);
        
        // Preserve the return URL in query string
        // Using Navigation.NavigateTo with forceLoad: true as per Microsoft best practices
        // See: https://learn.microsoft.com/en-us/aspnet/core/blazor/security/?view=aspnetcore-10.0#customize-unauthorized-content-with-the-router-component
        var loginUrl = string.IsNullOrEmpty(returnUrl) || returnUrl == "/"
            ? "/login"
            : $"/login?returnUrl={Uri.EscapeDataString(returnUrl)}";
        
        Logger.LogWarning("ðŸ”´ RedirectToLogin - Calling Navigation.NavigateTo({LoginUrl}, forceLoad: true)", loginUrl);
        Navigation.NavigateTo(loginUrl, forceLoad: true);
        Logger.LogWarning("ðŸ”´ RedirectToLogin - Navigation.NavigateTo called");
    }
}

