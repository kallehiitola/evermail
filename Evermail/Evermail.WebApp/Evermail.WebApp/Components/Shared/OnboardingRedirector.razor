@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Tenant
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http
@implements IDisposable

@code {
    private static readonly string[] AllowedPrefixes =
    [
    "onboarding",
"login",
"register",
"logout",
"upload",
"admin",
"api/",
"_blazor",
"_framework",
"_content",
"css",
"js",
"images",
"favicon",
"assets",
"dev"
    ];

    private static readonly TimeSpan CacheDuration = TimeSpan.FromSeconds(10);

    private DateTimeOffset _lastStatusCheck;
    private bool? _lastNeedsOnboarding;
    private bool _isRedirecting;
    private bool _disposed;

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += HandleLocationChanged;
        AuthStateProvider.AuthenticationStateChanged += HandleAuthStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsureRedirectAsync(Navigation.Uri);
        }
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs args)
    => _ = InvokeAsync(() => EnsureRedirectAsync(args.Location));

    private void HandleAuthStateChanged(Task<AuthenticationState> task)
    => _ = InvokeAsync(async () =>
    {
        try
        {
            await task;
        }
        catch
        {
            // ignore auth state exceptions
        }

        _lastStatusCheck = DateTimeOffset.MinValue;
        await EnsureRedirectAsync(Navigation.Uri);
    });

    private async Task EnsureRedirectAsync(string uri)
    {
        if (_disposed)
        {
            return;
        }

        if (!await ShouldInspectAsync(uri))
        {
            return;
        }

        var needsOnboarding = await NeedsOnboardingAsync();
        if (!needsOnboarding)
        {
            return;
        }

        var path = new Uri(uri).AbsolutePath;
        if (!path.StartsWith("/onboarding", StringComparison.OrdinalIgnoreCase) && !_isRedirecting)
        {
            _isRedirecting = true;
            Navigation.NavigateTo("/onboarding", forceLoad: true);
        }
        else if (path.StartsWith("/onboarding", StringComparison.OrdinalIgnoreCase))
        {
            _isRedirecting = false;
        }
    }

    private async Task<bool> ShouldInspectAsync(string uri)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated != true)
        {
            return false;
        }

        if (user.IsInRole("SuperAdmin"))
        {
            return false;
        }

        var path = new Uri(uri).AbsolutePath.TrimStart('/');

        foreach (var prefix in AllowedPrefixes)
        {
            if (path.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
            {
                return false;
            }
        }

        return true;
    }

    private async Task<bool> NeedsOnboardingAsync()
    {
        if (_lastNeedsOnboarding.HasValue &&
        DateTimeOffset.UtcNow - _lastStatusCheck < CacheDuration)
        {
            return _lastNeedsOnboarding.Value;
        }

        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            _lastNeedsOnboarding = false;
            _lastStatusCheck = DateTimeOffset.UtcNow;
            return false;
        }

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/onboarding/status"));
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);
            if (!response.IsSuccessStatusCode)
            {
                _lastNeedsOnboarding = false;
                _lastStatusCheck = DateTimeOffset.UtcNow;
                return false;
            }

            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantOnboardingStatusDto>>();
            if (payload?.Success != true || payload.Data is null)
            {
                _lastNeedsOnboarding = false;
                _lastStatusCheck = DateTimeOffset.UtcNow;
                return false;
            }

            var status = payload.Data;
            var needs = !(status.PlanConfirmed &&
            status.EncryptionConfigured &&
            status.PaymentAcknowledged &&
            status.HasMailbox);

            _lastNeedsOnboarding = needs;
            _lastStatusCheck = DateTimeOffset.UtcNow;
            return needs;
        }
        catch
        {
            _lastNeedsOnboarding = false;
            _lastStatusCheck = DateTimeOffset.UtcNow;
            return false;
        }
    }

    private Uri BuildApiUri(string relativePath)
    {
        var baseUri = new Uri(Navigation.BaseUri, UriKind.Absolute);
        return new Uri(baseUri, relativePath.TrimStart('/'));
    }

    public void Dispose()
    {
        if (_disposed)
        {
            return;
        }

        Navigation.LocationChanged -= HandleLocationChanged;
        AuthStateProvider.AuthenticationStateChanged -= HandleAuthStateChanged;
        _disposed = true;
        GC.SuppressFinalize(this);
    }
}
