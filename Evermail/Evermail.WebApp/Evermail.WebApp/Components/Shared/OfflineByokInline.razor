@using System.Globalization
@using System.Linq
@using System.Net.Http.Headers
@using System.Text.Json
@using Evermail.Common.DTOs.Tenant
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IAuthenticationStateService AuthStateService
@implements IAsyncDisposable

<div class="inline-byok card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <p class="hero-eyebrow text-uppercase mb-1">Offline BYOK lab</p>
                <h5 class="mb-1">Need a tenant key right now?</h5>
                <p class="text-muted mb-0">
                    Generate a wrapped DEK bundle entirely in your browser. The plaintext key never leaves your device.
                    (To enable BYOK for this tenant, we upload the wrapped bundle + passphrase once; the passphrase is not stored.)
                </p>
            </div>
            <span class="badge bg-warning text-dark text-uppercase">Prototype</span>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger py-2">
                @_errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(_statusMessage))
        {
            <div class="alert alert-success py-2">
                @_statusMessage
            </div>
        }

        @if (_isUploadingBundle)
        {
            <div class="d-flex align-items-center text-muted small mb-2">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Uploading offline key to Evermail…
            </div>
        }

        <form class="inline-byok__form" @onsubmit="PreventDefaultAsync">
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label">Workspace key label</label>
                    <input class="form-control" @bind="_form.TenantLabel" placeholder="Finance Vault" />
                    <div class="form-text">Used only in the bundle metadata.</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Passphrase</label>
                    <input class="form-control" type="password" @bind="_form.Passphrase" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Confirm</label>
                    <input class="form-control" type="password" @bind="_form.ConfirmPassphrase" />
                </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn btn-primary" type="button" disabled="@_isGenerating" @onclick="GenerateAsync">
                    @if (_isGenerating)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    Generate offline key
                </button>
                <button class="btn btn-outline-secondary" type="button" disabled="@(_bundle is null || _isGenerating || !_ackRecovery)"
                    @onclick="DownloadBundleAsync">
                    <i class="bi bi-download me-2"></i>Download bundle
                </button>
            </div>
        </form>

        @if (_bundle is not null)
        {
            <div class="inline-byok__result mt-3">
                <div class="alert alert-warning small mb-3">
                    <strong>Reminder:</strong> Store this recovery bundle offline. Evermail cannot recover it if you lose it.
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="ackInlineRecovery" @bind="_ackRecovery" />
                    <label class="form-check-label" for="ackInlineRecovery">
                        I understand Evermail cannot recover this bundle or passphrase.
                    </label>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Plaintext DEK (Base64)</label>
                    <div class="input-group">
                        <input class="form-control" readonly value="@(_ackRecovery ? _bundle.PlaintextDek : "••••••••••••••••")" />
                        <button class="btn btn-outline-secondary" type="button" disabled="@(!_ackRecovery)" @onclick="CopyPlaintextAsync">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Bundle preview (wrapped)</label>
                    @if (_ackRecovery)
                    {
                        <pre class="inline-byok__preview"><code>@_bundlePreview</code></pre>
                    }
                    else
                    {
                        <div class="alert alert-info small mb-0">Acknowledge the recovery warning to view/copy bundle material.</div>
                    }
                </div>
                <div class="mb-0">
                    <label class="form-label fw-semibold">Checksum</label>
                    <div class="input-group">
                        <input class="form-control" readonly value="@_bundle.Checksum" />
                        <button class="btn btn-outline-secondary" type="button" @onclick="CopyChecksumAsync">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
        }

        <div class="mt-4">
            <p class="hero-eyebrow text-uppercase mb-1">Recovery bundles</p>
            @if (_isLoadingBundles)
            {
                <div class="text-muted small">
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    Loading bundles…
                </div>
            }
            else if (_bundles.Count == 0)
            {
                <p class="text-muted small mb-0">No registered bundles yet. Generate a key to add it to the registry.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Label</th>
                                <th scope="col">Created</th>
                                <th scope="col">Last used</th>
                                <th scope="col" class="text-end"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bundle in _bundles)
                            {
                                <tr>
                                    <td>@bundle.Label</td>
                                    <td>@bundle.CreatedAt.ToLocalTime().ToString("g")</td>
                                    <td>@(bundle.LastUsedAt?.ToLocalTime().ToString("g") ?? "—")</td>
                                    <td class="text-end">
                                        <button class="btn btn-link btn-sm text-danger text-decoration-none" type="button"
                                            @onclick="() => DeleteBundleAsync(bundle.Id)">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private readonly OfflineByokForm _form = new();
    private bool _isGenerating;
    private bool _isUploadingBundle;
    private bool _ackRecovery;
    private string? _errorMessage;
    private string? _statusMessage;
    private OfflineByokBundle? _bundle;
    private string _bundlePreview = string.Empty;
    private IJSObjectReference? _module;
    private bool _isLoadingBundles;
    private List<TenantEncryptionBundleDto> _bundles = new();

    [Parameter]
    public EventCallback OnBundleUploaded { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadBundlesAsync();
    }

    private async Task EnsureModuleAsync()
    {
        _module ??= await JS.InvokeAsync<IJSObjectReference>("import", "./js/offlineByok.js");
    }

    private async Task LoadBundlesAsync()
    {
        _isLoadingBundles = true;
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrWhiteSpace(token))
            {
                _bundles.Clear();
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/encryption/bundles"));
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);
            if (!response.IsSuccessStatusCode)
            {
                return;
            }

            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<IReadOnlyList<TenantEncryptionBundleDto>>>();
            if (payload?.Success == true && payload.Data is not null)
            {
                _bundles = payload.Data.ToList();
            }
        }
        catch
        {
            // ignore, UI already shows fallback text
        }
        finally
        {
            _isLoadingBundles = false;
        }
    }

    private async Task GenerateAsync()
    {
        _errorMessage = null;
        _statusMessage = null;

        if (!_form.IsValid(out var validationError))
        {
            _errorMessage = validationError;
            return;
        }

        await EnsureModuleAsync();
        if (_module is null)
        {
            _errorMessage = "Offline crypto module failed to load. Refresh and try again.";
            return;
        }

        _isGenerating = true;
        try
        {
            var rawBundle = await _module.InvokeAsync<OfflineByokBundleResult>(
            "generateOfflineKeyBundle",
            _form.Passphrase,
            _form.TenantLabel?.Trim());

            _bundle = new OfflineByokBundle(
            rawBundle.version,
            rawBundle.tenantLabel,
            rawBundle.createdAt,
            rawBundle.plaintextDek,
            rawBundle.wrappedDek,
            rawBundle.salt,
            rawBundle.nonce,
            rawBundle.checksum);

            _bundlePreview = JsonSerializer.Serialize(_bundle with { PlaintextDek = "[hidden]" }, _jsonOptions);
            _statusMessage = "Key generated. Download the bundle and store the plaintext DEK securely.";

            await UploadBundleAsync();
        }
        catch (JSException jsEx)
        {
            _errorMessage = jsEx.Message;
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task DownloadBundleAsync()
    {
        if (_module is null || _bundle is null)
        {
            return;
        }

        var sanitizedTenant = SanitizeForFileName(_bundle.TenantLabel);
        var fileName = $"{sanitizedTenant}-{DateTime.UtcNow:yyyyMMdd-HHmmss}.evermail-key.json";
        var json = JsonSerializer.Serialize(_bundle, _jsonOptions);
        await _module.InvokeVoidAsync("downloadTextFile", fileName, json);
        _statusMessage = $"Bundle downloaded as {fileName}.";
    }

    private Task CopyPlaintextAsync() => CopyToClipboardAsync("Plaintext DEK", _bundle?.PlaintextDek);

    private Task CopyChecksumAsync() => CopyToClipboardAsync("Checksum", _bundle?.Checksum);

    private async Task CopyToClipboardAsync(string label, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", value);
            _statusMessage = $"{label} copied to clipboard.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to copy {label}: {ex.Message}";
        }
    }

    private static string SanitizeForFileName(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "evermail-offline-bundle";
        }

        var chars = value
        .ToLowerInvariant()
        .Select(ch => char.IsLetterOrDigit(ch) ? ch : '-')
        .ToArray();

        var slug = new string(chars).Trim('-');
        return string.IsNullOrWhiteSpace(slug) ? "evermail-offline-bundle" : slug;
    }

    private static Task PreventDefaultAsync() => Task.CompletedTask;

    private sealed class OfflineByokForm
    {
        public string? TenantLabel { get; set; } = string.Empty;
        public string Passphrase { get; set; } = string.Empty;
        public string ConfirmPassphrase { get; set; } = string.Empty;

        public bool IsValid(out string? error)
        {
            if (string.IsNullOrWhiteSpace(Passphrase) || Passphrase.Length < 12)
            {
                error = "Passphrase must be at least 12 characters.";
                return false;
            }

            if (!string.Equals(Passphrase, ConfirmPassphrase, StringComparison.Ordinal))
            {
                error = "Passphrases do not match.";
                return false;
            }

            error = null;
            return true;
        }
    }

    private sealed record OfflineByokBundleResult(
    string version,
    string tenantLabel,
    string createdAt,
    string plaintextDek,
    string wrappedDek,
    string salt,
    string nonce,
    string checksum);

    private sealed record OfflineByokBundle(
    string Version,
    string TenantLabel,
    string CreatedAt,
    string PlaintextDek,
    string WrappedDek,
    string Salt,
    string Nonce,
    string Checksum);

    private static readonly JsonSerializerOptions _jsonOptions = new()
    {
        WriteIndented = true
    };

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
    }

    private async Task UploadBundleAsync()
    {
        if (_bundle is null || string.IsNullOrWhiteSpace(_form.Passphrase))
        {
            return;
        }

        _isUploadingBundle = true;
        try
        {
            var response = await SendUploadRequestAsync(_bundle, _form.Passphrase);
            if (response?.Success != true)
            {
                _errorMessage = response?.Error ?? "Failed to upload offline bundle.";
                return;
            }

            _statusMessage = "Offline key uploaded. Refresh the status to confirm encryption is marked complete.";

            await RegisterBundleCopyAsync(_bundle);
            await LoadBundlesAsync();

            if (OnBundleUploaded.HasDelegate)
            {
                await OnBundleUploaded.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to upload offline bundle: {ex.Message}";
        }
        finally
        {
            _isUploadingBundle = false;
        }
    }

    private async Task<ApiResponse<TenantEncryptionSettingsDto>?> SendUploadRequestAsync(
    OfflineByokBundle bundle,
    string passphrase)
    {
        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            throw new InvalidOperationException("You must be signed in to upload a BYOK bundle.");
        }

        if (!DateTime.TryParse(
        bundle.CreatedAt,
        CultureInfo.InvariantCulture,
        DateTimeStyles.AdjustToUniversal | DateTimeStyles.AssumeUniversal,
        out var createdAt))
        {
            createdAt = DateTime.UtcNow;
        }

        var payload = new OfflineByokUploadRequest(
        bundle.Version,
        bundle.TenantLabel,
        createdAt,
        bundle.WrappedDek,
        bundle.Salt,
        bundle.Nonce,
        bundle.Checksum,
        passphrase);

        var request = new HttpRequestMessage(HttpMethod.Post, BuildApiUri("api/v1/tenants/encryption/offline"))
        {
            Content = JsonContent.Create(payload)
        };

        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await Http.SendAsync(request);
        var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<TenantEncryptionSettingsDto>>();

        if (!response.IsSuccessStatusCode)
        {
            throw new InvalidOperationException(apiResponse?.Error ?? $"Offline upload failed ({response.StatusCode}).");
        }

        return apiResponse;
    }

    private async Task RegisterBundleCopyAsync(OfflineByokBundle bundle)
    {
        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            return;
        }

        var request = new HttpRequestMessage(
        HttpMethod.Post,
        BuildApiUri("api/v1/tenants/encryption/bundles"))
        {
            Content = JsonContent.Create(new CreateTenantEncryptionBundleRequest(
        bundle.Version,
        bundle.TenantLabel,
        bundle.WrappedDek,
        bundle.Salt,
        bundle.Nonce,
        bundle.Checksum))
        };

        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
        await Http.SendAsync(request);
    }

    private async Task DeleteBundleAsync(Guid bundleId)
    {
        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            return;
        }

        var request = new HttpRequestMessage(
        HttpMethod.Delete,
        BuildApiUri($"api/v1/tenants/encryption/bundles/{bundleId}"));
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await Http.SendAsync(request);
        if (response.IsSuccessStatusCode)
        {
            _statusMessage = "Bundle removed.";
            await LoadBundlesAsync();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            _errorMessage = $"Failed to delete bundle: {error}";
        }
    }

    private Uri BuildApiUri(string relativePath)
    {
        relativePath = relativePath.TrimStart('/');
        return new Uri(new Uri(Navigation.BaseUri), relativePath);
    }
}
