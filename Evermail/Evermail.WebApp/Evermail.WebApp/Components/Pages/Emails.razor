@page "/emails"
@rendermode InteractiveServer
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Email
@using Evermail.Common.DTOs.Mailbox
@using System.Linq
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.WebApp.Services
@using System.Net.Http.Json
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.JSInterop
@implements IDisposable
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>My Emails - Evermail</PageTitle>

<AuthorizeView>
    <Authorized>
<div class="home-wrapper emails-wrapper">
    <section class="page-hero tight-hero">
        <div>
            <p class="hero-eyebrow mb-2">Search workspace</p>
            <h1>Find any email instantly</h1>
            <p class="text-muted mb-0">Search across every imported mailbox, with filters only a toggle away.</p>
        </div>
        <a href="/mailboxes" class="btn btn-outline-secondary detail-back">
            <i class="bi bi-inbox me-2"></i>View Mailboxes
        </a>
    </section>

    <section class="search-panel">
        <form class="search-form" @onsubmit="HandleSearch" @onsubmit:preventDefault="true">
            <div class="search-primary mb-3">
                <div class="search-field">
                    <label class="form-label fw-semibold">Search emails</label>
                    <input type="text"
                           class="form-control form-control-xl"
                           placeholder="@SampleQueryPlaceholder"
                           @bind="_searchQuery"
                           @bind:event="oninput" />
                </div>
                <div class="search-scope">
                    <label class="form-label fw-semibold">Scope</label>
                    <select class="form-select form-select-lg"
                            value="@(_selectedMailboxId?.ToString() ?? "")"
                            @onchange="OnMailboxSelectChanged">
                        <option value="">All mailboxes</option>
                        @if (_mailboxes != null)
                        {
                            @foreach (var mailbox in _mailboxes)
                            {
                                <option value="@mailbox.Id">@GetMailboxDisplayName(mailbox)</option>
                            }
                        }
                    </select>
                </div>
                <div class="search-action align-self-end">
                    <button type="submit" class="btn btn-primary btn-xl w-100">
                        <i class="bi bi-search me-2"></i>Search
                    </button>
                </div>
            </div>
            <div class="search-hints-row">
                <div class="search-hints">
                    <span class="hint">Use quotes for exact phrases</span>
                    <span class="hint">from:alice@example.com, subject:"invoice"</span>
                    <span class="hint">Combine filters with AND / OR</span>
                </div>

                <button type="button" class="advanced-filter-toggle d-inline-flex align-items-center" @onclick="ToggleAdvancedFilters">
                    <i class="@AdvancedToggleIconClass"></i>
                    <span>@AdvancedToggleLabel</span>
                </button>
            </div>

            @if (_showAdvancedFilters)
            {
                <div class="advanced-filters-panel">
                    <div class="advanced-grid">
                        <div class="filter-card">
                            <h4>Skip filler words</h4>
                            <p class="text-muted">Comma‑separate any noise words (e.g. “the,and,or”) you don’t want to match.</p>
                            <input type="text"
                                   class="form-control"
                                   placeholder="Comma-separated words to skip (e.g. the,and,or)"
                                   @bind="_stopWords" />
                            <div class="form-text">Helps trim noise for relevance scoring.</div>
                        </div>
                        <div class="filter-card">
                            <h4>Recipient filter</h4>
                            <p class="text-muted">Find messages sent to, cc’d, bcc’d, or replied to a specific contact.</p>
                            <input type="text"
                                   class="form-control"
                                   placeholder="alice@example.com"
                                   @bind="_recipientFilter" />
                            <div class="form-text">Matches email address or display name.</div>
                        </div>
                        <div class="filter-card">
                            <h4>Rank by signal</h4>
                            <p class="text-muted">Choose whether to prioritize semantic relevance or metadata such as date.</p>
                            <label class="form-label mb-1">Sort by</label>
                            <select class="form-select mb-3"
                                    value="@_sortBy"
                                    @onchange="OnSortByChanged">
                                <option value="rank">Relevance (recommended)</option>
                                <option value="date">Date</option>
                                <option value="subject">Subject</option>
                                <option value="from">Sender</option>
                            </select>
                            <label class="form-label mb-1">Order</label>
                            <select class="form-select"
                                    value="@_sortOrder"
                                    @onchange="OnSortOrderChanged">
                                <option value="desc">Newest first</option>
                                <option value="asc">Oldest first</option>
                            </select>
                        </div>
                        <div class="filter-card">
                            <h4>Match flexibility</h4>
                            <p class="text-muted">Toggle to include plural and verb variations (plan → planning → planned).</p>
                            <label class="form-label mb-1">Inflectional forms</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="inflectionalToggle"
                                       checked="@_useInflectionalForms"
                                       @onchange="OnInflectionalToggleChanged" />
                                <label class="form-check-label" for="inflectionalToggle">
                                    Match planning / planned / plan
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="filter-pills">
                    <span class="filter-pill">Sort: @GetSortLabel()</span>
                    <span class="filter-pill">Order: @( _sortOrder == "asc" ? "Oldest first" : "Newest first")</span>
                    <span class="filter-pill">@(_useInflectionalForms ? "Inflections ON" : "Exact terms")</span>
                    @if (!string.IsNullOrWhiteSpace(_stopWords))
                    {
                        <span class="filter-pill">Stop words: @_stopWords</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(_recipientFilter))
                    {
                        <span class="filter-pill">Recipient: @_recipientFilter</span>
                    }
                </div>
            }
        </form>
    </section>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading emails...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger modern-alert">
            <strong>Error:</strong> @_errorMessage
        </div>
    }
    else if (_emails == null || !_emails.Any())
    {
        <div class="card modern-card text-center py-5">
            <i class="bi bi-envelope display-1 text-muted"></i>
            <h3 class="mt-3">No Emails Found</h3>
            <p class="text-muted">
                @if (string.IsNullOrEmpty(_searchQuery))
                {
                    <text>Upload a mailbox to get started!</text>
                }
                else
                {
                    <text>No emails match your search criteria.</text>
                }
            </p>
            @if (string.IsNullOrEmpty(_searchQuery))
            {
                <a href="/upload" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> Upload Mailbox
                </a>
            }
        </div>
    }
    else
    {
        <section class="emails-results">
            <div class="search-summary">
                <div>
                    <p class="hero-eyebrow mb-1">Results</p>
                    <h3 class="mb-0">@(_searchQuery?.Length > 0 ? $"“{_searchQuery}”" : "All emails")</h3>
                </div>
                <div class="search-summary__chips">
                    @if (_selectedMailboxId.HasValue)
                    {
                        var mailboxLabel = _mailboxes?
                            .FirstOrDefault(m => m.Id == _selectedMailboxId);
                        <span class="filter-pill soft">@(
                            mailboxLabel is null
                                ? "Selected mailbox"
                                : GetMailboxDisplayName(mailboxLabel))</span>
                    }
                    <span class="filter-pill soft">@GetSortLabel()</span>
                    <span class="filter-pill soft">@(_useInflectionalForms ? "Inflections" : "Exact match")</span>
                </div>
            </div>

            <header class="emails-results__header">
                <div class="text-muted">
                    Showing @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, _totalCount)
                    of @_totalCount emails
                </div>
                @if (_queryTime.HasValue)
                {
                    <span class="text-muted small">Query time @_queryTime.Value.ToString("F3")s</span>
                }
            </header>

            <div class="email-list">
                @foreach (var email in _emails)
                {
                    var emailUrl = $"/emails/{email.Id}";
                    if (_selectedMailboxId.HasValue && _selectedMailboxId.Value != Guid.Empty)
                    {
                        emailUrl += $"?mailbox={_selectedMailboxId.Value}";
                    }
                    <a href="@emailUrl" class="email-row @(email.IsRead ? "" : "email-row--unread")">
                        <div class="email-row__meta">
                            <div>
                                <span class="email-row__from">
                                    @(!string.IsNullOrEmpty(email.FromName) ? email.FromName : email.FromAddress)
                                </span>
                                <span class="email-row__address">@email.FromAddress</span>
                                @if (email.HasAttachments)
                                {
                                    if (email.FirstAttachmentId.HasValue)
                                    {
                                        <button type="button"
                                                class="email-row__attachment-btn"
                                                title="@email.AttachmentCount attachment(s)"
                                                data-attachment-id="@email.FirstAttachmentId!.Value"
                                                @onclick="async () => await DownloadAttachment(email.FirstAttachmentId!.Value)"
                                                @onclick:preventDefault="true"
                                                @onclick:stopPropagation="true">
                                            <i class="bi bi-paperclip"></i>
                                            @if (email.AttachmentCount > 1)
                                            {
                                                <small>@email.AttachmentCount</small>
                                            }
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="email-row__attachment">
                                            <i class="bi bi-paperclip"></i>
                                            @if (email.AttachmentCount > 1)
                                            {
                                                <small>@email.AttachmentCount</small>
                                            }
                                        </span>
                                    }
                                }
                            </div>
                            <span class="email-row__date">@FormatDate(email.Date)</span>
                        </div>
                        <div class="email-row__subject">
                            <strong>@(email.Subject ?? "(No Subject)")</strong>
                            @if (email.Rank.HasValue)
                            {
                                <span class="badge bg-info text-dark ms-2">Rank @Math.Round(email.Rank.Value)</span>
                            }
                            @if (email.ConversationId.HasValue)
                            {
                                <span class="badge bg-secondary-subtle text-dark ms-2">
                                    Thread @(email.ThreadDepth + 1)/@Math.Max(email.ThreadSize, 1)
                                </span>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(email.Snippet))
                        {
                            <p class="email-row__snippet">@email.Snippet</p>
                        }
                    </a>
                }
            </div>

            @if (_totalPages > 1)
            {
                <div class="table-pagination emails-pagination">
                    <button class="btn btn-outline-secondary btn-sm"
                            disabled="@(_currentPage == 1)"
                            @onclick="async () =>
                            {
                                if (_currentPage > 1)
                                {
                                    _currentPage--;
                                    await UpdateUrl();
                                    await LoadEmails(_currentPage);
                                }
                            }">
                        Previous
                    </button>
                    <span>Page @_currentPage of @_totalPages</span>
                    <button class="btn btn-outline-secondary btn-sm"
                            disabled="@(_currentPage == _totalPages)"
                            @onclick="async () =>
                            {
                                if (_currentPage < _totalPages)
                                {
                                    _currentPage++;
                                    await UpdateUrl();
                                    await LoadEmails(_currentPage);
                                }
                            }">
                        Next
                    </button>
                </div>
            }
        </section>

        <section class="stat-grid secondary-grid">
            @foreach (var stat in _summaryCards)
            {
                <div class="stat-card compact">
                    <h3>@stat.Label</h3>
                    <div class="stat-value">@stat.Value</div>
                    @if (!string.IsNullOrEmpty(stat.Caption))
                    {
                        <p class="text-muted small mb-0">@stat.Caption</p>
                    }
                </div>
            }
        </section>
    }
</div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
    <Authorizing>
        <div class="container mt-5 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Verifying your credentials...</p>
        </div>
    </Authorizing>
</AuthorizeView>

@code {
    private List<EmailListItemDto>? _emails;
    private List<MailboxDto>? _mailboxes;
    private bool _isLoading = true;
    private string _errorMessage = "";
    private string _searchQuery = "";
    private Guid? _selectedMailboxId;
    private int _currentPage = 1;
    private int _pageSize = 50;
    private int _totalCount = 0;
    private int _totalPages = 1;
    private double? _queryTime;
    private string _stopWords = string.Empty;
    private bool _useInflectionalForms;
    private string _sortBy = "date";
    private string _sortOrder = "desc";
    private string _recipientFilter = string.Empty;
    private bool _showAdvancedFilters;
    private IReadOnlyList<EmailSummaryCard> _summaryCards = Array.Empty<EmailSummaryCard>();
    private const string SampleQueryPlaceholder = "Try \\\"invoice\\\" from:alice@example.com after:2023-01-01";

    protected override async Task OnInitializedAsync()
    {
        // Wait for client-side hydration before checking authentication
        // During SSR, localStorage isn't available, so we need to wait
        try
        {
            // Try to read token - if JSRuntime isn't available (SSR), this will throw
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                // No token - redirect to login
                Navigation.NavigateTo("/login?returnUrl=emails", forceLoad: true);
                return;
            }
        }
        catch (InvalidOperationException)
        {
            // SSR - wait for client-side hydration
            // The AuthorizeView will handle this
            return;
        }

        // Read URL parameters to preserve mailbox filter
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        var sortByFromQuery = false;
        
        if (queryParams.TryGetValue("mailbox", out var mailboxParam) && 
            Guid.TryParse(mailboxParam, out var mailboxId))
        {
            _selectedMailboxId = mailboxId;
        }
        
        if (queryParams.TryGetValue("q", out var searchParam))
        {
            _searchQuery = searchParam.ToString();
        }

        if (queryParams.TryGetValue("stopWords", out var stopWordsParam))
        {
            _stopWords = stopWordsParam.ToString();
        }

        if (queryParams.TryGetValue("recipient", out var recipientParam))
        {
            _recipientFilter = recipientParam.ToString();
        }

        if (queryParams.TryGetValue("useInflectionalForms", out var inflectionParam) &&
            bool.TryParse(inflectionParam, out var inflectionFlag))
        {
            _useInflectionalForms = inflectionFlag;
        }

        if (queryParams.TryGetValue("sortBy", out var sortByParam))
        {
            _sortBy = sortByParam.ToString();
            sortByFromQuery = true;
        }

        if (queryParams.TryGetValue("sortOrder", out var sortOrderParam))
        {
            _sortOrder = sortOrderParam.ToString();
        }
        
        if (queryParams.TryGetValue("page", out var pageParam) && 
            int.TryParse(pageParam, out var page))
        {
            _currentPage = page;
        }

        if (!sortByFromQuery && !string.IsNullOrWhiteSpace(_searchQuery))
        {
            _sortBy = "rank";
        }

        await LoadMailboxes();
        await LoadEmails(_currentPage);
    }

    private async Task LoadMailboxes()
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/mailboxes?pageSize=100";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<PagedMailboxesResponse>>();
                if (result?.Success == true && result.Data != null)
                {
                    _mailboxes = result.Data.Items.Where(m => m.Status == "Completed").ToList();
                    UpdateSummaryCards();
                }
            }
        }
        catch
        {
            // Silently fail - mailboxes filter is optional
        }
    }

    private async Task LoadEmails(int page = 1)
    {
        _isLoading = true;
        _currentPage = page;

        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in";
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/emails/search?page={page}&pageSize={_pageSize}";
            
            if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                url += $"&q={Uri.EscapeDataString(_searchQuery)}";
            }
            
            if (_selectedMailboxId.HasValue && _selectedMailboxId.Value != Guid.Empty)
            {
                url += $"&mailboxId={_selectedMailboxId.Value}";
            }

            var trimmedStopWords = _stopWords?.Trim();
            if (!string.IsNullOrWhiteSpace(trimmedStopWords))
            {
                url += $"&stopWords={Uri.EscapeDataString(trimmedStopWords)}";
            }

            if (_useInflectionalForms)
            {
                url += "&useInflectionalForms=true";
            }

            if (!string.IsNullOrWhiteSpace(_sortBy))
            {
                url += $"&sortBy={Uri.EscapeDataString(_sortBy)}";
            }

            if (!string.IsNullOrWhiteSpace(_sortOrder))
            {
                url += $"&sortOrder={Uri.EscapeDataString(_sortOrder)}";
            }

            if (!string.IsNullOrWhiteSpace(_recipientFilter))
            {
                url += $"&recipient={Uri.EscapeDataString(_recipientFilter)}";
            }

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<PagedEmailsResponse>>();
                if (result?.Success == true && result.Data != null)
                {
                    _emails = result.Data.Items;
                    _totalCount = result.Data.TotalCount;
                    _totalPages = (int)Math.Ceiling((double)_totalCount / _pageSize);
                    _queryTime = result.Data.QueryTime;
                    _errorMessage = "";
                    UpdateSummaryCards();
                    
                    // Set up event listeners for attachment buttons after emails are loaded
                    await JSRuntime.InvokeVoidAsync("attachmentDownload.setupAttachmentButtonListeners");
                }
            }
            else
            {
                _errorMessage = $"Failed to load emails: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnMailboxSelectChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrEmpty(value) || !Guid.TryParse(value, out var mailboxId))
        {
            _selectedMailboxId = null;
        }
        else
        {
            _selectedMailboxId = mailboxId;
        }
        _currentPage = 1;
        await UpdateUrl();
        await LoadEmails(1);
    }

    private async Task OnSortByChanged(ChangeEventArgs e)
    {
        var selectedValue = e.Value?.ToString();
        _sortBy = string.IsNullOrWhiteSpace(selectedValue)
            ? (string.IsNullOrWhiteSpace(_searchQuery) ? "date" : "rank")
            : selectedValue!;
        await HandleSearch();
    }

    private async Task OnSortOrderChanged(ChangeEventArgs e)
    {
        var selectedValue = e.Value?.ToString();
        _sortOrder = string.IsNullOrWhiteSpace(selectedValue) ? "desc" : selectedValue!;
        await HandleSearch();
    }

    private async Task OnInflectionalToggleChanged(ChangeEventArgs e)
    {
        if (e.Value is bool boolValue)
        {
            _useInflectionalForms = boolValue;
        }
        else
        {
            var valueString = e.Value?.ToString();
            _useInflectionalForms = bool.TryParse(valueString, out var flag) && flag;
        }
        await HandleSearch();
    }

    private async Task HandleSearch()
    {
        _currentPage = 1;
        await UpdateUrl();
        await LoadEmails(1);
    }

    private void ToggleAdvancedFilters()
    {
        _showAdvancedFilters = !_showAdvancedFilters;
    }

    private async Task UpdateUrl()
    {
        var queryParams = new Dictionary<string, string?>();
        
        if (_selectedMailboxId.HasValue && _selectedMailboxId.Value != Guid.Empty)
        {
            queryParams["mailbox"] = _selectedMailboxId.Value.ToString();
        }
        
        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            queryParams["q"] = _searchQuery;
        }

        var trimmedStopWords = _stopWords?.Trim();
        if (!string.IsNullOrWhiteSpace(trimmedStopWords))
        {
            queryParams["stopWords"] = trimmedStopWords;
        }

        if (!string.IsNullOrWhiteSpace(_recipientFilter))
        {
            queryParams["recipient"] = _recipientFilter;
        }

        if (_useInflectionalForms)
        {
            queryParams["useInflectionalForms"] = "true";
        }

        if (!string.IsNullOrWhiteSpace(_sortBy))
        {
            queryParams["sortBy"] = _sortBy;
        }

        if (!string.IsNullOrWhiteSpace(_sortOrder))
        {
            queryParams["sortOrder"] = _sortOrder;
        }
        
        if (_currentPage > 1)
        {
            queryParams["page"] = _currentPage.ToString();
        }

        var baseUri = Navigation.ToAbsoluteUri("/emails").GetLeftPart(UriPartial.Path);
        var filteredParams = queryParams.Where(kvp => kvp.Value != null)
            .ToDictionary(kvp => kvp.Key, kvp => (string?)kvp.Value!) as IDictionary<string, string?>;
        var queryString = QueryHelpers.AddQueryString("", filteredParams ?? new Dictionary<string, string?>());
        
        Navigation.NavigateTo($"{baseUri}{queryString}", replace: true);
    }

    private string AdvancedToggleIconClass => _showAdvancedFilters ? "bi bi-dash-circle" : "bi bi-sliders";
    private string AdvancedToggleLabel => _showAdvancedFilters ? "Hide advanced filters" : "Advanced filters";

    private string GetSortLabel() => _sortBy switch
    {
        "rank" => "Relevance",
        "date" => "Date",
        "subject" => "Subject",
        "from" => "Sender",
        _ => _sortBy
    };

    private static string GetMailboxDisplayName(MailboxDto mailbox) =>
        string.IsNullOrWhiteSpace(mailbox.DisplayName) ? mailbox.FileName : mailbox.DisplayName;


    private async Task DownloadAttachment(Guid attachmentId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                await AuthStateService.RefreshTokenIfNeededAsync();
                token = await AuthStateService.GetTokenAsync();
            }

            if (string.IsNullOrEmpty(token))
            {
                // Show error or redirect to login
                return;
            }

            var attachmentUrl = $"{Navigation.BaseUri}api/v1/attachments/{attachmentId}/download";
            await JSRuntime.InvokeVoidAsync("attachmentDownload.download", attachmentUrl, token);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading attachment: {ex.Message}");
        }
    }

    private string FormatDate(DateTime date)
    {
        var now = DateTime.UtcNow;
        var diff = now - date;

        if (diff.TotalDays < 1)
        {
            return date.ToString("HH:mm");
        }
        else if (diff.TotalDays < 7)
        {
            return date.ToString("ddd HH:mm");
        }
        else if (diff.TotalDays < 365)
        {
            return date.ToString("MMM d");
        }
        else
        {
            return date.ToString("MMM d, yyyy");
        }
    }

    private void UpdateSummaryCards()
    {
        _summaryCards = new[]
        {
            new EmailSummaryCard("Results", FormatNumber(_totalCount), _selectedMailboxId.HasValue ? "Filtered mailbox" : "All mailboxes"),
            new EmailSummaryCard("Page Size", _pageSize.ToString("N0"), $"{_currentPage} / {_totalPages} pages"),
            new EmailSummaryCard("Search Speed", _queryTime.HasValue ? $"{_queryTime.Value:F3}s" : "—", _useInflectionalForms ? "Inflections enabled" : "Exact terms")
        };
    }

    private static string FormatNumber(long value)
    {
        if (value >= 1_000_000)
        {
            return $"{value / 1_000_000d:0.#}M";
        }

        if (value >= 1_000)
        {
            return $"{value / 1_000d:0.#}K";
        }

        return value.ToString("N0");
    }

    public void Dispose()
    {
        // Cleanup if needed
    }

    private record EmailSummaryCard(string Label, string Value, string? Caption);
}
