@page "/emails"
@rendermode InteractiveServer
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Email
@using Evermail.Common.DTOs.Mailbox
@using Evermail.Common.DTOs.User
@using Evermail.WebApp.Models
@using System.Linq
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.WebApp.Services
@using System.Net.Http.Json
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.JSInterop
@implements IDisposable
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject UserPreferencesService PreferencesService
@inject IDateFormatService DateFormatService

<PageTitle>My Emails - Evermail</PageTitle>

<AuthorizeView>
    <Authorized>
<div class="home-wrapper emails-wrapper" tabindex="0" @onkeydown="HandleKeyDown">
    <section class="page-hero tight-hero">
        <div>
            <p class="hero-eyebrow mb-2">Search workspace</p>
            <h1>Find any email instantly</h1>
            <p class="text-muted mb-0">Search across every imported mailbox, with filters only a toggle away.</p>
        </div>
        <a href="/mailboxes" class="btn btn-outline-secondary detail-back">
            <i class="bi bi-inbox me-2"></i>View Mailboxes
        </a>
    </section>

    <section class="search-panel">
        <form class="search-form" @onsubmit="HandleSearch" @onsubmit:preventDefault="true">
            <div class="search-primary mb-3">
                <div class="search-field search-field--with-icons">
                    <input type="text"
                           class="form-control form-control-xl"
                           placeholder="Search emails or use filters like from:alice AND invoice"
                           @bind="_searchQuery"
                           @bind:event="oninput"
                           @ref="_searchInputRef" />
                    <div class="search-field__icons">
                        <button type="button"
                                class="icon-button icon-button--ghost"
                                title="Date range"
                                @onclick="ToggleDatePicker">
                            <i class="bi bi-calendar3"></i>
                        </button>
                        <button type="button"
                                class="icon-button icon-button--ghost"
                                title="Advanced filters"
                                @onclick="ToggleAdvancedFilters">
                            <i class="bi bi-sliders2"></i>
                        </button>
                    </div>
                </div>
                <div class="search-actions">
                    <div class="sort-toggle">
                        <button type="button"
                                class="@GetSortModeClass(SortMode.Relevance)"
                                @onclick="async () => await SetSortModeAsync(SortMode.Relevance)">
                            <i class="bi bi-activity me-1"></i>Relevance
                        </button>
                        <button type="button"
                                class="@GetSortModeClass(SortMode.Newest)"
                                @onclick="async () => await SetSortModeAsync(SortMode.Newest)">
                            <i class="bi bi-arrow-down me-1"></i>Newest
                        </button>
                        <button type="button"
                                class="@GetSortModeClass(SortMode.Oldest)"
                                @onclick="async () => await SetSortModeAsync(SortMode.Oldest)">
                            <i class="bi bi-arrow-up me-1"></i>Oldest
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-xl search-button">
                        <i class="bi bi-search me-2"></i>Search
                    </button>
                </div>
                @if (_showDatePicker)
                {
                    <div class="date-popover">
                        <div class="date-popover__header">
                            <span>Date range</span>
                            <button type="button" class="icon-button icon-button--ghost" @onclick="ToggleDatePicker">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="date-popover__body">
                            <label class="form-label fw-semibold">From</label>
                            <InputDate @bind-Value="_dateFrom"
                                       class="form-control"
                                       placeholder="dd/mm/yyyy" />
                            <label class="form-label fw-semibold mt-3">To</label>
                            <InputDate @bind-Value="_dateTo"
                                       class="form-control"
                                       placeholder="dd/mm/yyyy" />
                            <div class="d-flex gap-2 mt-3">
                                <button type="button" class="btn btn-outline-secondary flex-fill" @onclick="ClearDateRange">Clear</button>
                                <button type="button" class="btn btn-primary flex-fill" @onclick="ApplyDateRangeAsync">Apply</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="search-meta mb-2">
                <div class="search-meta__left">
                    <button type="button"
                            class="scope-pill"
                            @onclick="ToggleScopeSelector">
                        <i class="bi bi-collection me-1"></i>@GetScopeLabel()
                    </button>
                    @if (_showScopeSelector)
                    {
                        <div class="scope-dropdown">
                            <label class="form-label fw-semibold">Mailbox scope</label>
                            <select class="form-select"
                                    value="@(_selectedMailboxId?.ToString() ?? "")"
                                    @onchange="OnMailboxSelectChanged">
                                <option value="">All mailboxes</option>
                                @if (_mailboxes != null)
                                {
                                    @foreach (var mailbox in _mailboxes)
                                    {
                                        <option value="@mailbox.Id">@GetMailboxDisplayName(mailbox)</option>
                                    }
                                }
                            </select>
                        </div>
                    }
                </div>
            </div>
            <div class="search-hints-row">
                <div class="search-hints">
                    <span class="hint">Use quotes for exact phrases</span>
                    <span class="hint">from:alice@example.com, subject:"invoice"</span>
                    <span class="hint">Combine filters with AND / OR</span>
                </div>
            </div>

            @if (_showAdvancedFilters)
            {
                <div class="advanced-filters-panel">
                    <section class="advanced-section">
                        <div class="advanced-section__header">
                            <h4>Keywords & matching</h4>
                            <p>Fine-tune how we interpret your search terms.</p>
                        </div>
                        <div class="advanced-section__grid">
                            <div class="filter-field filter-field--full">
                                <label class="filter-field__label" for="stopWordsInput">Skip filler words</label>
                                <p class="filter-field__hint">Comma-separate any noise words (e.g. “the,and,or”) you don’t want to match.</p>
                                <input id="stopWordsInput"
                                       type="text"
                                       class="form-control"
                                       placeholder="Comma-separated words to skip"
                                       @bind="_stopWords" />
                                <div class="form-text">Helps trim noise for relevance scoring.</div>
                            </div>
                            <div class="filter-field">
                                <label class="filter-field__label" for="inflectionalToggle">Match flexibility</label>
                                <p class="filter-field__hint">Toggle to include plural and verb variations (plan → planning → planned).</p>
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="inflectionalToggle"
                                           checked="@_useInflectionalForms"
                                           @onchange="OnInflectionalToggleChanged" />
                                    <label class="form-check-label" for="inflectionalToggle">
                                        Match planning / planned / plan
                                    </label>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="advanced-section">
                        <div class="advanced-section__header">
                            <h4>Participants</h4>
                            <p>Focus on messages from specific people or teams.</p>
                        </div>
                        <div class="advanced-section__grid">
                            <div class="filter-field">
                                <label class="filter-field__label" for="recipientFilterInput">Recipient filter</label>
                                <p class="filter-field__hint">Find messages sent to, cc’d, bcc’d, or replied to a specific contact.</p>
                                <input id="recipientFilterInput"
                                       type="text"
                                       class="form-control"
                                       placeholder="alice@example.com"
                                       @bind="_recipientFilter" />
                                <div class="form-text">Matches email address or display name.</div>
                            </div>
                            <div class="filter-field">
                                <label class="filter-field__label" for="senderFilterInput">Sender filter</label>
                                <p class="filter-field__hint">Limit results to a specific sender name or address.</p>
                                <input id="senderFilterInput"
                                       type="text"
                                       class="form-control"
                                       placeholder="billing@company.com"
                                       @bind="_fromFilter" />
                            </div>
                            <div class="filter-field">
                                <label class="filter-field__label" for="advancedScopeSelect">Mailbox scope</label>
                                <p class="filter-field__hint">Restrict searches to a specific archive.</p>
                                <select id="advancedScopeSelect"
                                        class="form-select"
                                        value="@(_selectedMailboxId?.ToString() ?? "")"
                                        @onchange="OnMailboxSelectChanged">
                                    <option value="">All mailboxes</option>
                                    @if (_mailboxes != null)
                                    {
                                        @foreach (var mailbox in _mailboxes)
                                        {
                                            <option value="@mailbox.Id">@GetMailboxDisplayName(mailbox)</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </section>

                    <section class="advanced-section">
                        <div class="advanced-section__header">
                            <h4>Date range & attachments</h4>
                            <p>Keep queries scoped to the timeframe—and file types—that matter.</p>
                        </div>
                        <div class="advanced-section__grid">
                            <div class="filter-field">
                                <label class="filter-field__label" for="dateFromInput">From</label>
                                <InputDate @bind-Value="_dateFrom"
                                           class="form-control"
                                           id="dateFromInput"
                                           placeholder="dd/mm/yyyy" />
                            </div>
                            <div class="filter-field">
                                <label class="filter-field__label" for="dateToInput">To</label>
                                <InputDate @bind-Value="_dateTo"
                                           class="form-control"
                                           id="dateToInput"
                                           placeholder="dd/mm/yyyy" />
                            </div>
                            <div class="filter-field filter-field--full">
                                <label class="filter-field__label" for="attachmentsOnlyToggle">Attachments</label>
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="attachmentsOnlyToggle"
                                           @bind="_hasAttachmentsOnly" />
                                    <label class="form-check-label" for="attachmentsOnlyToggle">
                                        Only show emails with attachments
                                    </label>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            }
            else
            {
                <div class="filter-pills">
                    <span class="filter-pill">Sort: @GetSortLabel()</span>
                    <span class="filter-pill">Order: @( _sortOrder == "asc" ? "Oldest first" : "Newest first")</span>
                    <span class="filter-pill">@(_useInflectionalForms ? "Inflections ON" : "Exact terms")</span>
                    @if (!string.IsNullOrWhiteSpace(_stopWords))
                    {
                        <span class="filter-pill">Stop words: @_stopWords</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(_recipientFilter))
                    {
                        <span class="filter-pill">Recipient: @_recipientFilter</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(_fromFilter))
                    {
                        <span class="filter-pill">From: @_fromFilter</span>
                    }
                    @if (_dateFrom.HasValue || _dateTo.HasValue)
                    {
                        <span class="filter-pill">Date: @FormatDateRange()</span>
                    }
                    @if (_hasAttachmentsOnly)
                    {
                        <span class="filter-pill">Has attachments</span>
                    }
                </div>
            }
        </form>
    </section>

    @if (_isSuperAdmin)
    {
        if (!_fullTextHealthy)
        {
            <div class="alert alert-warning modern-alert mt-3">
                <strong>Full-text search is offline.</strong>
                Queries are using the slower LIKE fallback. Check <code>/api/v1/dev/fulltext-status</code> to re-enable once SQL is ready.
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_searchQuery) && !_usedFullTextSearch)
        {
            <div class="alert alert-info modern-alert mt-3">
                <strong>FTS fallback for this query.</strong>
                The catalog is healthy, but this search was handled by the basic filter (usually because the terms were all stop words).
            </div>
        }
    }

    @if (_isLoading)
    {
        <section class="emails-results emails-results--loading">
            <div class="loading-summary">
                <div class="skeleton-line skeleton-line--long"></div>
                <div class="skeleton-chip-row">
                    <span class="skeleton-chip"></span>
                    <span class="skeleton-chip skeleton-chip--sm"></span>
                    <span class="skeleton-chip skeleton-chip--sm"></span>
                </div>
            </div>
            <div class="email-list email-list--skeleton">
                @foreach (var _ in Enumerable.Range(0, 4))
                {
                    <div class="email-card email-card--skeleton">
                        <div class="skeleton-line skeleton-line--wide"></div>
                        <div class="skeleton-line skeleton-line--medium"></div>
                        <div class="skeleton-chip-row">
                            <span class="skeleton-chip"></span>
                            <span class="skeleton-chip skeleton-chip--sm"></span>
                        </div>
                        <div class="skeleton-line skeleton-line--short"></div>
                    </div>
                }
            </div>
        </section>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger modern-alert">
            <strong>Error:</strong> @_errorMessage
        </div>
    }
    else if (_emails == null || !_emails.Any())
    {
        <div class="card modern-card text-center py-5">
            <i class="bi bi-envelope display-1 text-muted"></i>
            <h3 class="mt-3">No Emails Found</h3>
            <p class="text-muted">
                @if (string.IsNullOrEmpty(_searchQuery))
                {
                    <text>Upload a mailbox to get started!</text>
                }
                else
                {
                    <text>No emails match your search criteria.</text>
                }
            </p>
            @if (string.IsNullOrEmpty(_searchQuery))
            {
                <a href="/upload" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> Upload Mailbox
                </a>
            }
        </div>
    }
    else
    {
        <section class="emails-results">
            <div class="search-summary">
                <div>
                    <p class="hero-eyebrow mb-1">Results</p>
                    <h3 class="mb-0">@(_searchQuery?.Length > 0 ? $"“{_searchQuery}”" : "All emails")</h3>
                </div>
                <div class="search-summary__chips">
                    @if (_selectedMailboxId.HasValue)
                    {
                        var mailboxLabel = _mailboxes?
                            .FirstOrDefault(m => m.Id == _selectedMailboxId);
                        <span class="filter-pill soft">@(
                            mailboxLabel is null
                                ? "Selected mailbox"
                                : GetMailboxDisplayName(mailboxLabel))</span>
                    }
                    <span class="filter-pill soft">@GetSortLabel()</span>
                    <span class="filter-pill soft">@(_useInflectionalForms ? "Inflections" : "Exact match")</span>
                </div>
            </div>

            <header class="emails-results__header">
                <div class="text-muted">
                    Showing @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, _totalCount)
                    of @_totalCount emails
                </div>
                @if (_queryTime.HasValue)
                {
                    <span class="text-muted small">Query time @_queryTime.Value.ToString("F3")s</span>
                }
                <div class="density-toggle ms-auto">
                    <button type="button"
                            class="btn btn-sm @( _preferences.ResultDensity == ResultDensityPreference.Cozy ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="async () => await ChangeDensity(ResultDensityPreference.Cozy)">
                        Cozy
                    </button>
                    <button type="button"
                            class="btn btn-sm @( _preferences.ResultDensity == ResultDensityPreference.Compact ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="async () => await ChangeDensity(ResultDensityPreference.Compact)">
                        Compact
                    </button>
                </div>
            </header>

            <section class="saved-filters-panel">
                <div class="saved-filters__header">
                    <div>
                        <p class="hero-eyebrow mb-1">Saved filters</p>
                        <h3 class="mb-0">Reuse frequent searches</h3>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @onclick="OpenSaveFilterModal">
                            <i class="bi bi-plus-circle me-1"></i>Save current filters
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @onclick="LoadSavedFiltersAsync">
                            <i class="bi bi-arrow-repeat me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                @if (_isLoadingSavedFilters)
                {
                    <p class="text-muted mb-0">Loading saved filters…</p>
                }
                else if (_savedFilters.Count == 0)
                {
                    <p class="text-muted mb-0">No saved filters yet. Capture your favorite combinations for one-click reuse.</p>
                }
                else
                {
                    <div class="saved-filters__chips">
                        @foreach (var filter in _savedFilters)
                        {
                            var isActive = filter.Id == _activeSavedFilterId;
                            <button type="button"
                                    class="saved-filter-chip @(isActive ? "saved-filter-chip--active" : string.Empty)"
                                    @onclick="async () => await ApplySavedFilterAsync(filter)">
                                @if (filter.IsFavorite)
                                {
                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                }
                                <span>@filter.Name</span>
                                <button type="button"
                                        class="saved-filter-chip__delete"
                                        title="Delete filter"
                                        @onclick="async () => await DeleteFilterAsync(filter.Id)"
                                        @onclick:preventDefault="true"
                                        @onclick:stopPropagation="true">
                                    <i class="bi bi-x"></i>
                                </button>
                            </button>
                        }
                    </div>
                }
            </section>

            @if (_pinnedThreadSummaries.Count > 0)
            {
                <section class="pinned-threads-panel">
                    <div class="pinned-threads-header">
                        <div>
                            <p class="hero-eyebrow mb-1">Pinned</p>
                            <h3 class="mb-0">Priority threads</h3>
                        </div>
                        <span class="text-muted small">@_pinnedThreadSummaries.Count thread@(_pinnedThreadSummaries.Count == 1 ? string.Empty : "s")</span>
                    </div>
                    <div class="pinned-threads-stack">
                        @foreach (var summary in _pinnedThreadSummaries)
                        {
                            <div class="pinned-thread-card" @onclick="async () => await OpenPinnedSummaryAsync(summary)">
                                <div class="pinned-thread-card__stack">
                                    <span class="stack-indicator @(summary.HasMultipleMessages ? "stack-indicator--multi" : string.Empty)">
                                        <i class="bi bi-layers"></i>
                                        @if (summary.HasMultipleMessages)
                                        {
                                            <span>@summary.MessageCount</span>
                                        }
                                    </span>
                                </div>
                                <div class="pinned-thread-card__body">
                                    <div class="pinned-thread-card__title">@summary.Subject</div>
                                    <div class="pinned-thread-card__meta">
                                        <span>@summary.FromLabel</span>
                                        <span class="mx-1">•</span>
                                        <span>@FormatDate(summary.LastActivity)</span>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(summary.Snippet))
                                    {
                                        <p class="pinned-thread-card__snippet">@summary.Snippet</p>
                                    }
                                </div>
                                <div class="pinned-thread-card__actions">
                                    <button type="button"
                                            class="icon-button"
                                            title="Unpin"
                                            @onclick="async () => await UnpinFromSummaryAsync(summary)"
                                            @onclick:stopPropagation="true">
                                        <i class="bi bi-pin-angle-fill"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            }

            <div class="email-list">
                <Virtualize Items="_orderedEmails" Context="email" ItemSize="140">
                    @{
                        var rowIndex = GetRowIndex(email);
                        var detailQuery = BuildDetailQueryParameters();
                        var emailUrl = detailQuery.Count > 0
                            ? QueryHelpers.AddQueryString($"/emails/{email.Id}", detailQuery)
                            : $"/emails/{email.Id}";
                        var isActive = rowIndex == _activeRowIndex;
                    }
                    <a @key="email.Id"
                       href="@emailUrl"
                       class="email-card @GetDensityClass() @(isActive ? "email-card--active" : string.Empty) @(email.IsRead ? "" : "email-card--unread")"
                       data-email-id="@email.Id">
                        <div class="email-card__header">
                            <div>
                                <div class="email-card__subject-line">
                                    <strong>@(email.Subject ?? "(No Subject)")</strong>
                                    @if (email.ConversationId.HasValue)
                                    {
                                        <span class="badge bg-secondary-subtle text-dark ms-2">
                                            Thread @(email.ThreadDepth + 1)/@Math.Max(email.ThreadSize, 1)
                                        </span>
                                    }
                                </div>
                                @if (email.MatchFields is { Count: > 0 })
                                {
                                    <div class="email-card__signals">
                                        <div class="match-strength @GetMatchStrengthClass(email.Rank)">
                                            <span></span>
                                            <span></span>
                                            <span></span>
                                        </div>
                                        @foreach (var match in email.MatchFields)
                                        {
                                            <span class="match-chip">@GetMatchLabel(match)</span>
                                        }
                                    </div>
                                }
                            </div>
                            <div class="email-card__meta">
                                <span>@FormatDate(email.Date)</span>
                                <div class="email-card__actions">
                                    <button type="button"
                                            class="icon-button"
                                            title="Preview"
                                            @onclick="async () => await OpenPreviewAsync(email)"
                                            @onclick:preventDefault="true">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a class="icon-button"
                                       href="@emailUrl"
                                       title="Open details">
                                        <i class="bi bi-arrow-up-right"></i>
                                    </a>
                                    <button type="button"
                                            class="icon-button"
                                            title="@(email.IsPinned ? "Unpin" : "Pin")"
                                            @onclick="async () => await TogglePinAsync(email)"
                                            @onclick:preventDefault="true">
                                        <i class="bi @(email.IsPinned ? "bi-pin-angle-fill" : "bi-pin")"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="email-card__from-line">
                            <span class="email-card__from-name">
                                @(!string.IsNullOrEmpty(email.FromName) ? email.FromName : email.FromAddress)
                            </span>
                            <span class="email-card__address">@email.FromAddress</span>
                            @if (email.MatchSources?.Count > 0)
                            {
                                <span class="match-summary">Matched in @string.Join(", ", email.MatchSources)</span>
                            }
                        </div>
                        @if (email.HasAttachments && email.AttachmentPreviews is { Count: > 0 })
                        {
                            <div class="attachment-pill-row">
                                @foreach (var attachment in email.AttachmentPreviews)
                                {
                                    <button type="button"
                                            class="attachment-pill"
                                            title="@attachment.FileName"
                                            @onclick="async () => await DownloadAttachment(attachment.Id)"
                                            @onclick:preventDefault="true">
                                        <i class="bi bi-paperclip me-1"></i>
                                        <span>@attachment.FileName</span>
                                    </button>
                                }
                                @if (email.AttachmentCount > email.AttachmentPreviews.Count)
                                {
                                    <span class="attachment-pill attachment-pill--more">+@(email.AttachmentCount - email.AttachmentPreviews.Count)</span>
                                }
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(email.HighlightedSnippet))
                        {
                            <p class="email-card__snippet">@((MarkupString)email.HighlightedSnippet)</p>
                        }
                        else if (!string.IsNullOrEmpty(email.Snippet))
                        {
                            <p class="email-card__snippet">@email.Snippet</p>
                        }
                    </a>
                </Virtualize>
            </div>

            @if (_totalPages > 1)
            {
                <div class="table-pagination emails-pagination">
                    <button class="btn btn-outline-secondary btn-sm"
                            disabled="@(_currentPage == 1)"
                            @onclick="async () =>
                            {
                                if (_currentPage > 1)
                                {
                                    _currentPage--;
                                    await UpdateUrl();
                                    await LoadEmails(_currentPage);
                                }
                            }">
                        Previous
                    </button>
                    <span>Page @_currentPage of @_totalPages</span>
                    <button class="btn btn-outline-secondary btn-sm"
                            disabled="@(_currentPage == _totalPages)"
                            @onclick="async () =>
                            {
                                if (_currentPage < _totalPages)
                                {
                                    _currentPage++;
                                    await UpdateUrl();
                                    await LoadEmails(_currentPage);
                                }
                            }">
                        Next
                    </button>
                </div>
            }
        </section>

        <section class="stat-grid secondary-grid">
            @foreach (var stat in _summaryCards)
            {
                <div class="stat-card compact">
                    <h3>@stat.Label</h3>
                    <div class="stat-value">@stat.Value</div>
                    @if (!string.IsNullOrEmpty(stat.Caption))
                    {
                        <p class="text-muted small mb-0">@stat.Caption</p>
                    }
                </div>
            }
        </section>

        @if (_showSaveFilterModal)
        {
            <div class="modal fade show detail-modal d-block" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content glass-panel">
                        <div class="modal-header">
                            <div>
                                <p class="hero-eyebrow mb-1">Save current filter</p>
                                <h4 class="mb-0">Make this combination reusable</h4>
                            </div>
                            <button type="button" class="btn-close" @onclick="CloseSaveFilterModal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label fw-semibold">Filter name</label>
                            <input class="form-control"
                                   maxlength="128"
                                   placeholder="e.g. From Alice last 30 days"
                                   @bind="_newFilterName" />
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="favoriteFilterToggle"
                                       @bind="_newFilterFavorite" />
                                <label class="form-check-label" for="favoriteFilterToggle">
                                    Mark as favorite
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer justify-content-between">
                            <button class="btn btn-outline-secondary" @onclick="CloseSaveFilterModal">Cancel</button>
                            <button class="btn btn-primary"
                                    disabled="@string.IsNullOrWhiteSpace(_newFilterName)"
                                    @onclick="SaveCurrentFiltersAsync">
                                <i class="bi bi-check2 me-1"></i>Save filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }

        @if (_showPreviewModal && _previewEmail is not null)
        {
            <div class="modal fade show detail-modal d-block" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content glass-panel">
                        <div class="modal-header">
                            <div>
                                <p class="hero-eyebrow mb-1">Quick preview</p>
                                <h4 class="mb-0">@(_previewEmail.Subject ?? "(No Subject)")</h4>
                                <small class="text-muted">@FormatDate(_previewEmail.Date)</small>
                            </div>
                            <button type="button" class="btn-close" @onclick="ClosePreview"></button>
                        </div>
                        <div class="modal-body">
                            <div class="preview-snippet">
                                @((MarkupString)(_previewEmail.HighlightedSnippet ?? _previewEmail.Snippet ?? "No snippet available"))
                            </div>
                        </div>
                        <div class="modal-footer justify-content-between">
                            <span class="text-muted small">@_previewEmail.FromAddress</span>
                            <a class="btn btn-primary"
                               href="@QueryHelpers.AddQueryString($"/emails/{_previewEmail.Id}", BuildDetailQueryParameters())"
                               @onclick="ClosePreview">
                                Open full email
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }
    }
</div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
    <Authorizing>
        <div class="container mt-5 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Verifying your credentials...</p>
        </div>
    </Authorizing>
</AuthorizeView>

@code {
    private List<EmailListItemDto>? _emails;
    private List<MailboxDto>? _mailboxes;
    private bool _isLoading = true;
    private string _errorMessage = "";
    private string _searchQuery = "";
    private Guid? _selectedMailboxId;
    private int _currentPage = 1;
    private int _pageSize = 50;
    private int _totalCount = 0;
    private int _totalPages = 1;
    private double? _queryTime;
    private string _stopWords = string.Empty;
    private bool _useInflectionalForms;
    private string _sortBy = "date";
    private string _sortOrder = "desc";
    private string _recipientFilter = string.Empty;
    private bool _showAdvancedFilters;
    private IReadOnlyList<EmailSummaryCard> _summaryCards = Array.Empty<EmailSummaryCard>();
    private bool _usedFullTextSearch;
    private bool _fullTextHealthy = true;
    private bool _isSuperAdmin;
    private const string SampleQueryPlaceholder = "Try \\\"invoice\\\" from:alice@example.com after:2023-01-01";
    private UserPreferences _preferences = UserPreferences.CreateDefault();
    private string _fromFilter = string.Empty;
    private DateTime? _dateFrom;
    private DateTime? _dateTo;
    private bool _hasAttachmentsOnly;
    private List<SavedSearchFilterDto> _savedFilters = new();
    private bool _isLoadingSavedFilters;
    private bool _showSaveFilterModal;
    private string _newFilterName = string.Empty;
    private bool _newFilterFavorite;
    private Guid? _activeSavedFilterId;
    private ElementReference _searchInputRef;
    private readonly List<EmailListItemDto> _orderedEmails = new();
    private readonly List<PinnedEmailSummaryDto> _pinnedThreadSummaries = new();
    private int _activeRowIndex = -1;
    private bool _showPreviewModal;
    private EmailListItemDto? _previewEmail;
    private bool _showScopeSelector;
    private bool _showDatePicker;
    private SortMode _sortMode = SortMode.Relevance;

    private enum SortMode
    {
        Relevance,
        Newest,
        Oldest
    }

    protected override async Task OnInitializedAsync()
    {
        // Wait for client-side hydration before checking authentication
        // During SSR, localStorage isn't available, so we need to wait
        try
        {
            // Try to read token - if JSRuntime isn't available (SSR), this will throw
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                // No token - redirect to login
                Navigation.NavigateTo("/login?returnUrl=emails", forceLoad: true);
                return;
            }
        }
        catch (InvalidOperationException)
        {
            // SSR - wait for client-side hydration
            // The AuthorizeView will handle this
            return;
        }

        var principal = await AuthStateService.GetUserFromTokenAsync();
        _isSuperAdmin = principal?.IsInRole("SuperAdmin") ?? false;

        // Read URL parameters to preserve mailbox filter
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        var sortByFromQuery = false;
        
        if (queryParams.TryGetValue("mailbox", out var mailboxParam) && 
            Guid.TryParse(mailboxParam, out var mailboxId))
        {
            _selectedMailboxId = mailboxId;
        }
        
        if (queryParams.TryGetValue("q", out var searchParam))
        {
            _searchQuery = searchParam.ToString();
        }

        if (queryParams.TryGetValue("stopWords", out var stopWordsParam))
        {
            _stopWords = stopWordsParam.ToString();
        }

        if (queryParams.TryGetValue("recipient", out var recipientParam))
        {
            _recipientFilter = recipientParam.ToString();
        }

        if (queryParams.TryGetValue("useInflectionalForms", out var inflectionParam) &&
            bool.TryParse(inflectionParam, out var inflectionFlag))
        {
            _useInflectionalForms = inflectionFlag;
        }

        if (queryParams.TryGetValue("sortBy", out var sortByParam))
        {
            _sortBy = sortByParam.ToString();
            sortByFromQuery = true;
        }

        if (queryParams.TryGetValue("sortOrder", out var sortOrderParam))
        {
            _sortOrder = sortOrderParam.ToString();
        }
        
        if (queryParams.TryGetValue("page", out var pageParam) && 
            int.TryParse(pageParam, out var page))
        {
            _currentPage = page;
        }

        if (!sortByFromQuery && !string.IsNullOrWhiteSpace(_searchQuery))
        {
            _sortBy = "rank";
        }

        SyncSortModeFromState();

        await LoadPreferencesAsync();
        await LoadMailboxes();
        await LoadEmails(_currentPage);
        await LoadSavedFiltersAsync();
    }

    private async Task LoadMailboxes()
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/mailboxes?pageSize=100";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<PagedMailboxesResponse>>();
                if (result?.Success == true && result.Data != null)
                {
                    _mailboxes = result.Data.Items.Where(m => m.Status == "Completed").ToList();
                    UpdateSummaryCards();
                }
            }
        }
        catch
        {
            // Silently fail - mailboxes filter is optional
        }
    }

    private async Task LoadPreferencesAsync()
    {
        try
        {
            _preferences = await PreferencesService.GetPreferencesAsync();
        }
        catch
        {
            _preferences = UserPreferences.CreateDefault();
        }
    }

    private async Task LoadSavedFiltersAsync()
    {
        _isLoadingSavedFilters = true;
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/emails/saved-filters";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var payload = await response.Content.ReadFromJsonAsync<ApiResponse<List<SavedSearchFilterDto>>>();
                if (payload?.Success == true && payload.Data is not null)
                {
                    _savedFilters = payload.Data;
                }
            }
        }
        finally
        {
            _isLoadingSavedFilters = false;
        }
    }

    private void OpenSaveFilterModal()
    {
        _newFilterName = string.IsNullOrWhiteSpace(_searchQuery) ? "New filter" : _searchQuery;
        _newFilterFavorite = false;
        _showSaveFilterModal = true;
    }

    private void CloseSaveFilterModal()
    {
        _showSaveFilterModal = false;
        _newFilterName = string.Empty;
        _newFilterFavorite = false;
    }

    private SavedSearchFilterDefinitionDto BuildDefinitionFromState() =>
        new(
            string.IsNullOrWhiteSpace(_searchQuery) ? null : _searchQuery,
            _selectedMailboxId,
            string.IsNullOrWhiteSpace(_fromFilter) ? null : _fromFilter,
            _dateFrom,
            _dateTo,
            _hasAttachmentsOnly ? true : null,
            string.IsNullOrWhiteSpace(_recipientFilter) ? null : _recipientFilter,
            null);

    private async Task SaveCurrentFiltersAsync()
    {
        if (string.IsNullOrWhiteSpace(_newFilterName))
        {
            return;
        }

        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var request = new HttpRequestMessage(
                HttpMethod.Post,
                $"{Navigation.BaseUri}api/v1/emails/saved-filters");

            request.Headers.Add("Authorization", $"Bearer {token}");
            var payload = new CreateSavedSearchFilterRequest(
                _newFilterName.Trim(),
                BuildDefinitionFromState(),
                OrderIndex: null,
                IsFavorite: _newFilterFavorite);
            request.Content = JsonContent.Create(payload);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                await LoadSavedFiltersAsync();
                CloseSaveFilterModal();
            }
        }
        catch
        {
            // Ignore errors for now
        }
    }

    private async Task ApplySavedFilterAsync(SavedSearchFilterDto filter)
    {
        var definition = filter.Definition;
        _searchQuery = definition.Query ?? string.Empty;
        _selectedMailboxId = definition.MailboxId;
        _fromFilter = definition.From ?? string.Empty;
        _dateFrom = definition.DateFrom;
        _dateTo = definition.DateTo;
        _hasAttachmentsOnly = definition.HasAttachments ?? false;
        _recipientFilter = definition.Recipient ?? string.Empty;
        _activeSavedFilterId = filter.Id;
        await HandleSearch();
    }

    private async Task DeleteFilterAsync(Guid filterId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var request = new HttpRequestMessage(
                HttpMethod.Delete,
                $"{Navigation.BaseUri}api/v1/emails/saved-filters/{filterId}");
            request.Headers.Add("Authorization", $"Bearer {token}");
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                _savedFilters.RemoveAll(f => f.Id == filterId);
                if (_activeSavedFilterId == filterId)
                {
                    _activeSavedFilterId = null;
                }
            }
        }
        catch
        {
            // Ignore errors during delete
        }
    }

    private async Task LoadEmails(int page = 1)
    {
        _isLoading = true;
        _currentPage = page;
        _usedFullTextSearch = false;
        _fullTextHealthy = true;

        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in";
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/emails/search?page={page}&pageSize={_pageSize}";
            
            if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                url += $"&q={Uri.EscapeDataString(_searchQuery)}";
            }
            
            if (_selectedMailboxId.HasValue && _selectedMailboxId.Value != Guid.Empty)
            {
                url += $"&mailboxId={_selectedMailboxId.Value}";
            }

            var trimmedStopWords = _stopWords?.Trim();
            if (!string.IsNullOrWhiteSpace(trimmedStopWords))
            {
                url += $"&stopWords={Uri.EscapeDataString(trimmedStopWords)}";
            }

            if (_useInflectionalForms)
            {
                url += "&useInflectionalForms=true";
            }

            if (!string.IsNullOrWhiteSpace(_sortBy))
            {
                url += $"&sortBy={Uri.EscapeDataString(_sortBy)}";
            }

            if (!string.IsNullOrWhiteSpace(_sortOrder))
            {
                url += $"&sortOrder={Uri.EscapeDataString(_sortOrder)}";
            }

            if (!string.IsNullOrWhiteSpace(_recipientFilter))
            {
                url += $"&recipient={Uri.EscapeDataString(_recipientFilter)}";
            }

            if (!string.IsNullOrWhiteSpace(_fromFilter))
            {
                url += $"&from={Uri.EscapeDataString(_fromFilter)}";
            }

            if (_dateFrom.HasValue)
            {
                url += $"&dateFrom={_dateFrom.Value:yyyy-MM-dd}";
            }

            if (_dateTo.HasValue)
            {
                url += $"&dateTo={_dateTo.Value:yyyy-MM-dd}";
            }

            if (_hasAttachmentsOnly)
            {
                url += "&hasAttachments=true";
            }

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<PagedEmailsResponse>>();
                if (result?.Success == true && result.Data != null)
                {
                    _emails = result.Data.Items;
                    _totalCount = result.Data.TotalCount;
                    _totalPages = (int)Math.Ceiling((double)_totalCount / _pageSize);
                    _queryTime = result.Data.QueryTime;
                    _usedFullTextSearch = result.Data.UsedFullTextSearch;
                    _fullTextHealthy = result.Data.FullTextHealthy;
                    _errorMessage = "";
                    _orderedEmails.Clear();
                    _orderedEmails.AddRange(_emails.Where(e => !e.IsPinned));
                    _activeRowIndex = -1;
                    UpdateSummaryCards();
                    await LoadPinnedSummariesAsync();
                    
                    // Set up event listeners for attachment buttons after emails are loaded
                    await JSRuntime.InvokeVoidAsync("attachmentDownload.setupAttachmentButtonListeners");
                }
            }
            else
            {
                _errorMessage = $"Failed to load emails: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadPinnedSummariesAsync()
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                _pinnedThreadSummaries.Clear();
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, $"{Navigation.BaseUri}api/v1/emails/pinned");
            request.Headers.Add("Authorization", $"Bearer {token}");
            var response = await Http.SendAsync(request);
            if (!response.IsSuccessStatusCode)
            {
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<ApiResponse<List<PinnedEmailSummaryDto>>>();
            _pinnedThreadSummaries.Clear();
            if (result?.Success == true && result.Data is not null)
            {
                _pinnedThreadSummaries.AddRange(result.Data);
            }
        }
        catch
        {
            // Ignore failures fetching pinned summaries
        }
    }

    private async Task OnMailboxSelectChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrEmpty(value) || !Guid.TryParse(value, out var mailboxId))
        {
            _selectedMailboxId = null;
        }
        else
        {
            _selectedMailboxId = mailboxId;
        }
        _currentPage = 1;
        _showScopeSelector = false;
        await UpdateUrl();
        await LoadEmails(1);
    }


    private async Task OnInflectionalToggleChanged(ChangeEventArgs e)
    {
        if (e.Value is bool boolValue)
        {
            _useInflectionalForms = boolValue;
        }
        else
        {
            var valueString = e.Value?.ToString();
            _useInflectionalForms = bool.TryParse(valueString, out var flag) && flag;
        }
        await HandleSearch();
    }

    private async Task HandleSearch()
    {
        _currentPage = 1;
        _showScopeSelector = false;
        _showDatePicker = false;

        if (_sortMode == SortMode.Relevance)
        {
            _sortBy = string.IsNullOrWhiteSpace(_searchQuery) ? "date" : "rank";
            _sortOrder = "desc";
        }

        await UpdateUrl();
        await LoadEmails(1);
    }

    private void ToggleAdvancedFilters()
    {
        _showAdvancedFilters = !_showAdvancedFilters;
        if (_showAdvancedFilters)
        {
            _showScopeSelector = false;
            _showDatePicker = false;
        }
    }

    private async Task UpdateUrl()
    {
        var queryParams = new Dictionary<string, string?>();
        
        if (_selectedMailboxId.HasValue && _selectedMailboxId.Value != Guid.Empty)
        {
            queryParams["mailbox"] = _selectedMailboxId.Value.ToString();
        }
        
        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            queryParams["q"] = _searchQuery;
        }

        var trimmedStopWords = _stopWords?.Trim();
        if (!string.IsNullOrWhiteSpace(trimmedStopWords))
        {
            queryParams["stopWords"] = trimmedStopWords;
        }

        if (!string.IsNullOrWhiteSpace(_recipientFilter))
        {
            queryParams["recipient"] = _recipientFilter;
        }

        if (_useInflectionalForms)
        {
            queryParams["useInflectionalForms"] = "true";
        }

        if (!string.IsNullOrWhiteSpace(_sortBy))
        {
            queryParams["sortBy"] = _sortBy;
        }

        if (!string.IsNullOrWhiteSpace(_sortOrder))
        {
            queryParams["sortOrder"] = _sortOrder;
        }
        
        if (_currentPage > 1)
        {
            queryParams["page"] = _currentPage.ToString();
        }

        var baseUri = Navigation.ToAbsoluteUri("/emails").GetLeftPart(UriPartial.Path);
        var filteredParams = queryParams.Where(kvp => kvp.Value != null)
            .ToDictionary(kvp => kvp.Key, kvp => (string?)kvp.Value!) as IDictionary<string, string?>;
        var queryString = QueryHelpers.AddQueryString("", filteredParams ?? new Dictionary<string, string?>());
        
        Navigation.NavigateTo($"{baseUri}{queryString}", replace: true);
    }

    private Dictionary<string, string?> BuildDetailQueryParameters()
    {
        var parameters = new Dictionary<string, string?>();

        if (_selectedMailboxId.HasValue && _selectedMailboxId.Value != Guid.Empty)
        {
            parameters["mailbox"] = _selectedMailboxId.Value.ToString();
        }

        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            parameters["q"] = _searchQuery;
        }

        var trimmedStopWords = _stopWords?.Trim();
        if (!string.IsNullOrWhiteSpace(trimmedStopWords))
        {
            parameters["stopWords"] = trimmedStopWords;
        }

        if (_useInflectionalForms)
        {
            parameters["useInflectionalForms"] = "true";
        }

        if (!string.IsNullOrWhiteSpace(_recipientFilter))
        {
            parameters["recipient"] = _recipientFilter;
        }

        if (!string.IsNullOrWhiteSpace(_fromFilter))
        {
            parameters["from"] = _fromFilter;
        }

        if (_dateFrom.HasValue)
        {
            parameters["dateFrom"] = _dateFrom.Value.ToString("yyyy-MM-dd");
        }

        if (_dateTo.HasValue)
        {
            parameters["dateTo"] = _dateTo.Value.ToString("yyyy-MM-dd");
        }

        if (_hasAttachmentsOnly)
        {
            parameters["hasAttachments"] = "true";
        }

        return parameters;
    }

    private string GetSortLabel() => _sortMode switch
    {
        SortMode.Relevance => "Relevance",
        SortMode.Newest => "Newest first",
        SortMode.Oldest => "Oldest first",
        _ => "Relevance"
    };

    private string GetScopeLabel()
    {
        if (!_selectedMailboxId.HasValue || _mailboxes is null)
        {
            return "All mailboxes";
        }

        var mailbox = _mailboxes.FirstOrDefault(m => m.Id == _selectedMailboxId);
        return mailbox is null ? "Selected mailbox" : GetMailboxDisplayName(mailbox);
    }

    private string GetSortModeClass(SortMode mode) =>
        mode == _sortMode ? "sort-toggle__btn sort-toggle__btn--active" : "sort-toggle__btn";

    private async Task SetSortModeAsync(SortMode mode)
    {
        if (_sortMode == mode)
        {
            return;
        }

        _sortMode = mode;

        switch (mode)
        {
            case SortMode.Relevance:
                _sortBy = string.IsNullOrWhiteSpace(_searchQuery) ? "date" : "rank";
                _sortOrder = "desc";
                break;
            case SortMode.Newest:
                _sortBy = "date";
                _sortOrder = "desc";
                break;
            case SortMode.Oldest:
                _sortBy = "date";
                _sortOrder = "asc";
                break;
        }

        await HandleSearch();
    }

    private void ToggleScopeSelector()
    {
        _showScopeSelector = !_showScopeSelector;
        if (_showScopeSelector)
        {
            _showDatePicker = false;
        }
    }

    private void ToggleDatePicker()
    {
        _showDatePicker = !_showDatePicker;
        if (_showDatePicker)
        {
            _showScopeSelector = false;
        }
    }

    private async Task ApplyDateRangeAsync()
    {
        _showDatePicker = false;
        await HandleSearch();
    }

    private void ClearDateRange()
    {
        _dateFrom = null;
        _dateTo = null;
    }

    private void SyncSortModeFromState()
    {
        if (_sortBy.Equals("rank", StringComparison.OrdinalIgnoreCase))
        {
            _sortMode = SortMode.Relevance;
            _sortOrder = "desc";
            return;
        }

        if (_sortBy.Equals("date", StringComparison.OrdinalIgnoreCase))
        {
            _sortMode = _sortOrder.Equals("asc", StringComparison.OrdinalIgnoreCase)
                ? SortMode.Oldest
                : SortMode.Newest;
            return;
        }

        _sortMode = SortMode.Relevance;
        _sortOrder = "desc";
    }

    private static string GetMatchLabel(string field) => field switch
    {
        "Subject" => "Subject match",
        "Body" => "Body match",
        "Sender" => "Sender match",
        "Recipients" => "Recipient match",
        _ => field
    };

    private static string GetMailboxDisplayName(MailboxDto mailbox) =>
        string.IsNullOrWhiteSpace(mailbox.DisplayName) ? mailbox.FileName : mailbox.DisplayName;


    private async Task DownloadAttachment(Guid attachmentId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                await AuthStateService.RefreshTokenIfNeededAsync();
                token = await AuthStateService.GetTokenAsync();
            }

            if (string.IsNullOrEmpty(token))
            {
                // Show error or redirect to login
                return;
            }

            var attachmentUrl = $"{Navigation.BaseUri}api/v1/attachments/{attachmentId}/download";
            await JSRuntime.InvokeVoidAsync("attachmentDownload.download", attachmentUrl, token);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading attachment: {ex.Message}");
        }
    }

    private void UpdateSummaryCards()
    {
        var cards = new List<EmailSummaryCard>
        {
            new("Results", FormatNumber(_totalCount), _selectedMailboxId.HasValue ? "Filtered mailbox" : "All mailboxes"),
            new("Page Size", _pageSize.ToString("N0"), $"{_currentPage} / {_totalPages} pages"),
            new("Search Speed", _queryTime.HasValue ? $"{_queryTime.Value:F3}s" : "—", _useInflectionalForms ? "Inflections enabled" : "Exact terms")
        };

        if (_isSuperAdmin)
        {
            var statusLabel = _fullTextHealthy ? "Healthy" : "Fallback";
            var caption = !_fullTextHealthy
                ? "LIKE fallback (dev › fulltext-status)"
                : (_usedFullTextSearch
                    ? "CONTAINSTABLE used"
                    : "This query used LIKE fallback");
            cards.Add(new EmailSummaryCard("Full-Text", statusLabel, caption));
        }

        _summaryCards = cards;
    }

    private string FormatDate(DateTime date) =>
        DateFormatService.Format(date, _preferences.DateFormat);

    private string FormatDateRange()
    {
        if (_dateFrom.HasValue && _dateTo.HasValue)
        {
            return $"{FormatDate(_dateFrom.Value)} → {FormatDate(_dateTo.Value)}";
        }

        if (_dateFrom.HasValue)
        {
            return $"After {FormatDate(_dateFrom.Value)}";
        }

        if (_dateTo.HasValue)
        {
            return $"Before {FormatDate(_dateTo.Value)}";
        }

        return "Custom";
    }

    private string GetDensityClass() =>
        _preferences.ResultDensity == ResultDensityPreference.Compact ? "email-card--compact" : "email-card--cozy";

    private string GetMatchStrengthClass(double? rank)
    {
        if (rank is null)
        {
            return "match-strength--unknown";
        }

        return rank switch
        {
            >= 800 => "match-strength--high",
            >= 400 => "match-strength--medium",
            _ => "match-strength--low"
        };
    }

    private int GetRowIndex(EmailListItemDto email)
    {
        var index = _orderedEmails.FindIndex(e => e.Id == email.Id);
        return index < 0 ? 0 : index;
    }

    private static string FormatNumber(long value)
    {
        if (value >= 1_000_000)
        {
            return $"{value / 1_000_000d:0.#}M";
        }

        if (value >= 1_000)
        {
            return $"{value / 1_000d:0.#}K";
        }

        return value.ToString("N0");
    }

    private async Task OpenPreviewAsync(EmailListItemDto email)
    {
        _previewEmail = email;
        _showPreviewModal = true;
        await Task.CompletedTask;
    }

    private void ClosePreview()
    {
        _showPreviewModal = false;
        _previewEmail = null;
    }

    private async Task TogglePinAsync(EmailListItemDto email)
    {
        if (email.IsPinned)
        {
            await UnpinEmailAsync(email.Id);
        }
        else
        {
            await PinEmailAsync(email.Id);
        }
    }

    private async Task PinEmailAsync(Guid emailId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Post, $"{Navigation.BaseUri}api/v1/emails/{emailId}/pin");
            request.Headers.Add("Authorization", $"Bearer {token}");
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                await LoadEmails(_currentPage);
            }
        }
        catch
        {
            // Ignore pin failures for now
        }
    }

    private async Task UnpinEmailAsync(Guid emailId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Delete, $"{Navigation.BaseUri}api/v1/emails/{emailId}/pin");
            request.Headers.Add("Authorization", $"Bearer {token}");
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                await LoadEmails(_currentPage);
            }
        }
        catch
        {
            // Ignore failures
        }
    }

    private async Task UnpinFromSummaryAsync(PinnedEmailSummaryDto summary)
    {
        await UnpinEmailAsync(summary.EmailId);
    }

    private async Task OpenPinnedSummaryAsync(PinnedEmailSummaryDto summary)
    {
        var detailQuery = BuildDetailQueryParameters();
        var emailUrl = detailQuery.Count > 0
            ? QueryHelpers.AddQueryString($"/emails/{summary.EmailId}", detailQuery)
            : $"/emails/{summary.EmailId}";
        Navigation.NavigateTo(emailUrl);
        await Task.CompletedTask;
    }

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        if (!_preferences.KeyboardShortcutsEnabled)
        {
            return;
        }

        if (_orderedEmails.Count == 0)
        {
            return;
        }

        switch (args.Key)
        {
            case "/":
                await _searchInputRef.FocusAsync();
                break;
            case "j":
                MoveActiveRow(1);
                break;
            case "k":
                MoveActiveRow(-1);
                break;
            case "Enter":
                OpenActiveEmail();
                break;
            case "p":
                await PinActiveEmailAsync();
                break;
        }
    }

    private void MoveActiveRow(int delta)
    {
        if (_orderedEmails.Count == 0)
        {
            _activeRowIndex = -1;
            return;
        }

        _activeRowIndex = Math.Clamp(
            _activeRowIndex < 0 ? 0 : _activeRowIndex + delta,
            0,
            _orderedEmails.Count - 1);
        StateHasChanged();
    }

    private void OpenActiveEmail()
    {
        if (_activeRowIndex < 0 || _activeRowIndex >= _orderedEmails.Count)
        {
            return;
        }

        var email = _orderedEmails[_activeRowIndex];
        var detailQuery = BuildDetailQueryParameters();
        var emailUrl = detailQuery.Count > 0
            ? QueryHelpers.AddQueryString($"/emails/{email.Id}", detailQuery)
            : $"/emails/{email.Id}";
        Navigation.NavigateTo(emailUrl);
    }

    private async Task PinActiveEmailAsync()
    {
        if (_activeRowIndex < 0 || _activeRowIndex >= _orderedEmails.Count)
        {
            return;
        }

        await TogglePinAsync(_orderedEmails[_activeRowIndex]);
    }

    private async Task ChangeDensity(ResultDensityPreference preference)
    {
        if (_preferences.ResultDensity == preference)
        {
            return;
        }

        _preferences = await PreferencesService.SetResultDensityAsync(preference);
        StateHasChanged();
    }

    public void Dispose()
    {
        // Cleanup if needed
    }

    private record EmailSummaryCard(string Label, string Value, string? Caption);
}
