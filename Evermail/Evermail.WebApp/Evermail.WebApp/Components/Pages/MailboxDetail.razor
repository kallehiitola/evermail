@page "/mailboxes/{Id:guid}"
@rendermode InteractiveServer
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Mailbox
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.WebApp.Services
@using System.Net.Http.Json
@implements IDisposable
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService

<PageTitle>Mailbox Details - Evermail</PageTitle>

<AuthorizeView>
    <Authorized>
<div class="container mt-4">
    <div class="mb-3">
        <a href="/mailboxes" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Mailboxes
        </a>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading mailbox details...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @_errorMessage
        </div>
    }
    else if (_mailbox == null)
    {
        <div class="alert alert-warning">
            <h4>Mailbox Not Found</h4>
            <p>The mailbox you're looking for doesn't exist or you don't have permission to access it.</p>
            <a href="/mailboxes" class="btn btn-primary">Back to Mailboxes</a>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">@_mailbox.FileName</h3>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Status</h5>
                        <p>
                            @GetStatusBadge(_mailbox.Status)
                            @if (_mailbox.Status == "Processing")
                            {
                                <span class="ms-2">
                                    <i class="bi bi-arrow-repeat spin"></i> Processing...
                                </span>
                            }
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h5>File Size</h5>
                        <p>@FormatFileSize(_mailbox.FileSizeBytes)</p>
                    </div>
                </div>

                @if (_mailbox.Status == "Processing")
                {
                    <div class="mb-4">
                        <h5>Processing Progress</h5>
                        @{
                            int progress;
                            string progressText;
                            
                            if (_mailbox.TotalEmails > 0)
                            {
                                // Use email count if we know the total
                                progress = (int)((double)_mailbox.ProcessedEmails / _mailbox.TotalEmails * 100);
                                progressText = $"Processed {_mailbox.ProcessedEmails} of {_mailbox.TotalEmails} emails";
                            }
                            else if (_mailbox.FileSizeBytes > 0 && _mailbox.ProcessedBytes > 0)
                            {
                                // Use file size for progress when total emails unknown
                                progress = (int)((double)_mailbox.ProcessedBytes / _mailbox.FileSizeBytes * 100);
                                var processedMB = _mailbox.ProcessedBytes / (1024.0 * 1024.0);
                                var totalMB = _mailbox.FileSizeBytes / (1024.0 * 1024.0);
                                progressText = $"Processed {processedMB:F2} MB of {totalMB:F2} MB ({_mailbox.ProcessedEmails} emails)";
                            }
                            else
                            {
                                progress = 0;
                                progressText = "Starting...";
                            }
                        }
                        
                        <div class="progress mb-2" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @progress%"
                                 aria-valuenow="@progress" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                @progress%
                            </div>
                        </div>
                        <p class="text-muted">
                            @progressText
                            @if (_mailbox.FailedEmails > 0)
                            {
                                <span class="text-danger">(@_mailbox.FailedEmails failed)</span>
                            }
                        </p>
                    </div>
                }

                <div class="row">
                    <div class="col-md-6">
                        <h5>Statistics</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>Total Emails:</strong></td>
                                    <td>@(_mailbox.TotalEmails > 0 ? _mailbox.TotalEmails.ToString() : "-")</td>
                                </tr>
                                <tr>
                                    <td><strong>Processed:</strong></td>
                                    <td>@(_mailbox.ProcessedEmails > 0 ? _mailbox.ProcessedEmails.ToString() : "-")</td>
                                </tr>
                                @if (_mailbox.FailedEmails > 0)
                                {
                                    <tr>
                                        <td><strong>Failed:</strong></td>
                                        <td class="text-danger">@_mailbox.FailedEmails</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Timeline</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>Uploaded:</strong></td>
                                    <td>@_mailbox.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss UTC")</td>
                                </tr>
                                @if (_mailbox.ProcessingStartedAt.HasValue)
                                {
                                    <tr>
                                        <td><strong>Processing Started:</strong></td>
                                        <td>@_mailbox.ProcessingStartedAt.Value.ToString("yyyy-MM-dd HH:mm:ss UTC")</td>
                                    </tr>
                                }
                                @if (_mailbox.ProcessingCompletedAt.HasValue)
                                {
                                    <tr>
                                        <td><strong>Completed:</strong></td>
                                        <td>@_mailbox.ProcessingCompletedAt.Value.ToString("yyyy-MM-dd HH:mm:ss UTC")</td>
                                    </tr>
                                    @if (_mailbox.ProcessingStartedAt.HasValue)
                                    {
                                        var duration = _mailbox.ProcessingCompletedAt.Value - _mailbox.ProcessingStartedAt.Value;
                                        <tr>
                                            <td><strong>Duration:</strong></td>
                                            <td>@FormatDuration(duration)</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(_mailbox.ErrorMessage))
                {
                    <div class="alert alert-danger mt-4">
                        <h5>Error Details</h5>
                        <p class="mb-0">@_mailbox.ErrorMessage</p>
                    </div>
                }

                @if (_mailbox.Status == "Completed")
                {
                    <div class="mt-4">
                        <a href="/emails?mailboxId=@_mailbox.Id" class="btn btn-primary">
                            <i class="bi bi-envelope"></i> View Emails
                        </a>
                    </div>
                }
            </div>
        </div>
    }
</div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public Guid Id { get; set; }

    private MailboxDto? _mailbox;
    private bool _isLoading = true;
    private string _errorMessage = "";
    private System.Threading.Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadMailbox();
        
        // Auto-refresh every 3 seconds if processing
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (_mailbox?.Status == "Processing")
            {
                await InvokeAsync(async () =>
                {
                    await LoadMailbox(silent: true);
                    StateHasChanged();
                });
            }
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private async Task LoadMailbox(bool silent = false)
    {
        if (!silent)
        {
            _isLoading = true;
        }

        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in";
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/mailboxes/{Id}";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<MailboxDto>>();
                if (result?.Success == true && result.Data != null)
                {
                    _mailbox = result.Data;
                    _errorMessage = "";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                _mailbox = null;
                _errorMessage = "";
            }
            else
            {
                _errorMessage = $"Failed to load mailbox: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return $"{(int)duration.TotalHours}h {duration.Minutes}m {duration.Seconds}s";
        }
        else if (duration.TotalMinutes >= 1)
        {
            return $"{duration.Minutes}m {duration.Seconds}s";
        }
        else
        {
            return $"{duration.Seconds}s";
        }
    }

    private RenderFragment GetStatusBadge(string status) => status switch
    {
        "Pending" => @<span class="badge bg-secondary">Pending</span>,
        "Processing" => @<span class="badge bg-info">Processing</span>,
        "Completed" => @<span class="badge bg-success">Completed</span>,
        "Failed" => @<span class="badge bg-danger">Failed</span>,
        _ => @<span class="badge bg-secondary">@status</span>
    };

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}

