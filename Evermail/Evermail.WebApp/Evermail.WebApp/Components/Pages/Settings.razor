@page "/settings"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.WebApp.Models
@using Evermail.WebApp.Services

@inject UserPreferencesService PreferencesService

<PageTitle>Settings - Evermail</PageTitle>

<AuthorizeView>
    <Authorized Context="context">
        <div class="home-wrapper settings-wrapper">
            <section class="page-hero">
                <div>
                    <p class="hero-eyebrow mb-2">Your workspace</p>
                    <h1>Account & Preferences</h1>
                    <p class="text-muted mb-0">Manage your identity, subscriptions, and upcoming security controls from one calm dashboard.</p>
                </div>
                <div class="settings-pill-stack">
                    <span class="status-pill status-pill--success">Private beta</span>
                    <span class="status-pill">Fast iterations ahead</span>
                </div>
            </section>

            <section class="settings-grid">
                <article class="settings-card">
                    <header>
                        <h2>Account information</h2>
                        <p class="text-muted">Identity pulled directly from your secure tenant context.</p>
                    </header>
                    <dl class="detail-dl compact">
                        <dt>Email</dt>
                        <dd>@context.User.Identity?.Name</dd>
                        <dt>User ID</dt>
                        <dd class="mono">@context.User.FindFirst("sub")?.Value</dd>
                        <dt>Tenant ID</dt>
                        <dd class="mono">@context.User.FindFirst("tenant_id")?.Value</dd>
                    </dl>
                </article>

                <article class="settings-card">
                    <header>
                        <h2>Security roadmap</h2>
                        <p class="text-muted">Phase 1 focuses on giving administrators confidence before GA.</p>
                    </header>
                    <ul class="settings-roadmap">
                        <li>
                            <span>Enable / disable 2FA</span>
                            <small>Authenticator + SMS fallbacks</small>
                        </li>
                        <li>
                            <span>Change password</span>
                            <small>Zero-downtime credential rotations</small>
                        </li>
                        <li>
                            <span>Manage sessions</span>
                            <small>Revoke suspicious device tokens in one click</small>
                        </li>
                        <li>
                            <span>Connected OAuth accounts</span>
                            <small>View and disconnect Google / Microsoft bindings</small>
                        </li>
                    </ul>
                </article>
            </section>

            <section class="settings-grid">
                <article class="settings-card span-2">
                    <header class="d-flex justify-content-between flex-wrap gap-2 align-items-start">
                        <div>
                            <p class="hero-eyebrow mb-1">Search & display</p>
                            <h2>Personalize your results</h2>
                        </div>
                        <span class="status-pill">@(_preferences.AutoScrollToKeyword ? "Auto-scroll on" : "Manual focus")</span>
                    </header>
                    @if (_isLoadingPreferences)
                    {
                        <p class="text-muted mb-0">Loading your preferences…</p>
                    }
                    else
                    {
                        <div class="settings-columns search-preferences">
                            <div>
                                <h3>Date format</h3>
                                <p class="text-muted">Choose how dates appear across search results and detail views.</p>
                                <div class="btn-group pref-group" role="group" aria-label="Date format">
                                    <button type="button"
                                            class="@GetDateFormatButtonClass(DateFormatPreference.MonthDayYear)"
                                            @onclick="() => SetDateFormatAsync(DateFormatPreference.MonthDayYear)">
                                        Dec 21, 2025
                                    </button>
                                    <button type="button"
                                            class="@GetDateFormatButtonClass(DateFormatPreference.DayMonthYear)"
                                            @onclick="() => SetDateFormatAsync(DateFormatPreference.DayMonthYear)">
                                        21.12.2025
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h3>Highlights</h3>
                                <p class="text-muted">Control whether Evermail automatically moves to the first keyword hit.</p>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="autoScrollToggle"
                                           checked="@_preferences.AutoScrollToKeyword"
                                           @onchange="ToggleAutoScrollAsync" />
                                    <label class="form-check-label" for="autoScrollToggle">
                                        Auto-scroll to first keyword when opening an email
                                    </label>
                                </div>
                                <small class="text-muted">You can still jump between highlights using the “Next match” button.</small>
                            </div>
                        </div>
                    }
                </article>
            </section>

            <section class="settings-grid">
                <article class="settings-card span-2">
                    <header class="d-flex justify-content-between flex-wrap gap-2 align-items-start">
                        <div>
                            <p class="hero-eyebrow mb-1">Subscription</p>
                            <h2>Coming in Phase 1</h2>
                        </div>
                        <span class="status-pill status-pill--pending">Design in progress</span>
                    </header>
                    <div class="settings-columns">
                        <div>
                            <h3>What you’ll be able to control</h3>
                            <ul class="settings-list">
                                <li>View current plan & limits</li>
                                <li>Upgrade to Pro / Team / Enterprise</li>
                                <li>Export usage + billing receipts</li>
                                <li>Configure invoice recipients</li>
                            </ul>
                        </div>
                        <div>
                            <h3>Preview data points</h3>
                            <dl class="detail-dl compact">
                                <dt>Current plan</dt>
                                <dd>Free (1 GB, 1 mailbox)</dd>
                                <dt>Upcoming modules</dt>
                                <dd>Usage analytics, billing history, payment methods</dd>
                            </dl>
                        </div>
                    </div>
                </article>
            </section>
        </div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
</AuthorizeView>

@code {
    private UserPreferences _preferences = UserPreferences.CreateDefault();
    private bool _isLoadingPreferences = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPreferencesAsync();
            StateHasChanged();
        }
    }

    private async Task LoadPreferencesAsync()
    {
        try
        {
            _preferences = await PreferencesService.GetPreferencesAsync();
        }
        catch
        {
            _preferences = UserPreferences.CreateDefault();
        }
        finally
        {
            _isLoadingPreferences = false;
        }
    }

    private async Task SetDateFormatAsync(DateFormatPreference preference)
    {
        if (_preferences.DateFormat == preference)
        {
            return;
        }

        _preferences = await PreferencesService.SetDateFormatAsync(preference);
        StateHasChanged();
    }

    private async Task ToggleAutoScrollAsync(ChangeEventArgs e)
    {
        var enabled = e.Value switch
        {
            bool boolValue => boolValue,
            string stringValue => stringValue.Equals("true", StringComparison.OrdinalIgnoreCase) || stringValue.Equals("on", StringComparison.OrdinalIgnoreCase),
            _ => _preferences.AutoScrollToKeyword
        };

        _preferences = await PreferencesService.SetAutoScrollAsync(enabled);
        StateHasChanged();
    }

    private string GetDateFormatButtonClass(DateFormatPreference option) =>
        _preferences.DateFormat == option ? "btn btn-primary" : "btn btn-outline-secondary";
}
