@page "/emails/{Id:guid}"
@rendermode InteractiveServer
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Email
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.WebApp.Services
@using System.Net.Http.Json
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject IJSRuntime JSRuntime

<PageTitle>@(_email?.Subject ?? "Email") - Evermail</PageTitle>

<AuthorizeView>
    <Authorized Context="authContext">
<div class="container mt-4">
    <div class="mb-3">
        @{
            var backUrl = "/emails";
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var queryParams = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            if (queryParams.TryGetValue("mailbox", out var mailboxParam))
            {
                backUrl += $"?mailbox={mailboxParam}";
            }
        }
        <a href="@backUrl" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Emails
        </a>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading email...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @_errorMessage
        </div>
    }
    else if (_email == null)
    {
        <div class="alert alert-warning">
            <h4>Email Not Found</h4>
            <p>The email you're looking for doesn't exist or you don't have permission to access it.</p>
            <a href="/emails" class="btn btn-primary">Back to Emails</a>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">@(_email.Subject ?? "(No Subject)")</h3>
            </div>
            <div class="card-body">
                <!-- Email Headers -->
                <div class="mb-4">
                    <div class="row mb-2">
                        <div class="col-md-2"><strong>From:</strong></div>
                        <div class="col-md-10">
                            @if (!string.IsNullOrEmpty(_email.FromName))
                            {
                                <text>@_email.FromName</text>
                                <small class="text-muted">&lt;@_email.FromAddress&gt;</small>
                            }
                            else
                            {
                                <text>@_email.FromAddress</text>
                            }
                        </div>
                    </div>
                    @if (_email.ToAddresses.Any())
                    {
                        <div class="row mb-2">
                            <div class="col-md-2"><strong>To:</strong></div>
                            <div class="col-md-10">
                                @for (int i = 0; i < _email.ToAddresses.Count; i++)
                                {
                                    var address = _email.ToAddresses[i];
                                    var name = i < _email.ToNames.Count ? _email.ToNames[i] : null;
                                    if (!string.IsNullOrEmpty(name))
                                    {
                                        <text>@name &lt;@address&gt;</text>
                                    }
                                    else
                                    {
                                        <text>@address</text>
                                    }
                                    @if (i < _email.ToAddresses.Count - 1)
                                    {
                                        <text>, </text>
                                    }
                                }
                            </div>
                        </div>
                    }
                    @if (_email.CcAddresses.Any())
                    {
                        <div class="row mb-2">
                            <div class="col-md-2"><strong>Cc:</strong></div>
                            <div class="col-md-10">
                                @for (int i = 0; i < _email.CcAddresses.Count; i++)
                                {
                                    var address = _email.CcAddresses[i];
                                    var name = i < _email.CcNames.Count ? _email.CcNames[i] : null;
                                    if (!string.IsNullOrEmpty(name))
                                    {
                                        <text>@name &lt;@address&gt;</text>
                                    }
                                    else
                                    {
                                        <text>@address</text>
                                    }
                                    @if (i < _email.CcAddresses.Count - 1)
                                    {
                                        <text>, </text>
                                    }
                                }
                            </div>
                        </div>
                    }
                    <div class="row mb-2">
                        <div class="col-md-2"><strong>Date:</strong></div>
                        <div class="col-md-10">@_email.Date.ToString("yyyy-MM-dd HH:mm:ss UTC")</div>
                    </div>
                </div>

                <!-- Attachments -->
                @if (_email.HasAttachments && _email.Attachments != null && _email.Attachments.Any())
                {
                    <div class="mb-4">
                        <h5>Attachments (@_email.AttachmentCount)</h5>
                        <div class="list-group">
                            @foreach (var attachment in _email.Attachments)
                            {
                                <button type="button"
                                        class="list-group-item list-group-item-action text-start border-0 bg-transparent w-100"
                                        @onclick="async () => await DownloadAttachment(attachment.Id)">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-paperclip me-2"></i>
                                            <strong>@attachment.FileName</strong>
                                            <small class="text-muted ms-2">(@FormatFileSize(attachment.SizeBytes))</small>
                                        </div>
                                        <i class="bi bi-download"></i>
                                    </div>
                                </button>
                            }
                        </div>
                    </div>
                }

                <!-- Email Body -->
                <div class="email-body">
                    @if (!string.IsNullOrEmpty(_email.HtmlBody))
                    {
                        <div class="border p-3" style="min-height: 200px;">
                            @((MarkupString)_email.HtmlBody)
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(_email.TextBody))
                    {
                        <div class="border p-3" style="min-height: 200px; white-space: pre-wrap; font-family: monospace;">
                            @_email.TextBody
                        </div>
                    }
                    else
                    {
                        <div class="border p-3 text-muted">
                            <em>No content available</em>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public Guid Id { get; set; }

    private EmailDetailDto? _email;
    private bool _isLoading = true;
    private string _errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        // Load email when component initializes
        // Since we're inside AuthorizeView <Authorized>, user is authenticated
        // Use OnAfterRenderAsync to ensure JS interop is available
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadEmail();
        }
    }

    private async Task LoadEmail()
    {
        _isLoading = true;
        _errorMessage = "";
        StateHasChanged();

        try
        {
            // Get token from localStorage (requires JS interop, so must be after render)
            var token = await AuthStateService.GetTokenAsync();
            
            // If no token, try refreshing
            if (string.IsNullOrEmpty(token))
            {
                await AuthStateService.RefreshTokenIfNeededAsync();
                token = await AuthStateService.GetTokenAsync();
            }
            
            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in to view email details";
                _isLoading = false;
                StateHasChanged();
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/emails/{Id}";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            // Add timeout to prevent hanging
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
            var response = await Http.SendAsync(request, cts.Token);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<EmailDetailDto>>();
                if (result?.Success == true && result.Data != null)
                {
                    _email = result.Data;
                    _errorMessage = "";
                }
                else
                {
                    _errorMessage = result?.Error ?? "Failed to parse email data";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                _email = null;
                _errorMessage = "Email not found";
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "You are not authorized to view this email";
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Failed to load email: {response.StatusCode}. {errorText}";
            }
        }
        catch (TaskCanceledException)
        {
            _errorMessage = "Request timed out. Please try again.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading email: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DownloadAttachment(Guid attachmentId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                await AuthStateService.RefreshTokenIfNeededAsync();
                token = await AuthStateService.GetTokenAsync();
            }

            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in to download attachments";
                StateHasChanged();
                return;
            }

            var attachmentUrl = $"{Navigation.BaseUri}api/v1/attachments/{attachmentId}/download";
            await JSRuntime.InvokeVoidAsync("attachmentDownload.download", attachmentUrl, token);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to download attachment: {ex.Message}";
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

