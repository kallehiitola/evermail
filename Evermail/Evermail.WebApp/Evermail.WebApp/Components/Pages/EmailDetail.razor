@page "/emails/{Id:guid}"
@rendermode InteractiveServer
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Email
@using Evermail.Common.Search
@using Evermail.WebApp.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using Evermail.WebApp.Services
@using System.Net.Http.Json
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject IJSRuntime JSRuntime
@inject UserPreferencesService PreferencesService

<PageTitle>@(_email?.Subject ?? "Email") - Evermail</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="home-wrapper email-detail-wrapper">
            @if (_isLoading)
            {
                <div class="card modern-card text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted mb-0">Loading email…</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger modern-alert">
                    <strong>Error:</strong> @_errorMessage
                </div>
            }
            else if (_email is null)
            {
                <div class="card modern-card text-center">
                    <h3>Email not found</h3>
                    <p class="text-muted mb-4">The email you're looking for doesn't exist or you lack permission to view it.
                    </p>
                    <a href="/emails" class="btn btn-primary">Back to Emails</a>
                </div>
            }
            else
            {
                <section class="detail-hero email-hero">
                    <div class="detail-hero__left">
                        <a href="@GetBackUrl()" class="btn btn-outline-secondary detail-back">
                            <i class="bi bi-arrow-left me-2"></i>Back to Emails
                        </a>
                        <p class="hero-eyebrow mb-1">Message</p>
                        <h1>@(_email.Subject ?? "(No Subject)")</h1>
                        <p class="text-muted mb-4">@FormatTimestamp(_email.Date)</p>

                        <div class="email-address-rows">
                            <div class="email-address-row">
                                <span class="email-address-label">From</span>
                                <div class="email-address-stack">
                                    <span class="email-address-pill">
                                        @FormatAddress(_email.FromName, _email.FromAddress)
                                    </span>
                                </div>
                            </div>

                            @if (HasAddresses(_email.ToAddresses))
                            {
                                <div class="email-address-row">
                                    <span class="email-address-label">To</span>
                                    <div class="email-address-stack">
                                        @foreach (var recipient in CombineAddresses(_email.ToAddresses, _email.ToNames))
                                        {
                                            <span class="email-address-pill">@FormatAddress(recipient.Name,
                                                                                    recipient.Address)</span>
                                                                }
                                    </div>
                                </div>
                            }

                            @if (HasAddresses(_email.CcAddresses))
                            {
                                <div class="email-address-row">
                                    <span class="email-address-label">Cc</span>
                                    <div class="email-address-stack">
                                        @foreach (var recipient in CombineAddresses(_email.CcAddresses, _email.CcNames))
                                        {
                                            <span class="email-address-pill">@FormatAddress(recipient.Name,
                                                                                    recipient.Address)</span>
                                                                }
                                    </div>
                                </div>
                            }

                            @if (HasAddresses(_email.BccAddresses))
                            {
                                <div class="email-address-row">
                                    <span class="email-address-label">Bcc</span>
                                    <div class="email-address-stack">
                                        @foreach (var recipient in CombineAddresses(_email.BccAddresses, _email.BccNames))
                                        {
                                            <span class="email-address-pill">@FormatAddress(recipient.Name,
                                                                                    recipient.Address)</span>
                                                                }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="detail-hero__right">
                        <span class="status-pill @( _email.IsRead ? "status-pill--success" : "status-pill--pending")">
                            @(_email.IsRead ? "Read" : "Unread")
                        </span>

                        <div class="email-hero-meta">
                            <div>
                                <p class="hero-eyebrow mb-1 text-uppercase">Thread</p>
                                <strong>@GetThreadSummary()</strong>
                            </div>
                            <div>
                                <p class="hero-eyebrow mb-1 text-uppercase">Attachments</p>
                                <strong>@_email.AttachmentCount</strong>
                            </div>
                        </div>

                        <div class="action-pill-group">
                            <a href="/emails?mailbox=@_email.MailboxId" class="action-pill">
                                <i class="bi bi-list"></i>All emails
                            </a>
                            <a href="/mailboxes/@_email.MailboxId" class="action-pill">
                                <i class="bi bi-inbox"></i>Mailbox
                            </a>
                        </div>
                    </div>
                </section>


                @if (_email.HasAttachments && _email.Attachments is { Count: > 0 })
                {
                    <section class="modern-card email-attachments-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <p class="hero-eyebrow mb-1">Attachments</p>
                                <h2 class="mb-0">@_email.AttachmentCount file@(_email.AttachmentCount == 1 ? "" : "s")</h2>
                            </div>
                        </div>

                        <div class="attachment-list">
                            @foreach (var attachment in _email.Attachments)
                            {
                                <button type="button" class="attachment-pill"
                                    @onclick="async () => await DownloadAttachment(attachment.Id)">
                                    <div>
                                        <i class="bi bi-paperclip me-2"></i>
                                        <strong>@attachment.FileName</strong>
                                        <small class="text-muted ms-2">@FormatFileSize(attachment.SizeBytes)</small>
                                    </div>
                                    <i class="bi bi-download"></i>
                                </button>
                            }
                        </div>
                    </section>
                }

                <section class="modern-card email-body-card" id="email-body-card">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 email-body-toolbar">
                        <div>
                            <p class="hero-eyebrow mb-1">Email body</p>
                            <h2 class="mb-0">Content</h2>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            @if (_preferences.MatchNavigatorEnabled && _searchTerms.Count > 0)
                            {
                                <button type="button" class="btn btn-outline-secondary btn-sm keyword-jump"
                                    disabled="@(_highlightCount == 0)" @onclick="ScrollToMatchAsync">
                                    <i class="bi bi-search me-1"></i>@MatchNavigatorButtonLabel
                                </button>
                            }
                            @if (HasBodyToggle)
                            {
                                <div class="email-body-toggle btn-group">
                                    <button type="button"
                                        class="btn btn-sm btn-outline-secondary @(!_showPlainTextBody ? "active" : "")"
                                        @onclick="() => SetBodyMode(false)">
                                        Rich view
                                    </button>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-secondary @(_showPlainTextBody ? "active" : "")"
                                        @onclick="() => SetBodyMode(true)">
                                        Plain text
                                    </button>
                                </div>
                            }
                        </div>
                    </div>

                    @if (ShouldShowHtmlBody())
                    {
                        <div class="email-body-html email-body-content" id="email-body-content">
                            @((MarkupString)_email.HtmlBody!)
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(_email.TextBody))
                    {
                        <pre class="email-body-text email-body-content" id="email-body-content">@_email.TextBody</pre>
                    }
                    else
                    {
                        <div class="email-body-empty text-muted">
                            <em>No content available</em>
                        </div>
                    }
                </section>

                <section class="detail-grid email-info-grid">
                    <div class="detail-card">
                        <h3>Participants</h3>
                        <dl class="email-meta-list">
                            <div>
                                <dt>Sender</dt>
                                <dd>@FormatAddress(_email.SenderName ?? _email.FromName, _email.SenderAddress ??
                                                                    _email.FromAddress)</dd>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(_email.ReplyToAddress))
                            {
                                <div>
                                    <dt>Reply-To</dt>
                                    <dd class="email-address-pill">@_email.ReplyToAddress</dd>
                                </div>
                            }
                            <div>
                                <dt>Date</dt>
                                <dd>@FormatTimestamp(_email.Date)</dd>
                            </div>
                            <div>
                                <dt>Importance</dt>
                                <dd>@(_email.Importance ?? "—")</dd>
                            </div>
                            <div>
                                <dt>Priority</dt>
                                <dd>@(_email.Priority ?? "—")</dd>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(_email.Categories))
                            {
                                <div>
                                    <dt>Categories</dt>
                                    <dd>@_email.Categories</dd>
                                </div>
                            }
                        </dl>
                    </div>

                    <div class="detail-card">
                        <h3>Message metadata</h3>
                        <dl class="email-meta-list">
                            <div>
                                <dt>Message-ID</dt>
                                <dd>@(_email.MessageId ?? "—")</dd>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(_email.InReplyTo))
                            {
                                <div>
                                    <dt>In-Reply-To</dt>
                                    <dd>@_email.InReplyTo</dd>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(_email.References))
                            {
                                <div>
                                    <dt>References</dt>
                                    <dd>@_email.References</dd>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(_email.ReturnPath))
                            {
                                <div>
                                    <dt>Return-Path</dt>
                                    <dd>@_email.ReturnPath</dd>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(_email.ListId))
                            {
                                <div>
                                    <dt>List-Id</dt>
                                    <dd>@_email.ListId</dd>
                                </div>
                            }
                            <div>
                                <dt>Thread ID</dt>
                                <dd>@(_email.ConversationId?.ToString() ?? "—")</dd>
                            </div>
                        </dl>
                    </div>
                </section>
            }

            @if (_preferences.MatchNavigatorEnabled && _searchTerms.Count > 0)
            {
                <button type="button" class="btn btn-primary match-navigator-floating" disabled="@(_highlightCount == 0)"
                    @onclick="ScrollToMatchAsync">
                    <i class="bi bi-search me-1"></i>@MatchNavigatorButtonLabel
                </button>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public Guid Id { get; set; }

    private const string HighlightSelector = "#email-body-content";
    private EmailDetailDto? _email;
    private bool _isLoading = true;
    private string _errorMessage = "";
    private bool _showPlainTextBody;
    private IReadOnlyList<string> _searchTerms = Array.Empty<string>();
    private bool _pendingHighlight;
    private int _highlightCount;
    private int _currentMatchPosition;
    private UserPreferences _preferences = UserPreferences.CreateDefault();

    protected override async Task OnInitializedAsync()
    {
        // Load email when component initializes
        // Since we're inside AuthorizeView <Authorized>, user is authenticated
        // Use OnAfterRenderAsync to ensure JS interop is available
    }

    protected override void OnParametersSet()
    {
        ReadSearchTerms();
        if (_email is not null && _searchTerms.Count > 0)
        {
            _pendingHighlight = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPreferencesAsync();
            await LoadEmail();
        }

        if (_pendingHighlight && !_isLoading)
        {
            _pendingHighlight = false;
            await ApplyHighlightsAsync();
        }
    }

    private async Task LoadEmail()
    {
        _isLoading = true;
        _errorMessage = "";
        StateHasChanged();

        try
        {
            // Get token from localStorage (requires JS interop, so must be after render)
            var token = await AuthStateService.GetTokenAsync();

            // If no token, try refreshing
            if (string.IsNullOrEmpty(token))
            {
                await AuthStateService.RefreshTokenIfNeededAsync();
                token = await AuthStateService.GetTokenAsync();
            }

            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in to view email details";
                _isLoading = false;
                StateHasChanged();
                return;
            }

            var url = $"{Navigation.BaseUri}api/v1/emails/{Id}";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("Authorization", $"Bearer {token}");

            // Add timeout to prevent hanging
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
            var response = await Http.SendAsync(request, cts.Token);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<EmailDetailDto>>();
                if (result?.Success == true && result.Data != null)
                {
                    _email = result.Data;
                    _errorMessage = "";
                    _pendingHighlight = _searchTerms.Count > 0;
                }
                else
                {
                    _errorMessage = result?.Error ?? "Failed to parse email data";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                _email = null;
                _errorMessage = "Email not found";
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "You are not authorized to view this email";
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Failed to load email: {response.StatusCode}. {errorText}";
            }
        }
        catch (TaskCanceledException)
        {
            _errorMessage = "Request timed out. Please try again.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading email: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DownloadAttachment(Guid attachmentId)
    {
        try
        {
            var token = await AuthStateService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                await AuthStateService.RefreshTokenIfNeededAsync();
                token = await AuthStateService.GetTokenAsync();
            }

            if (string.IsNullOrEmpty(token))
            {
                _errorMessage = "You must be logged in to download attachments";
                StateHasChanged();
                return;
            }

            var attachmentUrl = $"{Navigation.BaseUri}api/v1/attachments/{attachmentId}/download";
            await JSRuntime.InvokeVoidAsync("attachmentDownload.download", attachmentUrl, token);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to download attachment: {ex.Message}";
            StateHasChanged();
        }
    }

    private string GetBackUrl()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        var returnParams = new Dictionary<string, string?>();

        if (queryParams.TryGetValue("mailbox", out var mailboxParam))
        {
            returnParams["mailbox"] = mailboxParam;
        }

        if (queryParams.TryGetValue("q", out var queryParam))
        {
            returnParams["q"] = queryParam;
        }

        if (queryParams.TryGetValue("stopWords", out var stopParam))
        {
            returnParams["stopWords"] = stopParam;
        }

        if (queryParams.TryGetValue("recipient", out var recipientParam))
        {
            returnParams["recipient"] = recipientParam;
        }

        if (queryParams.TryGetValue("useInflectionalForms", out var inflectionParam))
        {
            returnParams["useInflectionalForms"] = inflectionParam;
        }

        return returnParams.Count > 0
        ? QueryHelpers.AddQueryString("/emails", returnParams)
        : "/emails";
    }

    private void ReadSearchTerms()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        if (queryParams.TryGetValue("q", out var queryValue))
        {
            _searchTerms = SearchQueryParser.ExtractTerms(queryValue.ToString());
        }
        else
        {
            _searchTerms = Array.Empty<string>();
        }
    }

    private bool HasBodyToggle =>
    !string.IsNullOrEmpty(_email?.HtmlBody) && !string.IsNullOrEmpty(_email?.TextBody);

    private void SetBodyMode(bool showPlain)
    {
        if (_showPlainTextBody == showPlain)
        {
            return;
        }

        _showPlainTextBody = showPlain;
        StateHasChanged();
        _pendingHighlight = _searchTerms.Count > 0;
    }

    private bool ShouldShowHtmlBody() =>
    !_showPlainTextBody && !string.IsNullOrEmpty(_email?.HtmlBody);

    private string FormatTimestamp(DateTime value) =>
    value.ToString("MMM d, yyyy • HH:mm 'UTC'");

    private string GetThreadSummary() =>
    _email?.ConversationId is null
    ? "Single message"
    : $"Reply {_email.ThreadDepth + 1} of {_email.ThreadSize}";

    private static bool HasAddresses(List<string> addresses) =>
    addresses is { Count: > 0 };

    private static IEnumerable<(string? Name, string Address)> CombineAddresses(
    List<string> addresses,
    List<string> names)
    {
        for (var i = 0; i < addresses.Count; i++)
        {
            var address = addresses[i];
            var name = i < names.Count ? names[i] : null;
            yield return (name, address);
        }
    }

    private static string FormatAddress(string? name, string address) =>
    string.IsNullOrWhiteSpace(name) ? address : $"{name} <{address}>";

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async Task LoadPreferencesAsync()
    {
        try
        {
            _preferences = await PreferencesService.GetPreferencesAsync();
        }
        catch
        {
            _preferences = UserPreferences.CreateDefault();
        }
    }

    private async Task ApplyHighlightsAsync()
    {
        if (_searchTerms.Count == 0 || _email is null)
        {
            _highlightCount = 0;
            _currentMatchPosition = 0;
            return;
        }

        try
        {
            _highlightCount = await JSRuntime.InvokeAsync<int>(
            "EvermailSearchHighlights.highlightBody",
            HighlightSelector,
            _searchTerms,
            _preferences.AutoScrollToKeyword);
            _currentMatchPosition = _highlightCount > 0 && _preferences.AutoScrollToKeyword
            ? 1
            : 0;
            StateHasChanged();
        }
        catch (InvalidOperationException)
        {
            _pendingHighlight = true;
        }
    }

    private async Task ScrollToMatchAsync()
    {
        if (_searchTerms.Count == 0)
        {
            return;
        }

        if (_highlightCount == 0)
        {
            await ApplyHighlightsAsync();
            if (_highlightCount == 0)
            {
                return;
            }
        }

        try
        {
            var position = await JSRuntime.InvokeAsync<int>(
            "EvermailSearchHighlights.scrollToMatch",
            HighlightSelector,
            "next");
            if (position > 0)
            {
                _currentMatchPosition = position;
                StateHasChanged();
            }
        }
        catch (InvalidOperationException)
        {
            // ignored - JS not ready yet
        }
    }

    private string MatchNavigatorButtonLabel =>
    _highlightCount == 0 || _currentMatchPosition == 0
    ? "Jump to match"
    : $"Match {_currentMatchPosition}/{_highlightCount}";
}
