@page "/onboarding"
@rendermode InteractiveServer
@using System.Collections.Generic
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Web
@using System.Linq
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Tenant
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Tenant Onboarding - Evermail</PageTitle>

<div class="home-wrapper onboarding-wrapper">
    <section class="modern-card onboarding-hero mb-4">
        <div>
            <p class="hero-eyebrow text-uppercase mb-2">Secure archive setup</p>
            <h1>Bring every mailbox back within reach.</h1>
            <p class="hero-subtext mb-0">
                Upload Gmail/Outlook exports, unlock lightning-fast search and AI summaries, and keep compliance calm—the entire pipeline stays zero-access.
            </p>
        </div>
        <div class="onboarding-progress">
            @if (_canManageOnboarding)
            {
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">@_completedSteps of @_steps.Count steps completed</span>
                    <span class="text-muted small">@CompletionPercent.ToString("0")% done</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" style="width:@CompletionPercent%" role="progressbar"
                         aria-valuenow="@CompletionPercent" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex flex-wrap gap-2 mt-3">
                    <button type="button"
                            class="btn btn-light btn-sm"
                            @onclick="LoadAllAsync"
                            disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Refresh status
                    </button>
                    <a class="btn btn-outline-light btn-sm" href="/upload">
                        Skip to upload
                    </a>
                    <button type="button"
                            class="btn btn-outline-light btn-sm"
                            @onclick='() => OpenWizard(_status?.SubscriptionTier ?? "Pro")'>
                        Guided wizard
                    </button>
                </div>
            }
            else
            {
                <div class="onboarding-progress__readonly">
                    <p class="mb-2">
                        Spin up your workspace to run the guided wizard, or explore tiers and security modes below.
                    </p>
                    <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-light btn-sm" href="/register">Create workspace</a>
                        <a class="btn btn-outline-light btn-sm" href="/login">Sign in</a>
                    </div>
                </div>
            }
        </div>
    </section>

    <section class="modern-card onboarding-values mb-4">
        <div class="onboarding-value-grid">
            <article class="onboarding-value-card">
                <p class="hero-eyebrow text-uppercase mb-1">Search & AI</p>
                <h3>Find any decision in seconds</h3>
                <p class="text-muted mb-0">
                    Index multi-gig archives, run semantic + classic filters, and let AI summarize threads so founders, finance, and investors never lose context.
                </p>
            </article>
            <article class="onboarding-value-card">
                <p class="hero-eyebrow text-uppercase mb-1">Offboarding & compliance</p>
                <h3>Keep ex-employee mailboxes available</h3>
                <p class="text-muted mb-0">
                    Share read-only vaults with Finance or Legal, honor retention policies, and answer DSAR/FOIA requests without reactivating email licenses.
                </p>
            </article>
            <article class="onboarding-value-card">
                <p class="hero-eyebrow text-uppercase mb-1">Zero-access security</p>
                <h3>Encryption is on from day one</h3>
                <p class="text-muted mb-0">
                    We encrypt before storage and run ingestion inside confidential compute. Need BYOK with Azure or AWS? Flip it on when security asks.
                </p>
            </article>
        </div>
    </section>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger mb-4" role="alert">
            @_errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(_statusMessage))
    {
        <div class="alert alert-success mb-4" role="alert">
            @_statusMessage
        </div>
    }

    @if (!_canManageOnboarding)
    {
        <section class="modern-card onboarding-readonly">
            <div class="onboarding-plans__intro text-center text-lg-start">
                <p class="hero-eyebrow text-uppercase mb-1">Explore the plans</p>
                <h2 class="mb-2">Choose your archive & insight combo</h2>
                <p class="text-muted mb-4">
                    All tiers include encrypted uploads, instant search, and read-only sharing. Upgrade whenever your storage, AI, or retention needs expand.
                </p>
                <div class="billing-toggle billing-toggle--inline mt-3">
                    <button type="button"
                            class="billing-toggle__option @(!_showAnnualBilling ? "is-active" : null)"
                            @onclick="() => SetBillingMode(false)">
                        Monthly
                    </button>
                    <button type="button"
                            class="billing-toggle__option @(_showAnnualBilling ? "is-active" : null)"
                            @onclick="() => SetBillingMode(true)">
                        Annual <span class="text-success fw-semibold">Save 2 months</span>
                    </button>
                </div>
            </div>
            <div class="onboarding-plans__grid mt-4">
                @RenderPlanGrid(readOnly: true, enableWizardCta: true)
            </div>
        </section>
    }
    else
    {
        <section class="modern-card onboarding-layout">
            <div class="row g-4">
                <div class="col-lg-4">
                    <ul class="wizard-step-list list-group">
                        @for (var i = 0; i < _steps.Count; i++)
                        {
                            var step = _steps[i];
                            var isActive = i == _currentStepIndex;
                            var isComplete = IsStepComplete(step);
                            <li class="list-group-item wizard-step @(isActive ? "active" : null)"
                                @onclick="@(() => SetCurrentStep(i))">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="wizard-step__index">@((i + 1).ToString("00"))</span>
                                        <span class="wizard-step__title">@step.Title</span>
                                    </div>
                                    <i class="bi @(isComplete ? "bi-check-circle-fill text-success" : "bi-circle text-muted")"></i>
                                </div>
                                <p class="text-muted small mb-0">@step.Description</p>
                            </li>
                        }
                    </ul>
                </div>
                <div class="col-lg-8">
                    @if (_isLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-3 mb-0">Loading onboarding data…</p>
                        </div>
                    }
                    else
                    {
                        @switch (_steps[_currentStepIndex].Type)
                        {
                            case WizardStepType.Plan:
                                @RenderPlanGrid(readOnly: false)
                                break;
                            case WizardStepType.Security:
                                @RenderSecurityStep()
                                break;
                            default:
                                @RenderUploadStep()
                                break;
                        }
                    }
                </div>
            </div>
        </section>
    }
</div>

@if (_showWizard)
{
    <div class="onboarding-modal">
        <div class="onboarding-modal__backdrop" @onclick="CloseWizard"></div>
        <div class="onboarding-modal__panel">
            <div class="onboarding-modal__header d-flex justify-content-between align-items-start">
                <div>
                    <p class="hero-eyebrow text-uppercase mb-2">Guided onboarding</p>
                    <h3 class="mb-1">Let’s configure your archive</h3>
                    <p class="text-muted mb-0">Answer two quick questions—we’ll recommend the right storage tier and security mode. You can change either any time.</p>
                </div>
                <button class="btn btn-link text-muted" type="button" @onclick="CloseWizard">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="billing-toggle billing-toggle--compact mb-3">
                <button type="button"
                        class="billing-toggle__option @(!_showAnnualBilling ? "is-active" : null)"
                        @onclick="() => SetBillingMode(false)">
                    Monthly
                </button>
                <button type="button"
                        class="billing-toggle__option @(_showAnnualBilling ? "is-active" : null)"
                        @onclick="() => SetBillingMode(true)">
                    Annual <span class="text-success fw-semibold">Save 2 months</span>
                </button>
            </div>

            <div class="wizard-plan-grid">
                @foreach (var plan in GetActivePlans())
                {
                    var isSelected = string.Equals(plan.Name, _selectedPlan, StringComparison.OrdinalIgnoreCase);
                    <button class="wizard-plan @(isSelected ? "is-selected" : null)"
                            type="button"
                            @onclick="@(() => SelectWizardPlan(plan.Name))">
                        <div class="wizard-plan__header">
                            <div>
                                <p class="hero-eyebrow mb-1 text-uppercase">@plan.Name</p>
                                <h5 class="mb-0">@plan.DisplayName</h5>
                            </div>
                            @if (plan.IsRecommended)
                            {
                                <span class="badge bg-primary-subtle text-primary-emphasis">Recommended</span>
                            }
                        </div>
                        <p class="text-muted small mb-2 wizard-plan__description">@plan.Description</p>
                        <div class="wizard-plan__price">
                            <strong>@GetPlanPriceLabel(plan)</strong>
                            @if (!string.IsNullOrWhiteSpace(GetPlanPriceCaption(plan)))
                            {
                                <span class="text-muted">@GetPlanPriceCaption(plan)</span>
                            }
                        </div>
                        <ul class="wizard-plan__features">
                            @foreach (var feature in plan.Features.Take(4))
                            {
                                <li>@feature</li>
                            }
                        </ul>
                    </button>
                }
            </div>

            <ol class="wizard-flow list-unstyled">
                <li class="is-active"><span>1</span> Choose plan & seats</li>
                <li><span>2</span> Decide security mode</li>
                <li><span>3</span> Upload first archive</li>
            </ol>

            <button class="btn btn-primary btn-lg w-100" type="button" @onclick="ContinueWizardAsync" disabled="@_isWizardProcessing">
                @if (_isWizardProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Continue with @SelectedPlanDisplayName
            </button>
            <p class="text-muted text-center small mt-3 mb-0">
                Next up: lock in encryption (if needed), drag in Gmail/Outlook exports, and start searching within minutes.
            </p>
        </div>
    </div>
}

@code {
    private readonly List<WizardStep> _steps =
    [
        new(WizardStepType.Plan, "Pick your archive plan", "Choose the storage, AI, and retention bundle that matches your workload."),
        new(WizardStepType.Security, "Confirm security mode", "Encryption is already on—stay with Evermail-managed or flip on Azure/AWS BYOK when needed."),
        new(WizardStepType.Upload, "Upload a mailbox", "Drag Gmail/Outlook exports (or our sample file) and start searching within minutes.")
    ];

    private IReadOnlyList<SubscriptionPlanDto> _plans = Array.Empty<SubscriptionPlanDto>();
    private TenantOnboardingStatusDto? _status;
    private int _currentStepIndex;
    private int _completedSteps;
    private bool _isLoading = true;
    private bool _isSavingPlan;
    private string? _pendingPlanName;
    private string? _errorMessage;
    private string? _statusMessage;
    private WizardStepType? _requestedStep;
    private bool _isAuthenticated;
    private bool _canManageOnboarding;
    private bool _showWizard;
    private string _selectedPlan = "Pro";
    private bool _isWizardProcessing;
    private bool _showAnnualBilling;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAuthenticated = user.Identity?.IsAuthenticated == true;
        _canManageOnboarding = _isAuthenticated && (user.IsInRole("Admin") || user.IsInRole("SuperAdmin"));

        var uri = new Uri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);
        if (Enum.TryParse(query["step"], true, out WizardStepType requested))
        {
            _requestedStep = requested;
        }

        if (_canManageOnboarding)
        {
            await LoadAllAsync();
        }
        else
        {
            _plans = DefaultPlans;
            _isLoading = false;
        }
    }

    private RenderFragment RenderPlanGrid(bool readOnly, bool enableWizardCta = false) => builder =>
    {
        var plans = GetActivePlans();

        if (plans.Count == 0)
        {
            builder.AddMarkupContent(0, "<p class=\"text-muted\">No plans available right now. Please try again later.</p>");
            return;
        }

        builder.OpenElement(1, "div");
        builder.AddAttribute(2, "class", "plan-grid row row-cols-1 row-cols-md-3 g-4");

        for (var i = 0; i < plans.Count; i++)
        {
            var plan = plans[i];
            var isCurrent = string.Equals(plan.Name, _status?.SubscriptionTier, StringComparison.OrdinalIgnoreCase);
            var planClasses = $"col plan-card {(isCurrent ? "plan-card--current" : string.Empty)}";
            builder.OpenElement(3 + i * 30, "div");
            builder.AddAttribute(4 + i * 30, "class", planClasses);
            builder.OpenElement(5 + i * 30, "div");
            builder.AddAttribute(6 + i * 30, "class", "card h-100");
            builder.OpenElement(7 + i * 30, "div");
            builder.AddAttribute(8 + i * 30, "class", "card-body d-flex flex-column gap-3");

            builder.OpenElement(9 + i * 30, "div");
            builder.AddAttribute(10 + i * 30, "class", "d-flex justify-content-between align-items-start gap-3");
            builder.OpenElement(11 + i * 30, "div");
            builder.AddAttribute(12 + i * 30, "class", "plan-header");
            builder.OpenElement(13 + i * 30, "h5");
            builder.AddContent(14 + i * 30, plan.DisplayName);
            builder.CloseElement();
            builder.OpenElement(15 + i * 30, "p");
            builder.AddAttribute(16 + i * 30, "class", "text-muted small mb-0");
            builder.AddContent(17 + i * 30, plan.Description);
            builder.CloseElement();
            builder.CloseElement();
            if (plan.IsRecommended)
            {
                builder.OpenElement(18 + i * 30, "span");
                builder.AddAttribute(19 + i * 30, "class", "badge bg-primary-subtle text-primary-emphasis");
                builder.AddContent(20 + i * 30, "Most popular");
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(21 + i * 30, "div");
            builder.AddAttribute(22 + i * 30, "class", "plan-price");
            builder.AddContent(23 + i * 30, GetPlanPriceLabel(plan));
            var caption = GetPlanPriceCaption(plan);
            if (!string.IsNullOrWhiteSpace(caption))
            {
                builder.OpenElement(24 + i * 30, "small");
                builder.AddAttribute(25 + i * 30, "class", "text-muted d-block");
                builder.AddContent(26 + i * 30, caption);
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(27 + i * 30, "ul");
            builder.AddAttribute(28 + i * 30, "class", "plan-feature-list");
            foreach (var feature in plan.Features.Take(6))
            {
                builder.OpenElement(29 + i * 30, "li");
                builder.AddMarkupContent(30 + i * 30, "<i class=\"bi bi-check2 text-success me-2\"></i>");
                builder.AddContent(31 + i * 30, feature);
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(32 + i * 30, "div");
            builder.AddAttribute(33 + i * 30, "class", "mt-auto");
            builder.OpenElement(34 + i * 30, "button");
            var buttonClass = readOnly ? "btn btn-primary w-100" : $"btn {(isCurrent ? "btn-outline-primary" : "btn-primary")} w-100";
            builder.AddAttribute(35 + i * 30, "class", buttonClass);
            var isSaving = !readOnly && _isSavingPlan && _pendingPlanName == plan.Name;
            builder.AddAttribute(36 + i * 30, "disabled", isSaving);
            builder.AddAttribute(37 + i * 30, "type", "button");
            if (readOnly && enableWizardCta)
            {
                builder.AddAttribute(38 + i * 30, "onclick", EventCallback.Factory.Create(this, () => OpenWizard(plan.Name)));
            }
            else if (!readOnly)
            {
                builder.AddAttribute(38 + i * 30, "onclick", EventCallback.Factory.Create(this, () => SelectPlanAsync(plan)));
            }
            if (isSaving)
            {
                builder.AddMarkupContent(39 + i * 30, "<span class=\"spinner-border spinner-border-sm me-2\" role=\"status\"></span>");
            }
            var buttonLabel = readOnly
                ? $"Start {plan.DisplayName}"
                : (isCurrent ? "Stay on this plan" : "Select plan");
            builder.AddContent(40 + i * 30, buttonLabel);
            builder.CloseElement();
            builder.CloseElement();

            builder.CloseElement();
            builder.CloseElement();
            builder.CloseElement();
        }

        builder.CloseElement();
    };

    private string SelectedPlanDisplayName => FindPlan(_selectedPlan)?.DisplayName ?? "Free Tier";

    private IReadOnlyList<SubscriptionPlanDto> GetActivePlans() => _plans.Count > 0 ? _plans : DefaultPlans;

    private SubscriptionPlanDto? FindPlan(string? planName) =>
        GetActivePlans().FirstOrDefault(p => string.Equals(p.Name, planName, StringComparison.OrdinalIgnoreCase));

    private void OpenWizard(string? planName)
    {
        var plans = GetActivePlans();
        var targetPlan = planName
                         ?? plans.FirstOrDefault(p => p.IsRecommended)?.Name
                         ?? plans.First().Name;
        _selectedPlan = targetPlan;
        _showWizard = true;
    }

    private void CloseWizard() => _showWizard = false;

    private void SelectWizardPlan(string planName) => _selectedPlan = planName;

    private void SetBillingMode(bool annual)
    {
        if (_showAnnualBilling == annual)
        {
            return;
        }

        _showAnnualBilling = annual;
        StateHasChanged();
    }

    private string GetPlanPriceLabel(SubscriptionPlanDto plan)
    {
        if (_showAnnualBilling && plan.PriceYearly > 0)
        {
            return plan.PriceYearly == 0 ? "Free" : $"€{plan.PriceYearly:0}/year";
        }

        return plan.PriceMonthly == 0 ? "Free" : $"€{plan.PriceMonthly:0}/month";
    }

    private string? GetPlanPriceCaption(SubscriptionPlanDto plan)
    {
        if (_showAnnualBilling)
        {
            return plan.PriceYearly > 0 ? "Billed annually" : "Annual billing not available";
        }

        return plan.PriceMonthly > 0 ? "Billed monthly" : null;
    }

    private async Task ContinueWizardAsync()
    {
        if (_isWizardProcessing)
        {
            return;
        }

        _isWizardProcessing = true;
        try
        {
            if (_canManageOnboarding)
            {
                var plan = FindPlan(_selectedPlan);
                if (plan is not null)
                {
                    await SelectPlanAsync(plan);
                }
                _showWizard = false;
            }
            else
            {
                var query = string.IsNullOrWhiteSpace(_selectedPlan)
                    ? string.Empty
                    : $"?plan={Uri.EscapeDataString(_selectedPlan)}";
                _showWizard = false;
                Navigation.NavigateTo($"/register{query}", forceLoad: true);
            }
        }
        finally
        {
            _isWizardProcessing = false;
        }
    }

    private RenderFragment RenderSecurityStep() => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "security-step");

        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "alert alert-info");
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "class", "d-flex align-items-center gap-2 mb-2");
        builder.AddMarkupContent(6, "<i class=\"bi bi-shield-lock fs-4\"></i>");
        builder.OpenElement(7, "div");
        builder.AddContent(8, "Security overview");
        builder.CloseElement();
        builder.CloseElement();
        builder.OpenElement(9, "p");
        builder.AddAttribute(10, "class", "mb-3");
        builder.AddContent(11, _status?.EncryptionConfigured == true
            ? "Encryption is already locked down. Stay on Evermail-managed encryption or connect your own key whenever security asks."
            : "Encryption is enabled by default. When you're ready, connect Azure Key Vault, AWS KMS, or generate an offline bundle without leaving the wizard.");
        builder.CloseElement();

        builder.AddMarkupContent(12, """
<div class="security-options">
    <article class="security-option">
        <p class="hero-eyebrow text-uppercase mb-1">Fastest path</p>
        <h4>Evermail-managed encryption</h4>
        <p class="text-muted">
            We host your workspace master key in our hardened Azure subscription, wrap every upload before storage, and run ingestion inside confidential compute.
        </p>
        <ul>
            <li>Zero plaintext even before you switch on BYOK.</li>
            <li>Automatic key rotation and monitoring.</li>
            <li>Ideal for founders kicking the tires or teams in private beta.</li>
        </ul>
    </article>
    <article class="security-option">
        <p class="hero-eyebrow text-uppercase mb-1">Advanced control</p>
        <h4>Bring your own key</h4>
        <p class="text-muted">
            Point Evermail at your Azure Key Vault, AWS KMS role, or generate an offline browser bundle for the most restrictive workloads.
        </p>
        <ul>
            <li>Use existing security reviews and logging.</li>
            <li>Share IAM roles with your infrastructure team.</li>
            <li>Offline BYOK keeps the master key solely on your disk.</li>
        </ul>
    </article>
</div>
""");

        builder.OpenElement(13, "div");
        builder.AddAttribute(14, "class", "d-flex flex-wrap gap-2 mt-3");
        builder.AddMarkupContent(15, "<a class=\"btn btn-primary\" href=\"/admin/encryption?onboarding=1\"><i class=\"bi bi-key-fill me-2\"></i>Open encryption settings</a>");
        builder.AddMarkupContent(16, "<a class=\"btn btn-outline-secondary\" href=\"/admin/offline-byok\"><i class=\"bi bi-cloud-slash me-2\"></i>Offline BYOK lab</a>");
        builder.OpenElement(17, "button");
        builder.AddAttribute(18, "class", "btn btn-link p-0 text-decoration-none");
        builder.AddAttribute(19, "type", "button");
        builder.AddAttribute(20, "onclick", EventCallback.Factory.Create(this, RefreshStatusAsync));
        builder.AddContent(21, "I've updated my keys, refresh status");
        builder.CloseElement();
        builder.CloseElement();

        builder.CloseElement();
    };

    private RenderFragment RenderUploadStep() => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "upload-step");
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "mb-3");
        builder.AddMarkupContent(4, "<p class=\"hero-eyebrow mb-1\">Mailbox ingestion</p>");
        builder.OpenElement(5, "h3");
        builder.AddContent(6, "Bring in your first archive");
        builder.CloseElement();
        builder.CloseElement();

        builder.OpenElement(7, "ul");
        builder.AddAttribute(8, "class", "upload-checklist");
        builder.AddMarkupContent(9, "<li><i class=\"bi bi-check2-circle text-success me-2\"></i>Drag & drop Gmail Takeout (.mbox) or Outlook exports (.zip) up to your plan limit.</li>");
        builder.AddMarkupContent(10, "<li><i class=\"bi bi-check2-circle text-success me-2\"></i>Everything streams straight to our Azure Blob Storage—no plaintext ever hits disk.</li>");
        builder.AddMarkupContent(11, "<li><i class=\"bi bi-check2-circle text-success me-2\"></i>Need a dry run? Use our sample archive or <code>scripts/generate-test-mbox.py</code> to simulate a real ingestion.</li>");
        builder.CloseElement();

        builder.OpenElement(12, "div");
        builder.AddAttribute(13, "class", "d-flex flex-wrap gap-3 align-items-center mt-3");
        builder.AddMarkupContent(14, "<a class=\"btn btn-primary btn-lg\" href=\"/upload\"><i class=\"bi bi-cloud-upload-fill me-2\"></i>Go to uploader</a>");
        builder.OpenElement(15, "span");
        builder.AddAttribute(16, "class", "text-muted small");
        builder.AddContent(17, "Keep this tab open while uploading so you can track ingestion in real-time.");
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
    };

    private async Task LoadAllAsync()
    {
        if (!_canManageOnboarding)
        {
            _plans = DefaultPlans;
            _isLoading = false;
            return;
        }

        _isLoading = true;
        _errorMessage = null;
        try
        {
            await Task.WhenAll(LoadPlansAsync(), LoadStatusAsync());
            SetInitialStep();
            _completedSteps = _steps.Count(step => IsStepComplete(step));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load onboarding data: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPlansAsync()
    {
        if (!_canManageOnboarding)
        {
            _plans = DefaultPlans;
            return;
        }

        var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/plans"));
        var response = await SendAuthorizedAsync(request);

        if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            _errorMessage = "Session expired. Please sign in again.";
            _plans = Array.Empty<SubscriptionPlanDto>();
            return;
        }

        var payload = await response.Content.ReadFromJsonAsync<ApiResponse<IReadOnlyList<SubscriptionPlanDto>>>();
        if (payload?.Success == true && payload.Data is not null)
        {
            _plans = payload.Data;
        }
        else
        {
            _plans = Array.Empty<SubscriptionPlanDto>();
            _errorMessage = payload?.Error ?? "Unable to load subscription plans.";
        }
    }

    private async Task LoadStatusAsync()
    {
        if (!_canManageOnboarding)
        {
            _status = null;
            return;
        }

        var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/onboarding/status"));
        var response = await SendAuthorizedAsync(request);

        if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            _errorMessage = "Session expired. Please sign in again.";
            _status = null;
            return;
        }

        var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantOnboardingStatusDto>>();

        if (payload?.Success == true && payload.Data is not null)
        {
            _status = payload.Data;
        }
        else
        {
            _status = null;
            _errorMessage = payload?.Error ?? "Unable to load onboarding status.";
        }
    }

    private void SetInitialStep()
    {
        if (_requestedStep.HasValue)
        {
            var requestedIndex = _steps.FindIndex(s => s.Type == _requestedStep.Value);
            if (requestedIndex >= 0)
            {
                _currentStepIndex = requestedIndex;
                _requestedStep = null;
                return;
            }
        }

        var firstIncomplete = _steps.FindIndex(step => !IsStepComplete(step));
        _currentStepIndex = firstIncomplete >= 0 ? firstIncomplete : _steps.Count - 1;
    }

    private void SetCurrentStep(int index)
    {
        if (index >= 0 && index < _steps.Count)
        {
            _currentStepIndex = index;
        }
    }

    private async Task SelectPlanAsync(SubscriptionPlanDto plan)
    {
        if (!_canManageOnboarding)
        {
            return;
        }

        _isSavingPlan = true;
        _pendingPlanName = plan.Name;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/subscription"))
            {
                Content = JsonContent.Create(new SelectSubscriptionPlanRequest(plan.Name))
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true)
            {
                await LoadStatusAsync();
                _completedSteps = _steps.Count(step => IsStepComplete(step));
                _statusMessage = $"Subscription updated to {plan.DisplayName}.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to update subscription.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to update subscription: {ex.Message}";
        }
        finally
        {
            _isSavingPlan = false;
            _pendingPlanName = null;
        }
    }

    private async Task RefreshStatusAsync()
    {
        if (!_canManageOnboarding)
        {
            return;
        }

        await LoadStatusAsync();
        _completedSteps = _steps.Count(step => IsStepComplete(step));
    }

    private bool IsStepComplete(WizardStep step) => step.Type switch
    {
        WizardStepType.Plan => _status?.PlanConfirmed == true,
        WizardStepType.Security => _status?.EncryptionConfigured == true,
        WizardStepType.Upload => _status?.HasMailbox == true,
        _ => false
    };

    private double CompletionPercent => _steps.Count == 0
        ? 0
        : Math.Min(100, (_steps.Count(step => IsStepComplete(step)) / (double)_steps.Count) * 100d);

    private Uri BuildApiUri(string relativePath)
    {
        relativePath = relativePath.TrimStart('/');
        return new Uri(new Uri(Navigation.BaseUri), relativePath);
    }

    private async Task<HttpResponseMessage> SendAuthorizedAsync(HttpRequestMessage request)
    {
        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            throw new InvalidOperationException("You must be signed in to use the onboarding wizard.");
        }

        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
        EnsureHttpClientBaseAddress();
        return await Http.SendAsync(request);
    }

    private void EnsureHttpClientBaseAddress()
    {
        if (Http.BaseAddress is null)
        {
            Http.BaseAddress = new Uri(Navigation.BaseUri);
        }
    }

    private sealed record WizardStep(WizardStepType Type, string Title, string Description);

    private enum WizardStepType
    {
        Plan,
        Security,
        Upload
    }

    private static readonly IReadOnlyList<SubscriptionPlanDto> DefaultPlans =
    [
        new SubscriptionPlanDto(
            "Free",
            "Free Tier",
            "Try Evermail with a single mailbox and 30-day retention.",
            0,
            0,
            "EUR",
            1,
            1,
            1,
            1,
            false,
            new[] { "1 mailbox indexed", "1 GB encrypted storage", "1 GB upload cap", "30-day retention" }),
        new SubscriptionPlanDto(
            "Pro",
            "Professional",
            "For founders and consultants juggling multiple archives plus AI summaries.",
            9,
            90,
            "EUR",
            5,
            5,
            1,
            int.MaxValue,
            true,
            new[] { "Unlimited mailboxes", "AI thread summaries", "5 GB encrypted storage", "1-year retention" }),
        new SubscriptionPlanDto(
            "Team",
            "Team",
            "Finance, Legal, and Ops teams that need shared access and longer retention.",
            29,
            290,
            "EUR",
            500,
            10,
            5,
            int.MaxValue,
            false,
            new[] { "5 seats included", "Shared read-only vaults", "500 GB storage", "2-year retention" })
    ];
}

