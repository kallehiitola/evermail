@page "/onboarding"
@rendermode InteractiveServer
@using System.Collections.Generic
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Web
@using System.Linq
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Tenant
@using Evermail.WebApp.Components.Shared
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Tenant Onboarding - Evermail</PageTitle>

<div class="home-wrapper onboarding-wrapper">
    <section class="modern-card onboarding-hero mb-4">
        <div>
            <p class="hero-eyebrow text-uppercase mb-2">Secure archive setup</p>
            <h1>Bring every mailbox back within reach.</h1>
            <p class="hero-subtext mb-0">
                Upload Gmail/Outlook exports, unlock lightning-fast search and AI summaries, and keep compliance calm—the entire pipeline stays zero-access.
            </p>
        </div>
        <div class="onboarding-progress">
            @if (_canManageOnboarding)
            {
                <div class="onboarding-progress__summary">
                    <p class="mb-2 text-white-50 fw-semibold">Complete each step below to unlock Evermail.</p>
                    <div class="progress">
                        <div class="progress-bar" style="width:@CompletionPercent%" role="progressbar"
                             aria-valuenow="@CompletionPercent" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-white-50 d-block mt-2">@CompletionPercent.ToString("0")% complete</small>
                </div>
            }
            else
            {
                <div class="onboarding-progress__readonly">
                    <p class="mb-2">
                        Spin up your workspace to run the guided wizard, or explore tiers and security modes below.
                    </p>
                    <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-light btn-sm" href="/register">Create workspace</a>
                        <a class="btn btn-outline-light btn-sm" href="/login">Sign in</a>
                    </div>
                </div>
            }
        </div>
    </section>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger mb-4" role="alert">
            @_errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(_statusMessage))
    {
        <div class="alert alert-success mb-4" role="alert">
            @_statusMessage
        </div>
    }

    @if (!_canManageOnboarding)
    {
        <section class="modern-card onboarding-readonly">
            <div class="onboarding-plans__intro text-center text-lg-start">
                <p class="hero-eyebrow text-uppercase mb-1">Explore the plans</p>
                <h2 class="mb-2">Choose your archive & insight combo</h2>
                <p class="text-muted mb-4">
                    All tiers include encrypted uploads, instant search, and read-only sharing. Upgrade whenever your storage, AI, or retention needs expand.
                </p>
                <div class="billing-toggle billing-toggle--inline mt-3">
                    <button type="button"
                            class="billing-toggle__option @(!_showAnnualBilling ? "is-active" : null)"
                            @onclick="() => SetBillingMode(false)">
                        Monthly
                    </button>
                    <button type="button"
                            class="billing-toggle__option @(_showAnnualBilling ? "is-active" : null)"
                            @onclick="() => SetBillingMode(true)">
                        Annual <span class="text-success fw-semibold ms-1">Save more</span>
                    </button>
                </div>
            </div>
            <div class="onboarding-plans__grid mt-4">
                @RenderPlanGrid(readOnly: true, enableWizardCta: true)
            </div>
        </section>
    }
    else
    {
        <section class="modern-card onboarding-layout">
            <div class="onboarding-timeline mb-4">
                <div class="onboarding-timeline__rail">
                    @for (var i = 0; i < _steps.Count; i++)
                    {
                        var step = _steps[i];
                        var isActive = i == _currentStepIndex;
                        var isComplete = IsStepComplete(step);
                        <button type="button"
                                class="timeline-node @(isActive ? "is-active" : null) @(isComplete ? "is-complete" : null)"
                                @onclick="@(() => SetCurrentStep(i))">
                            <span class="timeline-node__marker">
                                <span class="timeline-node__index">@((i + 1).ToString("00"))</span>
                            </span>
                            <span class="timeline-node__content">
                                <span class="timeline-node__title">@step.Title</span>
                                <span class="timeline-node__desc">@step.Description</span>
                            </span>
                        </button>
                    }
                </div>
            </div>

            <div class="wizard-stage">
                @if (_isLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-3 mb-0">Loading onboarding data…</p>
                    </div>
                }
                else
                {
                    @switch (_steps[_currentStepIndex].Type)
                    {
                        case WizardStepType.Plan:
                            @RenderPlanGrid(readOnly: false)
                            break;
                        case WizardStepType.Security:
                            @RenderSecurityStep()
                            break;
                        case WizardStepType.Billing:
                            @RenderBillingStep()
                            break;
                        default:
                            @RenderUploadStep()
                            break;
                    }
                    @RenderStageFooter()
                }
            </div>
        </section>
    }
</div>

@if (_showWizard)
{
    <div class="onboarding-modal">
        <div class="onboarding-modal__backdrop" @onclick="CloseWizard"></div>
        <div class="onboarding-modal__panel">
            <div class="onboarding-modal__header d-flex justify-content-between align-items-start">
                <div>
                    <p class="hero-eyebrow text-uppercase mb-2">Guided onboarding</p>
                    <h3 class="mb-1">Let’s configure your archive</h3>
                    <p class="text-muted mb-0">Answer two quick questions—we’ll recommend the right storage tier and security mode. You can change either any time.</p>
                </div>
                <button class="btn btn-link text-muted" type="button" @onclick="CloseWizard">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="billing-toggle billing-toggle--compact mb-3">
                <button type="button"
                        class="billing-toggle__option @(!_showAnnualBilling ? "is-active" : null)"
                        @onclick="() => SetBillingMode(false)">
                    Monthly
                </button>
                <button type="button"
                        class="billing-toggle__option @(_showAnnualBilling ? "is-active" : null)"
                        @onclick="() => SetBillingMode(true)">
                    Annual <span class="text-success fw-semibold ms-1">Save more</span>
                </button>
            </div>

            @if (_planPreselected)
            {
                var selectedPlan = FindPlan(_selectedPlan);
                <div class="wizard-plan-summary-card">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                        <div>
                            <p class="hero-eyebrow text-uppercase mb-1">Selected plan</p>
                            <h4 class="mb-1">@SelectedPlanDisplayName</h4>
                            @if (selectedPlan is not null)
                            {
                                <div class="plan-price plan-price--inline">
                                    @if (_showAnnualBilling && selectedPlan.PriceYearly > 0)
                                    {
                                        <span class="plan-price__strike">@GetMonthlyPriceLabel(selectedPlan)</span>
                                        <strong>€@selectedPlan.PriceYearly:0/year</strong>
                                        @if (!string.IsNullOrWhiteSpace(GetAnnualSavingsText(selectedPlan)))
                                        {
                                            <span class="plan-price__save">@GetAnnualSavingsText(selectedPlan)</span>
                                        }
                                    }
                                    else
                                    {
                                        <strong>@GetMonthlyPriceLabel(selectedPlan)</strong>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(GetPlanPriceCaption(selectedPlan)))
                                    {
                                        <span class="text-muted">@GetPlanPriceCaption(selectedPlan)</span>
                                    }
                                </div>
                            }
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" type="button" @onclick="JumpToPlanStep">
                            Change plan
                        </button>
                    </div>
                    @if (selectedPlan is not null)
                    {
                        <ul class="wizard-plan__features mt-3">
                            @foreach (var feature in selectedPlan.Features.Take(4))
                            {
                                <li>@feature</li>
                            }
                        </ul>
                    }
                </div>
            }
            else
            {
                <div class="wizard-plan-grid">
                    @foreach (var plan in GetActivePlans())
                    {
                        var isSelected = string.Equals(plan.Name, _selectedPlan, StringComparison.OrdinalIgnoreCase);
                        <button class="wizard-plan @(isSelected ? "is-selected" : null)"
                                type="button"
                                @onclick="@(() => SelectWizardPlan(plan.Name))">
                            <div class="wizard-plan__header">
                                <div>
                                    <p class="hero-eyebrow mb-1 text-uppercase">@plan.Name</p>
                                    <h5 class="mb-0">@plan.DisplayName</h5>
                                </div>
                                @if (plan.IsRecommended)
                                {
                                    <span class="badge bg-primary-subtle text-primary-emphasis">Recommended</span>
                                }
                            </div>
                            <p class="text-muted small mb-2 wizard-plan__description">@plan.Description</p>
                            <div class="wizard-plan__price">
                                @if (_showAnnualBilling && plan.PriceYearly > 0)
                                {
                                    <span class="plan-price__strike">@GetMonthlyPriceLabel(plan)</span>
                                    <strong>€@plan.PriceYearly:0/year</strong>
                                    @if (!string.IsNullOrWhiteSpace(GetAnnualSavingsText(plan)))
                                    {
                                        <span class="plan-price__save">@GetAnnualSavingsText(plan)</span>
                                    }
                                }
                                else
                                {
                                    <strong>@GetMonthlyPriceLabel(plan)</strong>
                                }
                                @if (!string.IsNullOrWhiteSpace(GetPlanPriceCaption(plan)))
                                {
                                    <span class="text-muted">@GetPlanPriceCaption(plan)</span>
                                }
                            </div>
                            <ul class="wizard-plan__features">
                                @foreach (var feature in plan.Features.Take(4))
                                {
                                    <li>@feature</li>
                                }
                            </ul>
                        </button>
                    }
                </div>
            }

            <ol class="wizard-flow list-unstyled">
                @for (var i = 0; i < _steps.Count; i++)
                {
                    var step = _steps[i];
                    var stateClass = IsStepComplete(step)
                        ? "is-complete"
                        : (i == _currentStepIndex ? "is-active" : string.Empty);
                    <li class="@stateClass">
                        <span>@(i + 1)</span> @step.Title
                    </li>
                }
            </ol>

            <button class="btn btn-primary btn-lg w-100" type="button" @onclick="ContinueWizardAsync" disabled="@_isWizardProcessing">
                @if (_isWizardProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Continue with @SelectedPlanDisplayName
            </button>
            <p class="text-muted text-center small mt-3 mb-0">
                Next up: lock in security, acknowledge billing, drag in Gmail/Outlook exports, and start searching within minutes.
            </p>
        </div>
    </div>
}

@code {
    private readonly List<WizardStep> _steps =
    [
        new(WizardStepType.Plan, "Pick your archive plan", "Choose the storage, AI, and retention bundle that matches your workload."),
        new(WizardStepType.Security, "Choose your security level", "Pick how much you trust Evermail, then choose Evermail-managed keys or BYOK."),
        new(WizardStepType.Billing, "Acknowledge billing", "Preview pricing and mark that you’ll connect Stripe before going live."),
        new(WizardStepType.Upload, "Upload a mailbox", "Drag Gmail/Outlook exports (or our sample file) and start searching within minutes.")
    ];

    private IReadOnlyList<SubscriptionPlanDto> _plans = Array.Empty<SubscriptionPlanDto>();
    private TenantOnboardingStatusDto? _status;
    private int _currentStepIndex;
    private int _completedSteps;
    private bool _isLoading = true;
    private bool _isSavingPlan;
    private string? _pendingPlanName;
    private string? _errorMessage;
    private string? _statusMessage;
    private WizardStepType? _requestedStep;
    private bool _isAuthenticated;
    private bool _canManageOnboarding;
    private bool _showWizard;
    private string _selectedPlan = "Pro";
    private bool _isWizardProcessing;
    private bool _showAnnualBilling;
    private bool _planPreselected;
    private string _securityPreference = "QuickStart";
    private bool _isProvisioningQuickStart;
    private bool _isUpdatingSecurityPreference;
    private bool _isUpdatingSecurityLevel;
    private bool _paymentAcknowledged;
    private DateTime? _paymentAcknowledgedAt;
    private bool _isAcknowledgingPayment;
    private string? _identityProvider;
    private string? _heroEmail;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAuthenticated = user.Identity?.IsAuthenticated == true;
        _canManageOnboarding = _isAuthenticated && (user.IsInRole("Admin") || user.IsInRole("SuperAdmin"));
        if (_isAuthenticated)
        {
            _heroEmail = user.FindFirst(ClaimTypes.Email)?.Value
                ?? user.Identity?.Name
                ?? user.FindFirst("email")?.Value;
            _identityProvider = ResolveIdentityProvider(user);
        }

        var uri = new Uri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);
        if (Enum.TryParse(query["step"], true, out WizardStepType requested))
        {
            _requestedStep = requested;
        }

        if (_canManageOnboarding)
        {
            await LoadAllAsync();
        }
        else
        {
            _plans = DefaultPlans;
            _isLoading = false;
        }
    }

    private RenderFragment RenderPlanGrid(bool readOnly, bool enableWizardCta = false) => builder =>
    {
        var plans = GetActivePlans();

        if (plans.Count == 0)
        {
            builder.AddMarkupContent(0, "<p class=\"text-muted\">No plans available right now. Please try again later.</p>");
            return;
        }

        builder.OpenElement(1, "div");
        builder.AddAttribute(2, "class", "plan-grid-wrapper");

        if (!readOnly)
        {
            builder.OpenElement(3, "div");
            builder.AddAttribute(4, "class", "plan-grid__toolbar");
            builder.OpenElement(5, "span");
            builder.AddAttribute(6, "class", "plan-grid__toolbar-text");
            builder.AddContent(7, "Need help picking a plan?");
            builder.CloseElement();
            builder.OpenElement(8, "button");
            builder.AddAttribute(9, "type", "button");
            builder.AddAttribute(10, "class", "btn btn-link btn-sm plan-grid__wizard");
            builder.AddAttribute(11, "onclick", EventCallback.Factory.Create(this, () => OpenWizard(_status?.SubscriptionTier ?? _selectedPlan)));
            builder.AddContent(12, "Run guided wizard");
            builder.CloseElement();
            builder.CloseElement();
        }

        builder.OpenElement(13, "div");
        builder.AddAttribute(14, "class", readOnly ? "plan-grid plan-grid--readonly" : "plan-grid");

        for (var i = 0; i < plans.Count; i++)
        {
            var plan = plans[i];
            var isCurrent = string.Equals(plan.Name, _status?.SubscriptionTier, StringComparison.OrdinalIgnoreCase);
            var planClasses = $"plan-card {(isCurrent ? "plan-card--current" : string.Empty)}";
            builder.OpenElement(15 + i * 30, "div");
            builder.AddAttribute(16 + i * 30, "class", planClasses);
            builder.OpenElement(17 + i * 30, "div");
            builder.AddAttribute(18 + i * 30, "class", "card h-100");
            builder.OpenElement(19 + i * 30, "div");
            builder.AddAttribute(20 + i * 30, "class", "card-body d-flex flex-column gap-3");

            builder.OpenElement(21 + i * 30, "div");
            builder.AddAttribute(22 + i * 30, "class", "d-flex justify-content-between align-items-start gap-3");
            builder.OpenElement(23 + i * 30, "div");
            builder.AddAttribute(24 + i * 30, "class", "plan-header");
            builder.OpenElement(25 + i * 30, "h5");
            builder.AddContent(26 + i * 30, plan.DisplayName);
            builder.CloseElement();
            builder.OpenElement(27 + i * 30, "p");
            builder.AddAttribute(28 + i * 30, "class", "text-muted small mb-0");
            builder.AddContent(29 + i * 30, plan.Description);
            builder.CloseElement();
            builder.CloseElement();
            if (plan.IsRecommended)
            {
                builder.OpenElement(30 + i * 30, "span");
                builder.AddAttribute(31 + i * 30, "class", "badge bg-primary-subtle text-primary-emphasis");
                builder.AddContent(32 + i * 30, "Most popular");
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(33 + i * 30, "div");
            builder.AddAttribute(34 + i * 30, "class", "plan-price");
            if (_showAnnualBilling && plan.PriceYearly > 0)
            {
                builder.OpenElement(35 + i * 30, "span");
                builder.AddAttribute(36 + i * 30, "class", "plan-price__strike");
                builder.AddContent(37 + i * 30, GetMonthlyPriceLabel(plan));
                builder.CloseElement();

                builder.OpenElement(38 + i * 30, "strong");
                builder.AddContent(39 + i * 30, $"€{plan.PriceYearly:0}/year");
                builder.CloseElement();

                var savings = GetAnnualSavingsText(plan);
                if (!string.IsNullOrWhiteSpace(savings))
                {
                    builder.OpenElement(40 + i * 30, "span");
                    builder.AddAttribute(41 + i * 30, "class", "plan-price__save");
                    builder.AddContent(42 + i * 30, savings);
                    builder.CloseElement();
                }
            }
            else
            {
                builder.OpenElement(35 + i * 30, "strong");
                builder.AddContent(36 + i * 30, GetMonthlyPriceLabel(plan));
                builder.CloseElement();
            }

            var caption = GetPlanPriceCaption(plan);
            if (!string.IsNullOrWhiteSpace(caption))
            {
                builder.OpenElement(43 + i * 30, "small");
                builder.AddAttribute(44 + i * 30, "class", "text-muted d-block");
                builder.AddContent(45 + i * 30, caption);
                builder.CloseElement();
            }

            builder.CloseElement();

            builder.OpenElement(41 + i * 30, "ul");
            builder.AddAttribute(42 + i * 30, "class", "plan-feature-list");
            foreach (var feature in plan.Features.Take(6))
            {
                builder.OpenElement(43 + i * 30, "li");
                builder.AddMarkupContent(44 + i * 30, "<i class=\"bi bi-check2 text-success me-2\"></i>");
                builder.AddContent(45 + i * 30, feature);
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(46 + i * 30, "div");
            builder.AddAttribute(47 + i * 30, "class", "mt-auto");
            builder.OpenElement(48 + i * 30, "button");
            var buttonClass = readOnly ? "btn btn-primary w-100" : $"btn {(isCurrent ? "btn-outline-primary" : "btn-primary")} w-100";
            builder.AddAttribute(49 + i * 30, "class", buttonClass);
            var isSaving = !readOnly && _isSavingPlan && _pendingPlanName == plan.Name;
            builder.AddAttribute(50 + i * 30, "disabled", isSaving);
            builder.AddAttribute(51 + i * 30, "type", "button");
            if (readOnly && enableWizardCta)
            {
                builder.AddAttribute(52 + i * 30, "onclick", EventCallback.Factory.Create(this, () => OpenWizard(plan.Name)));
            }
            else if (!readOnly)
            {
                builder.AddAttribute(52 + i * 30, "onclick", EventCallback.Factory.Create(this, () => SelectPlanAsync(plan)));
            }
            if (isSaving)
            {
                builder.AddMarkupContent(53 + i * 30, "<span class=\"spinner-border spinner-border-sm me-2\" role=\"status\"></span>");
            }
            var buttonLabel = readOnly
                ? $"Start {plan.DisplayName}"
                : (isCurrent ? "Stay on this plan" : "Select plan");
            builder.AddContent(54 + i * 30, buttonLabel);
            builder.CloseElement();
            builder.CloseElement();

            builder.CloseElement();
            builder.CloseElement();
            builder.CloseElement();
        }

        builder.CloseElement(); // plan-grid
        builder.CloseElement(); // wrapper
    };


    private string SelectedPlanDisplayName => FindPlan(_selectedPlan)?.DisplayName ?? "Free Tier";

    private IReadOnlyList<SubscriptionPlanDto> GetActivePlans() => _plans.Count > 0 ? _plans : DefaultPlans;

    private SubscriptionPlanDto? FindPlan(string? planName) =>
        GetActivePlans().FirstOrDefault(p => string.Equals(p.Name, planName, StringComparison.OrdinalIgnoreCase));

    private void OpenWizard(string? planName)
    {
        var plans = GetActivePlans();
        var targetPlan = planName
                         ?? plans.FirstOrDefault(p => p.IsRecommended)?.Name
                         ?? plans.First().Name;
        _selectedPlan = targetPlan;
        _planPreselected = !string.IsNullOrWhiteSpace(planName);
        _currentStepIndex = _planPreselected ? Math.Min(1, _steps.Count - 1) : 0;
        _showWizard = true;
    }

    private void CloseWizard() => _showWizard = false;

    private void SelectWizardPlan(string planName) => _selectedPlan = planName;

    private void JumpToPlanStep()
    {
        _planPreselected = false;
        _currentStepIndex = 0;
    }

    private void SetBillingMode(bool annual)
    {
        if (_showAnnualBilling == annual)
        {
            return;
        }

        _showAnnualBilling = annual;
        StateHasChanged();
    }

    private string GetMonthlyPriceLabel(SubscriptionPlanDto plan) =>
        plan.PriceMonthly == 0 ? "Free" : $"€{plan.PriceMonthly:0}/month";

    private string? GetPlanPriceCaption(SubscriptionPlanDto plan)
    {
        if (_showAnnualBilling)
        {
            return plan.PriceYearly > 0 ? "Billed annually" : "Annual billing not available";
        }

        return plan.PriceMonthly > 0 ? "Billed monthly" : null;
    }

    private string? GetAnnualSavingsText(SubscriptionPlanDto plan)
    {
        if (plan.PriceMonthly <= 0 || plan.PriceYearly is null || plan.PriceYearly <= 0)
        {
            return null;
        }

        var yearly = plan.PriceYearly.Value;
        var monthlyAnnualized = plan.PriceMonthly * 12m;
        if (monthlyAnnualized <= 0 || yearly >= monthlyAnnualized)
        {
            return null;
        }

        var discount = 1m - (yearly / monthlyAnnualized);
        var percent = Math.Round(discount * 100m);

        return percent > 0 ? $"Save {percent:0}%" : null;
    }

    private async Task ContinueWizardAsync()
    {
        if (_isWizardProcessing)
        {
            return;
        }

        _isWizardProcessing = true;
        try
        {
            if (_canManageOnboarding)
            {
                var plan = FindPlan(_selectedPlan);
                if (plan is not null)
                {
                    await SelectPlanAsync(plan);
                }
                _showWizard = false;
            }
            else
            {
                var query = string.IsNullOrWhiteSpace(_selectedPlan)
                    ? string.Empty
                    : $"?plan={Uri.EscapeDataString(_selectedPlan)}";
                _showWizard = false;
                Navigation.NavigateTo($"/register{query}", forceLoad: true);
            }
        }
        finally
        {
            _isWizardProcessing = false;
        }
    }

    private RenderFragment RenderSecurityStep() => @<div class="security-step">
        <div class="alert @(_status?.EncryptionConfigured == true ? "alert-success" : "alert-info")">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-shield-lock fs-3"></i>
                <div>
                    <strong class="d-block">Security overview</strong>
                    <p class="mb-0 text-muted">
                        @(_status?.EncryptionConfigured == true
                            ? "Encryption is already locked down. Stay on quick-start keys or connect BYOK whenever compliance asks."
                            : "Encryption is on by default. Choose quick-start keys for instant access or flip to BYOK and keep your master key in your vault.")
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <p class="hero-eyebrow text-uppercase mb-1">Security level</p>
            <h3 class="mb-1">How much should Evermail be able to do?</h3>
            <p class="text-muted mb-0">
                Full Service unlocks the richest search and previews. Confidential Processing restricts decryption to attested workloads. Zero-Access keeps keys on the client and trades away server-side content search.
            </p>
        </div>

        <div class="security-choice-grid">
            <article class="security-choice @(IsFullServiceLevelSelected ? "is-selected" : null)">
                <span class="security-choice__badge text-uppercase">Full search</span>
                <h4>Full Service</h4>
                <p class="text-muted">
                    Best experience: server-side search, message rendering, attachments preview, and AI features.
                </p>
                <ul class="security-choice__highlights">
                    <li>Fastest, most accurate search across the full archive.</li>
                    <li>Requires trusting Evermail services more.</li>
                    <li>Still supports BYOK if you want key ownership.</li>
                </ul>
                <button class="btn btn-outline-primary"
                        disabled="@_isUpdatingSecurityLevel"
                        @onclick="SelectFullServiceLevelAsync">
                    @if (_isUpdatingSecurityLevel && IsFullServiceLevelSelected)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    @(IsFullServiceLevelSelected ? "Selected" : "Use Full Service")
                </button>
            </article>

            <article class="security-choice @(IsConfidentialLevelSelected ? "is-selected" : null)">
                <span class="security-choice__badge text-uppercase">Attested compute</span>
                <h4>Confidential Processing</h4>
                <p class="text-muted">
                    Decryption is only permitted inside a Trusted Execution Environment (TEE) with auditable policy gating.
                </p>
                <ul class="security-choice__highlights">
                    <li>Supports Evermail-managed keys or customer BYOK.</li>
                    <li>Restricts decryption to approved workers.</li>
                    <li>Requires confidential compute deployment.</li>
                </ul>
                <button class="btn btn-outline-primary"
                        disabled="@_isUpdatingSecurityLevel"
                        @onclick="SelectConfidentialLevelAsync">
                    @if (_isUpdatingSecurityLevel && IsConfidentialLevelSelected)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    @(IsConfidentialLevelSelected ? "Selected" : "Use Confidential")
                </button>
            </article>

            <article class="security-choice @(IsZeroAccessLevelSelected ? "is-selected" : null)">
                <span class="security-choice__badge text-uppercase">Strict</span>
                <h4>Zero-Access</h4>
                <p class="text-muted">
                    Evermail stores ciphertext only. Your mailbox key never leaves the client in normal operation.
                </p>
                <ul class="security-choice__highlights">
                    <li>Server-side content search is not available.</li>
                    <li>Client-side filters + local search index (optional) power discovery.</li>
                    <li>Requires BYOK bundle setup and careful key recovery hygiene.</li>
                </ul>
                <button class="btn btn-outline-primary"
                        disabled="@_isUpdatingSecurityLevel"
                        @onclick="SelectZeroAccessLevelAsync">
                    @if (_isUpdatingSecurityLevel && IsZeroAccessLevelSelected)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    @(IsZeroAccessLevelSelected ? "Selected" : "Use Zero-Access")
                </button>
            </article>
        </div>

        <hr class="my-4" />

        <div class="security-choice-grid">
            <article class="security-choice @(IsQuickStartSelected ? "is-selected" : null)">
                <span class="security-choice__badge text-uppercase">Fast start</span>
                <h4>Evermail-managed keys</h4>
                <p class="text-muted">
                    Ship demos and internal pilots in minutes. We host the workspace key, rotate it automatically, and keep ingestion inside confidential compute.
                </p>
                <ul class="security-choice__highlights">
                    <li>Best for debugging and private beta runs.</li>
                    <li>No Azure/AWS permissions required.</li>
                    <li>Switch to BYOK later without re-uploading.</li>
                </ul>
                <button class="btn btn-primary"
                        disabled="@(_isProvisioningQuickStart || (IsQuickStartSelected && _status?.EncryptionConfigured == true))"
                        @onclick="EnableQuickStartAsync">
                    @if (_isProvisioningQuickStart)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    @(IsQuickStartSelected ? "Keys provisioned" : "Use quick-start keys")
                </button>
            </article>

            <article class="security-choice @(IsByokSelected ? "is-selected" : null)">
                <span class="security-choice__badge text-uppercase">Maximum control</span>
                <h4>Bring your own key (BYOK)</h4>
                <p class="text-muted">
                    Point Evermail at your Azure Key Vault, AWS KMS role, or generate an offline bundle as a simple “bring-your-own-key” on-ramp.
                </p>
                <ul class="security-choice__highlights">
                    <li>Plaintext keys are generated in your browser; you keep the recovery bundle offline.</li>
                    <li>Attach attested workloads + Secure Key Release in Phase 2.</li>
                    <li>Inline lab helps you prototype today—swap to Azure/AWS later.</li>
                </ul>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-primary"
                            disabled="@_isUpdatingSecurityPreference"
                            @onclick="SelectByokAsync">
                        @if (_isUpdatingSecurityPreference)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        @(IsByokSelected ? "BYOK selected" : "Plan for BYOK")
                    </button>
                    <a class="btn btn-link text-decoration-none p-0" href="/admin/encryption?onboarding=1">
                        Configure vault access
                    </a>
                </div>

                @if (IsByokSelected)
                {
                    <div class="inline-byok-panel mt-3">
                        <OfflineByokInline OnBundleUploaded="RefreshStatusAsync" />
                    </div>
                }
            </article>
        </div>

        <div class="security-step__links d-flex flex-wrap gap-2 mt-3">
            <a class="btn btn-primary" href="/admin/encryption?onboarding=1">
                <i class="bi bi-key-fill me-2"></i>Open encryption settings
            </a>
            <a class="btn btn-outline-secondary" href="/admin/offline-byok">
                <i class="bi bi-cloud-slash me-2"></i>Offline BYOK lab
            </a>
            <button class="btn btn-link p-0 text-decoration-none" type="button" @onclick="RefreshStatusAsync">
                I've updated my keys, refresh status
            </button>
        </div>
    </div>;

    private RenderFragment RenderBillingStep() => @<div class="billing-step">
        <div class="mb-3">
            <p class="hero-eyebrow text-uppercase mb-1">Billing preview</p>
            <h3 class="mb-1">Acknowledge pricing before importing</h3>
            <p class="text-muted mb-0">
                Real billing hooks arrive with Stripe, but mark this step complete so we know you’ve seen the plan limits and cost guidance.
            </p>
        </div>
        @{
            var planName = _status?.SubscriptionTier ?? _selectedPlan;
            var plan = FindPlan(planName);
            var planDisplay = plan?.DisplayName ?? planName;
            var planDescription = plan?.Description ?? "Keep archives searchable without overpaying for legacy mailboxes.";
        }
        <div class="billing-step__card">
            <div>
                <p class="hero-eyebrow text-uppercase mb-1">Selected plan</p>
                <h4 class="mb-1">@planDisplay</h4>
                <p class="text-muted mb-0">@planDescription</p>
            </div>
            <div class="billing-step__price text-end">
                <strong>@GetMonthlyPriceLabel(plan ?? FindPlan(_selectedPlan) ?? DefaultPlans.First())</strong>
                <div class="text-muted small">
                    @GetPlanPriceCaption(plan ?? FindPlan(_selectedPlan) ?? DefaultPlans.First()) ?? "Billed monthly"
                </div>
            </div>
        </div>

        @if (_paymentAcknowledged)
        {
            <div class="alert alert-success mt-3">
                <i class="bi bi-check-circle-fill me-2"></i>
                Billing acknowledged @(_paymentAcknowledgedAt?.ToLocalTime().ToString("MMM d, yyyy 'at' HH:mm") ?? "just now").
            </div>
        }
        else
        {
            <div class="billing-step__actions mt-3 d-flex flex-wrap gap-2">
                <button class="btn btn-primary"
                        type="button"
                        disabled="@_isAcknowledgingPayment"
                        @onclick="AcknowledgePaymentAsync">
                    @if (_isAcknowledgingPayment)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    Mark as acknowledged
                </button>
                <button class="btn btn-outline-secondary" type="button" disabled>
                    Connect Stripe (coming soon)
                </button>
            </div>
        }
    </div>;

    private RenderFragment RenderStageFooter() => @<div class="wizard-stage__footer">
        @{
            var (eyebrow, title, body, isComplete) = GetCurrentStepStatusCopy();
        }
        <div class="wizard-stage__status @(isComplete ? "is-complete" : "is-pending")">
            <p class="hero-eyebrow text-uppercase mb-1">@eyebrow</p>
            <h4 class="mb-1">@title</h4>
            <p class="text-muted mb-0">@body</p>
            @if (!isComplete)
            {
                <p class="text-muted small mb-0">
                    You can still preview upcoming steps with the buttons below—we’ll keep redirecting you here until this one is finished.
                </p>
            }
        </div>
        <div class="wizard-stage__nav">
            <button type="button"
                    class="btn btn-outline-secondary"
                    disabled="@(!HasPreviousStep)"
                    @onclick="GoToPreviousStep">
                <i class="bi bi-arrow-left me-2"></i>Previous step
            </button>
            @if (HasNextStep)
            {
                <button type="button"
                        class="btn btn-primary"
                        @onclick="GoToNextStep">
                    Continue to @_steps[_currentStepIndex + 1].Title
                </button>
            }
            else
            {
                <a class="btn btn-primary" href="/upload">
                    Go to uploader
                </a>
            }
        </div>
    </div>;

    private RenderFragment RenderUploadStep() => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "upload-step");
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "mb-3");
        builder.AddMarkupContent(4, "<p class=\"hero-eyebrow mb-1\">Mailbox ingestion</p>");
        builder.OpenElement(5, "h3");
        builder.AddContent(6, "Bring in your first archive");
        builder.CloseElement();
        builder.CloseElement();

        builder.OpenElement(7, "ul");
        builder.AddAttribute(8, "class", "upload-checklist");
        builder.AddMarkupContent(9, "<li><i class=\"bi bi-check2-circle text-success me-2\"></i>Drag & drop Gmail Takeout (.mbox) or Outlook exports (.zip) up to your plan limit.</li>");
        builder.AddMarkupContent(10, "<li><i class=\"bi bi-check2-circle text-success me-2\"></i>Everything streams straight to our Azure Blob Storage—no plaintext ever hits disk.</li>");
        builder.AddMarkupContent(11, "<li><i class=\"bi bi-check2-circle text-success me-2\"></i>Need a dry run? Use our sample archive or <code>scripts/generate-test-mbox.py</code> to simulate a real ingestion.</li>");
        builder.CloseElement();

        builder.OpenElement(12, "div");
        builder.AddAttribute(13, "class", "d-flex flex-wrap gap-3 align-items-center mt-3");
        builder.AddMarkupContent(14, "<a class=\"btn btn-primary btn-lg\" href=\"/upload\"><i class=\"bi bi-cloud-upload-fill me-2\"></i>Go to uploader</a>");
        builder.OpenElement(15, "span");
        builder.AddAttribute(16, "class", "text-muted small");
        builder.AddContent(17, "Keep this tab open while uploading so you can track ingestion in real-time.");
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
    };

    private async Task LoadAllAsync()
    {
        if (!_canManageOnboarding)
        {
            _plans = DefaultPlans;
            _isLoading = false;
            return;
        }

        _isLoading = true;
        _errorMessage = null;
        try
        {
            await Task.WhenAll(LoadPlansAsync(), LoadStatusAsync());
            SetInitialStep();
            UpdateCompletionCount();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load onboarding data: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPlansAsync()
    {
        if (!_canManageOnboarding)
        {
            _plans = DefaultPlans;
            return;
        }

        var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/plans"));
        var response = await SendAuthorizedAsync(request);

        if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            _errorMessage = "Session expired. Please sign in again.";
            _plans = Array.Empty<SubscriptionPlanDto>();
            return;
        }

        var payload = await response.Content.ReadFromJsonAsync<ApiResponse<IReadOnlyList<SubscriptionPlanDto>>>();
        if (payload?.Success == true && payload.Data is not null)
        {
            _plans = payload.Data;
        }
        else
        {
            _plans = Array.Empty<SubscriptionPlanDto>();
            _errorMessage = payload?.Error ?? "Unable to load subscription plans.";
        }
    }

    private async Task LoadStatusAsync()
    {
        if (!_canManageOnboarding)
        {
            _status = null;
            return;
        }

        var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/onboarding/status"));
        var response = await SendAuthorizedAsync(request);

        if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            _errorMessage = "Session expired. Please sign in again.";
            _status = null;
            return;
        }

        var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantOnboardingStatusDto>>();

        if (payload?.Success == true && payload.Data is not null)
        {
            _status = payload.Data;
            _securityPreference = NormalizeSecurityPreference(payload.Data.SecurityPreference);
            _paymentAcknowledged = payload.Data.PaymentAcknowledged;
            _paymentAcknowledgedAt = payload.Data.PaymentAcknowledgedAt;
            if (string.IsNullOrWhiteSpace(_identityProvider) && !string.IsNullOrWhiteSpace(payload.Data.IdentityProvider))
            {
                _identityProvider = payload.Data.IdentityProvider;
            }
            UpdateCompletionCount();
        }
        else
        {
            _status = null;
            _errorMessage = payload?.Error ?? "Unable to load onboarding status.";
            _securityPreference = "QuickStart";
            _paymentAcknowledged = false;
            _paymentAcknowledgedAt = null;
            UpdateCompletionCount();
        }
    }

    private void SetInitialStep()
    {
        if (_requestedStep.HasValue)
        {
            var requestedIndex = _steps.FindIndex(s => s.Type == _requestedStep.Value);
            if (requestedIndex >= 0)
            {
                _currentStepIndex = requestedIndex;
                _requestedStep = null;
                return;
            }
        }

        var firstIncomplete = _steps.FindIndex(step => !IsStepComplete(step));
        _currentStepIndex = firstIncomplete >= 0 ? firstIncomplete : _steps.Count - 1;
    }

    private void SetCurrentStep(int index)
    {
        if (index >= 0 && index < _steps.Count)
        {
            _currentStepIndex = index;
            StateHasChanged();
        }
    }

    private void UpdateCompletionCount() =>
        _completedSteps = _steps.Count(step => IsStepComplete(step));

    private async Task SelectPlanAsync(SubscriptionPlanDto plan)
    {
        if (!_canManageOnboarding)
        {
            return;
        }

        _isSavingPlan = true;
        _pendingPlanName = plan.Name;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/subscription"))
            {
                Content = JsonContent.Create(new SelectSubscriptionPlanRequest(plan.Name))
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true)
            {
                await LoadStatusAsync();
                SetInitialStep();
                _statusMessage = $"Subscription updated to {plan.DisplayName}.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to update subscription.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to update subscription: {ex.Message}";
        }
        finally
        {
            _isSavingPlan = false;
            _pendingPlanName = null;
        }
    }

    private async Task RefreshStatusAsync()
    {
        if (!_canManageOnboarding)
        {
            return;
        }

        await LoadStatusAsync();
    }

    private bool IsStepComplete(WizardStep step) => step.Type switch
    {
        WizardStepType.Plan => _status?.PlanConfirmed == true,
        WizardStepType.Security => _status?.EncryptionConfigured == true && _status?.SecurityLevelReady == true,
        WizardStepType.Billing => _paymentAcknowledged,
        WizardStepType.Upload => _status?.HasMailbox == true,
        _ => false
    };

    private bool IsCurrentStepComplete => _steps.Count > 0 && IsStepComplete(_steps[_currentStepIndex]);

    private bool HasPreviousStep => _currentStepIndex > 0;

    private bool HasNextStep => _currentStepIndex < _steps.Count - 1;

    private void GoToPreviousStep()
    {
        if (HasPreviousStep)
        {
            _currentStepIndex--;
        }
    }

    private void GoToNextStep()
    {
        if (HasNextStep)
        {
            _currentStepIndex++;
        }
    }

    private (string Eyebrow, string Title, string Body, bool Complete) GetCurrentStepStatusCopy()
    {
        if (_steps.Count == 0)
        {
            return ("Step status", "Loading…", "Hang tight while we load your onboarding progress.", false);
        }

        var step = _steps[_currentStepIndex];
        var complete = IsStepComplete(step);

        return step.Type switch
        {
            WizardStepType.Plan when complete => ("Step complete", "Plan confirmed", "You can revisit Settings → Billing anytime to upgrade or downgrade.", true),
            WizardStepType.Plan => ("Choose a plan", "Lock in your workspace limits", "Pick the storage, AI, and retention bundle that matches your pilot. This unlocks security, billing, and uploads.", false),

            WizardStepType.Security when complete => ("Step complete", "Encryption locked down", "Keys are ready. You can reconfigure or rotate them from the Encryption page whenever compliance asks.", true),
            WizardStepType.Security => ("Secure your tenant", "Choose security level + finish key setup", "Pick Full Service / Confidential / Zero-Access, then complete the key setup we require for that mode. We’ll keep routing you here until the selection is ready.", false),

            WizardStepType.Billing when complete => ("Step complete", "Billing acknowledged", "We’ll remind you to hook up Stripe when checkout launches. For now you’re cleared to keep importing.", true),
            WizardStepType.Billing => ("Acknowledge billing", "Confirm you’ve seen the pricing", "Click “Mark as acknowledged.” It’s just a placeholder until live billing arrives, but it keeps the checklist tidy.", false),

            WizardStepType.Upload when complete => ("Step complete", "Mailbox uploaded", "Great! You can add more archives anytime from the uploader.", true),
            WizardStepType.Upload => ("Upload a mailbox", "Import at least one archive", "Use the upload page or sample data to finish onboarding. We need one successful ingestion to close the loop.", false),

            _ => ("Step status", "Keep going", "Work through each card, then continue below.", complete)
        };
    }

    private bool IsQuickStartSelected => string.Equals(_securityPreference, "QuickStart", StringComparison.OrdinalIgnoreCase);

    private bool IsByokSelected => string.Equals(_securityPreference, "BYOK", StringComparison.OrdinalIgnoreCase);

    private Task SelectByokAsync() => SetSecurityPreferenceAsync("BYOK");

    private bool IsFullServiceLevelSelected => string.Equals(_status?.SecurityLevel, "FullService", StringComparison.OrdinalIgnoreCase);

    private bool IsConfidentialLevelSelected => string.Equals(_status?.SecurityLevel, "Confidential", StringComparison.OrdinalIgnoreCase);

    private bool IsZeroAccessLevelSelected => string.Equals(_status?.SecurityLevel, "ZeroAccess", StringComparison.OrdinalIgnoreCase);

    private Task SelectFullServiceLevelAsync() => SetSecurityLevelAsync("FullService");

    private Task SelectConfidentialLevelAsync() => SetSecurityLevelAsync("Confidential");

    private Task SelectZeroAccessLevelAsync() => SetSecurityLevelAsync("ZeroAccess");

    private double CompletionPercent => _steps.Count == 0
        ? 0
        : Math.Min(100, (_completedSteps / (double)_steps.Count) * 100d);

    private Uri BuildApiUri(string relativePath)
    {
        relativePath = relativePath.TrimStart('/');
        return new Uri(new Uri(Navigation.BaseUri), relativePath);
    }

    private async Task<HttpResponseMessage> SendAuthorizedAsync(HttpRequestMessage request)
    {
        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            throw new InvalidOperationException("You must be signed in to use the onboarding wizard.");
        }

        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
        return await Http.SendAsync(request);
    }

    private async Task EnableQuickStartAsync()
    {
        if (!_canManageOnboarding || _isProvisioningQuickStart)
        {
            return;
        }

        _isProvisioningQuickStart = true;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/encryption"))
            {
                Content = JsonContent.Create(new UpsertTenantEncryptionSettingsRequest("EvermailManaged", null, null))
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantEncryptionSettingsDto>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true)
            {
                _securityPreference = "QuickStart";
                await LoadStatusAsync();
                _statusMessage = "Quick-start keys provisioned. You can upload immediately.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to provision quick-start keys.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to provision quick-start keys: {ex.Message}";
        }
        finally
        {
            _isProvisioningQuickStart = false;
        }
    }

    private async Task SetSecurityPreferenceAsync(string mode)
    {
        if (!_canManageOnboarding || _isUpdatingSecurityPreference)
        {
            return;
        }

        var normalized = NormalizeSecurityPreference(mode);
        if (string.Equals(_securityPreference, normalized, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        _isUpdatingSecurityPreference = true;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/onboarding/security"))
            {
                Content = JsonContent.Create(new SetSecurityPreferenceRequest(normalized))
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<SecurityPreferenceResponse>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true)
            {
                _securityPreference = payload.Data?.SecurityPreference ?? normalized;
                _statusMessage = normalized == "BYOK"
                    ? "BYOK preference saved. Finish Azure/AWS wiring or use the inline generator below."
                    : "Security preference reset to quick-start keys.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to update security preference.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to update security preference: {ex.Message}";
        }
        finally
        {
            _isUpdatingSecurityPreference = false;
        }
    }

    private async Task SetSecurityLevelAsync(string level)
    {
        if (!_canManageOnboarding || _isUpdatingSecurityLevel)
        {
            return;
        }

        _errorMessage = null;
        _statusMessage = null;
        _isUpdatingSecurityLevel = true;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/security-level"))
            {
                Content = JsonContent.Create(new SetSecurityLevelRequest(level))
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<SecurityLevelResponse>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true)
            {
                await LoadStatusAsync();
                _statusMessage = $"Security level set to {payload.Data?.SecurityLevel ?? level}.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to update security level.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to update security level: {ex.Message}";
        }
        finally
        {
            _isUpdatingSecurityLevel = false;
        }
    }

    private async Task AcknowledgePaymentAsync()
    {
        if (!_canManageOnboarding || _isAcknowledgingPayment || _paymentAcknowledged)
        {
            return;
        }

        _isAcknowledgingPayment = true;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/onboarding/payment"))
            {
                Content = JsonContent.Create(new PaymentAcknowledgementRequest(true))
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<PaymentAcknowledgementResponse>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true)
            {
                _paymentAcknowledged = true;
                _paymentAcknowledgedAt = payload.Data?.PaymentAcknowledgedAt ?? DateTime.UtcNow;
                UpdateCompletionCount();
                _statusMessage = "Billing acknowledged. We’ll prompt you once Stripe checkout is live.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to acknowledge billing.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to acknowledge billing: {ex.Message}";
        }
        finally
        {
            _isAcknowledgingPayment = false;
        }
    }

    private static string NormalizeSecurityPreference(string? mode) =>
        string.Equals(mode, "BYOK", StringComparison.OrdinalIgnoreCase) ? "BYOK" : "QuickStart";

    private static string? ResolveIdentityProvider(ClaimsPrincipal user)
    {
        if (user.Identity?.IsAuthenticated != true)
        {
            return null;
        }

        var provider = user.FindFirst("idp")?.Value
            ?? user.FindFirst("http://schemas.microsoft.com/identity/claims/identityprovider")?.Value
            ?? user.Identity?.AuthenticationType;

        if (string.IsNullOrWhiteSpace(provider))
        {
            return null;
        }

        if (provider.Contains("google", StringComparison.OrdinalIgnoreCase))
        {
            return "Google";
        }

        if (provider.Contains("microsoft", StringComparison.OrdinalIgnoreCase) ||
            provider.Contains("live", StringComparison.OrdinalIgnoreCase))
        {
            return "Microsoft";
        }

        return provider;
    }

    private sealed record WizardStep(WizardStepType Type, string Title, string Description);

    private enum WizardStepType
    {
        Plan,
        Security,
        Billing,
        Upload
    }

    private static readonly IReadOnlyList<SubscriptionPlanDto> DefaultPlans =
    [
        new SubscriptionPlanDto(
            "Free",
            "Free Tier",
            "Try Evermail with a single mailbox and 30-day retention.",
            0,
            0,
            "EUR",
            1,
            1,
            1,
            1,
            false,
            new[] { "1 mailbox indexed", "1 GB encrypted storage", "1 GB upload cap", "30-day retention" }),
        new SubscriptionPlanDto(
            "Pro",
            "Professional",
            "For founders and consultants juggling multiple archives plus AI summaries.",
            9,
            90,
            "EUR",
            5,
            5,
            1,
            int.MaxValue,
            true,
            new[] { "Unlimited mailboxes", "AI thread summaries", "5 GB encrypted storage", "1-year retention" }),
        new SubscriptionPlanDto(
            "Team",
            "Team",
            "Finance, Legal, and Ops teams that need shared access and longer retention.",
            29,
            290,
            "EUR",
            500,
            10,
            5,
            int.MaxValue,
            false,
            new[] { "5 seats included", "Shared read-only vaults", "500 GB storage", "2-year retention" })
    ];
}

