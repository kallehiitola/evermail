@page "/admin/encryption"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,SuperAdmin")]
@using System.Linq
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using System.Web
@using Evermail.Common.DTOs
@using Evermail.Common.DTOs.Tenant
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationStateService AuthStateService
@inject IJSRuntime JS

<PageTitle>Tenant Encryption - Evermail</PageTitle>

<AuthorizeView Roles="Admin,SuperAdmin">
    <Authorized Context="authState">
        <div class="container mt-4">
            @if (_isOnboardingFlow)
            {
                <div class="alert alert-primary d-flex flex-column gap-2" role="alert">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-flag-fill"></i>
                        <div>
                            <strong>Tenant security onboarding</strong>
                            <span class="text-muted">Finish these steps to enable Confidential Content Protection.</span>
                        </div>
                    </div>
                    <ol class="mb-0 ps-3">
                        <li>Pick your provider (Azure Key Vault or AWS KMS) and fill in the connection details.</li>
                        <li>Run the helper script / IAM template to grant Evermail access to your TMK.</li>
                        <li>Click <strong>Test connection</strong> until you see a ✅ success message.</li>
                    </ol>
                </div>
            }
            <div class="d-flex align-items-center gap-3 mb-3">
                <div>
                    <h1 class="mb-0">Confidential Content Protection</h1>
                    <p class="text-muted mb-0">
                        Connect your Azure Key Vault so uploads are wrapped with your key before processing.
                    </p>
                </div>
                @if (_isLoading)
                {
                    <span class="spinner-border text-primary" role="status" aria-label="Loading"></span>
                }
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @_errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <div class="alert alert-success" role="status">
                    @_statusMessage
                </div>
            }

            <div class="row g-4">
                <div class="col-xl-7">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Key management</h5>
                                    <p class="text-muted mb-0">All fields are required unless marked optional.</p>
                                </div>
                                <span class="badge bg-light text-dark text-uppercase">
                                    @_form.Provider switch
                                    {
                                        AzureProvider => "Azure",
                                        AwsProvider => "AWS",
                                        _ => "Custom"
                                    }
                                </span>
                            </div>

                            <EditForm Model="_form" OnValidSubmit="SaveAsync">
                                <DataAnnotationsValidator />

                                <div class="mb-3">
                                    <label class="form-label">Encryption provider</label>
                                    <InputSelect class="form-select" @bind-Value="_form.Provider">
                                        <option value="@AzureProvider">Evermail-managed / Azure Key Vault</option>
                                        <option value="@AwsProvider">External KMS (AWS)</option>
                                    </InputSelect>
                                        <div class="form-text">
                                            Evermail-managed keeps everything on Azure; AWS lets you keep keys in your own account for zero-access guarantees.
                                        </div>
                                </div>

                                @if (ShowAzureFields)
                                {
                                    <div class="mb-3">
                                        <label class="form-label">Key Vault URI</label>
                                        <InputText class="form-control" @bind-Value="_form.Azure.KeyVaultUri" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Key name</label>
                                        <InputText class="form-control" @bind-Value="_form.Azure.KeyVaultKeyName" />
                                        <div class="form-text">We recommend a dedicated RSA-HSM or EC-HSM key.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Key version (optional)</label>
                                        <InputText class="form-control" @bind-Value="_form.Azure.KeyVaultKeyVersion" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Azure AD tenant ID</label>
                                        <InputText class="form-control" @bind-Value="_form.Azure.KeyVaultTenantId" />
                                        <div class="form-text">Output of <code>az account show --query tenantId -o tsv</code>.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Managed identity object ID (optional)</label>
                                        <InputText class="form-control" @bind-Value="_form.Azure.ManagedIdentityObjectId" />
                                    </div>
                                }

                                @if (IsAwsProvider)
                                {
                                    <div class="alert alert-info d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div>
                                            <strong>External ID:</strong>
                                            @DisplayExternalId
                                            <div class="form-text">
                                                Add this identifier to your AWS IAM trust policy to prevent confused deputy attacks.
                                            </div>
                                        </div>
                                        <button type="button"
                                                class="btn btn-outline-light btn-sm"
                                                @onclick='@(() => CopyToClipboardAsync("External ID", DisplayExternalId))'>
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">AWS Account ID</label>
                                        <InputText class="form-control" @bind-Value="_form.Aws.AccountId" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">AWS Region</label>
                                        <InputText class="form-control" @bind-Value="_form.Aws.Region" placeholder="eu-west-1" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">KMS Key ARN</label>
                                        <InputText class="form-control" @bind-Value="_form.Aws.KmsKeyArn" />
                                        <div class="form-text">Example: <code>arn:aws:kms:eu-west-1:123456789012:key/abcd-1234</code></div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">IAM Role ARN</label>
                                        <InputText class="form-control" @bind-Value="_form.Aws.IamRoleArn" />
                                        <div class="form-text">Evermail assumes this role via AWS STS during ingestion.</div>
                                    </div>
                                }

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" disabled="@(_isSaving || _isLoading)">
                                        @_buttonText
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            @onclick="TestAsync"
                                            disabled="@(_isTesting || _isLoading)">
                                        @if (_isTesting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        Test connection
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>

                <div class="col-xl-5">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Status</h5>
                            <ul class="list-unstyled mb-4">
                                <li><strong>Provider:</strong> @ProviderDisplayName</li>
                                <li><strong>Phase:</strong> @_settings?.EncryptionPhase ?? "Not configured"</li>
                                <li><strong>Configured:</strong> @(_settings?.IsConfigured == true ? "Yes" : "No")</li>
                                <li><strong>Last verified:</strong> @_settings?.LastVerifiedAt?.ToString("u") ?? "Never"</li>
                                <li><strong>Verification note:</strong> @_settings?.LastVerificationMessage ?? "—"</li>
                                @if (IsFastStart)
                                {
                                    <li class="text-muted small">
                                        Fast Start keys are active for this tenant. Switch to BYOK at any time; uploads already in Azure/AWS history stay intact.
                                    </li>
                                }
                                @if (RecentProviderBadges.Any())
                                {
                                    <li>
                                        <strong>Providers seen:</strong>
                                        <span class="d-inline-flex flex-wrap gap-2 mt-2">
                                            @foreach (var provider in RecentProviderBadges)
                                            {
                                                <span class="badge bg-light text-dark">@GetFriendlyProvider(provider)</span>
                                            }
                                        </span>
                                    </li>
                                }
                                @if (_settings?.Aws is not null && string.Equals(_settings.Provider, AwsProvider, StringComparison.OrdinalIgnoreCase))
                                {
                                    <li><strong>AWS Account:</strong> @_settings.Aws.AccountId ?? "—"</li>
                                    <li><strong>AWS KMS Key:</strong> @_settings.Aws.KmsKeyArn ?? "—"</li>
                                    <li><strong>IAM Role:</strong> @_settings.Aws.IamRoleArn ?? "—"</li>
                                    <li><strong>External ID:</strong> @_settings.Aws.ExternalId ?? "—"</li>
                                }
                                else if (_settings?.Azure is not null)
                                {
                                    <li><strong>Key Vault:</strong> @_settings.Azure.KeyVaultUri ?? "—"</li>
                                    <li><strong>Key name:</strong> @_settings.Azure.KeyVaultKeyName ?? "—"</li>
                                }
                            </ul>

                            <div class="mt-4">
                                <h6 class="d-flex align-items-center gap-2">
                                    Setup helper
                                    <span class="badge bg-secondary">@(_activeInstructionTabDisplay)</span>
                                </h6>
                                <div class="btn-group mb-3" role="group">
                                    <button type="button"
                                            class='@GetInstructionTabClass("azure")'
                                            @onclick='() => SetInstructionTab("azure")'>
                                        Azure
                                    </button>
                                    <button type="button"
                                            class='@GetInstructionTabClass("aws")'
                                            @onclick='() => SetInstructionTab("aws")'
                                            disabled="@(ShowAzureFields)">
                                        AWS
                                    </button>
                                    <button type="button"
                                            class='@GetInstructionTabClass("offline")'
                                            @onclick='() => SetInstructionTab("offline")'>
                                        Offline BYOK
                                    </button>
                                </div>

                                @switch (_activeInstructionTab)
                                {
                                    case "azure":
                                        <div>
                                            <p class="text-muted">
                                                Run this script from your workstation (requires Azure CLI). It creates a Key Vault,
                                                generates a key, and grants your managed identity access.
                                            </p>
                                            <pre class="bg-dark text-light p-3 rounded small"><code>@AzureScriptSnippet</code></pre>
                                            <button class="btn btn-outline-secondary btn-sm"
                                                    @onclick='@(() => CopyToClipboardAsync("Azure script", AzureScriptSnippet))'>
                                                <i class="bi bi-clipboard"></i> Copy script
                                            </button>
                                        </div>
                                        break;
                                    case "aws":
                                        <div>
                                            <p class="text-muted mb-2">
                                                Paste the trust policy first, then attach the permissions policy to the IAM role you entered above.
                                            </p>
                                            <div class="mb-2">
                                                <label class="form-label fw-semibold">Trust policy</label>
                                                <pre class="bg-dark text-light p-3 rounded small"><code>@AwsTrustPolicySnippet</code></pre>
                                                <button class="btn btn-outline-secondary btn-sm"
                                                        @onclick='@(() => CopyToClipboardAsync("AWS trust policy", AwsTrustPolicySnippet))'>
                                                    <i class="bi bi-clipboard"></i> Copy trust policy
                                                </button>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label fw-semibold">Permissions policy</label>
                                                <pre class="bg-dark text-light p-3 rounded small"><code>@AwsPermissionPolicySnippet</code></pre>
                                                <button class="btn btn-outline-secondary btn-sm"
                                                        @onclick='@(() => CopyToClipboardAsync("AWS permissions policy", AwsPermissionPolicySnippet))'>
                                                    <i class="bi bi-clipboard"></i> Copy permissions policy
                                                </button>
                                            </div>
                                            <div class="alert alert-warning mt-3 mb-0">
                                                <strong>Remember:</strong> replace <code>@EvermailAwsPrincipalPlaceholder</code> with the official Evermail AWS principal
                                                when you move to production.
                                            </div>
                                        </div>
                                        break;
                                    default:
                                        <div>
                                            <p class="text-muted mb-2">
                                                Need zero-access encryption without AWS or Azure? Generate and store your own keys locally.
                                                We'll guide you through a browser-based key wrapping flow (coming soon).
                                            </p>
                                            <ul class="text-muted mb-0">
                                                <li>Generate a tenant master key in your browser (WebCrypto).</li>
                                                <li>Download an encrypted backup bundle and store it safely.</li>
                                                <li>Evermail never sees your plaintext key — you'll re-upload the wrapped blob when needed.</li>
                                            </ul>
                                        </div>
                                        break;
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mt-1">
                <div class="col-xl-7">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Key activity</h5>
                                    <p class="text-muted mb-0">Recent wrap/unwrap operations per mailbox upload (latest 20).</p>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm"
                                        @onclick="LoadHistoryAsync"
                                        disabled="@_isHistoryLoading">
                                    @if (_isHistoryLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-arrow-repeat"></i>
                                    }
                                    Refresh
                                </button>
                            </div>

                            @if (!string.IsNullOrEmpty(_historyError))
                            {
                                <div class="alert alert-warning">@_historyError</div>
                            }
                            else if (_isHistoryLoading)
                            {
                                <div class="d-flex align-items-center gap-2 text-muted">
                                    <span class="spinner-border spinner-border-sm"></span>
                                    Loading history…
                                </div>
                            }
                            else if (_history.Count == 0)
                            {
                                <p class="text-muted mb-0">No encryption events yet. Upload a mailbox to generate the first entry.</p>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col">Timestamp</th>
                                                <th scope="col">Provider</th>
                                                <th scope="col">Mailbox</th>
                                                <th scope="col">Upload</th>
                                                <th scope="col">Request ID</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var entry in _history)
                                            {
                                                <tr>
                                                    <td>@entry.CreatedAt.ToLocalTime().ToString("u")</td>
                                                    <td>
                                                        <span class="badge bg-light text-dark">@entry.Provider</span>
                                                    </td>
                                                    <td>
                                                        <code>@Truncate(entry.MailboxId.ToString(), 8)</code>
                                                    </td>
                                                    <td>
                                                        <code>@Truncate(entry.MailboxUploadId.ToString(), 8)</code>
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrWhiteSpace(entry.WrapRequestId))
                                                        {
                                                            <button class="btn btn-link p-0 text-decoration-none"
                                                                    @onclick='@(() => CopyToClipboardAsync("Wrap request ID", entry.WrapRequestId!))'>
                                                                <code>@Truncate(entry.WrapRequestId, 12)</code>
                                                                <i class="bi bi-clipboard ms-1"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">—</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-xl-5">
                    <div class="card h-100 mb-4">
                        <div class="card-body d-flex flex-column gap-3">
                            <div class="d-flex justify-content-between align-items-start gap-3">
                                <div>
                                    <h5 class="card-title mb-1">Secure Key Release policy</h5>
                                    <p class="text-muted mb-0">
                                        Stage the SKR JSON today so we can enforce attested workloads without re-onboarding later.
                                    </p>
                                </div>
                                <div class="text-end small text-muted">
                                    <div><strong>Hash:</strong> @SecureKeyReleaseHashDisplay</div>
                                    <div><strong>Configured:</strong> @SecureKeyReleaseConfiguredAtDisplay</div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(_secureKeyReleaseError))
                            {
                                <div class="alert alert-danger mb-0" role="alert">@_secureKeyReleaseError</div>
                            }
                            @if (!string.IsNullOrEmpty(_secureKeyReleaseStatus))
                            {
                                <div class="alert alert-success mb-0" role="alert">@_secureKeyReleaseStatus</div>
                            }

                            <div>
                                <label class="form-label fw-semibold d-flex align-items-center gap-2">
                                    Policy JSON
                                    @if (_isSecureKeyReleaseLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm text-secondary" role="status"></span>
                                    }
                                </label>
                                <InputTextArea class="form-control font-monospace"
                                               Rows="10"
                                               @bind-Value="_secureKeyReleaseEditor"
                                               disabled="@_isSecureKeyReleaseLoading" />
                                <div class="form-text">
                                    Paste the exact policy you apply in Azure CLI/Portal. We store the canonical JSON + SHA-256 hash for auditing.
                                </div>
                            </div>

                            <div class="d-flex flex-wrap gap-2">
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        @onclick="LoadSecureKeyReleaseTemplateAsync"
                                        disabled="@(_isSecureKeyReleaseLoading || _isSecureKeyReleaseSaving)">
                                    <i class="bi bi-file-earmark-code"></i> Load template
                                </button>
                                <button type="button"
                                        class="btn btn-primary btn-sm"
                                        @onclick="SaveSecureKeyReleaseAsync"
                                        disabled="@(_isSecureKeyReleaseLoading || _isSecureKeyReleaseSaving)">
                                    @SecureKeyReleaseButtonText
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm"
                                        @onclick="DeleteSecureKeyReleaseAsync"
                                        disabled="@(!_secureKeyReleaseConfigured || _isSecureKeyReleaseLoading || _isSecureKeyReleaseSaving)">
                                    Clear policy
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card border-dashed">
                        <div class="card-body">
                            <h5 class="card-title">Need a custom key path?</h5>
                            <p class="text-muted">
                                We're working on a “bring your own key” mode that never touches AWS or Azure.
                                Sign up for the preview and we'll notify you when the browser-based key wrapping tool ships.
                            </p>
                            <a class="btn btn-outline-primary btn-sm" href="mailto:founders@evermail.com?subject=BYOK%20Preview">
                                Join BYOK preview
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
</AuthorizeView>

@code {
    private const string AzureProvider = "AzureKeyVault";
    private const string AwsProvider = "AwsKms";
    private const string FastStartProvider = "EvermailManaged";
    private const string OfflineProvider = "Offline";

    private TenantEncryptionSettingsDto? _settings;
    private EncryptionFormModel _form = new();
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isTesting;
    private string? _statusMessage;
    private string? _errorMessage;
    private bool _isOnboardingFlow;
    private readonly List<TenantEncryptionHistoryItemDto> _history = [];
    private bool _isHistoryLoading;
    private string? _historyError;
    private string _activeInstructionTab = "azure";
    private bool _isSecureKeyReleaseLoading;
    private bool _isSecureKeyReleaseSaving;
    private string? _secureKeyReleaseStatus;
    private string? _secureKeyReleaseError;
    private string _secureKeyReleaseEditor = string.Empty;
    private SecureKeyReleasePolicyDto? _secureKeyRelease;

    private bool IsAwsProvider => string.Equals(_form.Provider, AwsProvider, StringComparison.OrdinalIgnoreCase);
    private bool ShowAzureFields => !IsAwsProvider;

    private bool IsFastStart => string.Equals(_settings?.Provider, FastStartProvider, StringComparison.OrdinalIgnoreCase);

    private string ProviderDisplayName => _settings?.Provider switch
    {
        AwsProvider => "AWS KMS (customer-managed)",
        AzureProvider => "Azure Key Vault (customer-managed)",
        FastStartProvider => "Evermail-managed (Fast Start)",
        OfflineProvider => "Offline BYOK (tenant-held)",
        _ => "Not configured"
    };

    private IEnumerable<string> RecentProviderBadges =>
        _history.Select(h => h.Provider)
            .Where(p => !string.IsNullOrWhiteSpace(p))
            .Distinct(StringComparer.OrdinalIgnoreCase);

    private static string GetFriendlyProvider(string provider) => provider switch
    {
        AwsProvider => "AWS KMS",
        AzureProvider => "Azure Key Vault",
        FastStartProvider => "Evermail-managed",
        OfflineProvider => "Offline BYOK",
        _ => provider
    };

    private bool _secureKeyReleaseConfigured => !string.IsNullOrWhiteSpace(_secureKeyRelease?.Hash);
    private string SecureKeyReleaseHashDisplay => _secureKeyReleaseConfigured ? _secureKeyRelease!.Hash! : "Not staged";
    private string SecureKeyReleaseConfiguredAtDisplay => _secureKeyRelease?.ConfiguredAt?.ToString("u") ?? "Never";
    private string SecureKeyReleaseButtonText => _isSecureKeyReleaseSaving ? "Saving..." : "Save policy";

    private string _buttonText => _isSaving
        ? "Saving..."
        : (_settings?.IsConfigured == true ? "Update settings" : "Save settings");

    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);
        _isOnboardingFlow = string.Equals(query["onboarding"], "1", StringComparison.OrdinalIgnoreCase);

        await LoadSettingsAsync();
        await LoadSecureKeyReleaseAsync();
        await LoadHistoryAsync();
    }

    private async Task LoadSettingsAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/encryption"));
            var response = await SendAuthorizedAsync(request);

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
                return;
            }

            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantEncryptionSettingsDto>>();
            if (payload?.Success == true && payload.Data is not null)
            {
                _settings = payload.Data;
                _form = EncryptionFormModel.FromDto(payload.Data);
            }
            else
            {
                _errorMessage = payload?.Error ?? "Unable to load encryption settings.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load settings: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveAsync()
    {
        _isSaving = true;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var azurePayload = ShowAzureFields
                ? new AzureTenantEncryptionUpsertDto(
                    _form.Azure.KeyVaultUri,
                    _form.Azure.KeyVaultKeyName,
                    string.IsNullOrWhiteSpace(_form.Azure.KeyVaultKeyVersion) ? null : _form.Azure.KeyVaultKeyVersion,
                    _form.Azure.KeyVaultTenantId,
                    string.IsNullOrWhiteSpace(_form.Azure.ManagedIdentityObjectId) ? null : _form.Azure.ManagedIdentityObjectId)
                : null;

            var awsPayload = IsAwsProvider
                ? new AwsTenantEncryptionUpsertDto(
                    _form.Aws.KmsKeyArn,
                    _form.Aws.IamRoleArn,
                    _form.Aws.Region,
                    _form.Aws.AccountId)
                : null;

            var request = new UpsertTenantEncryptionSettingsRequest(
                _form.Provider,
                azurePayload,
                awsPayload);

            var message = new HttpRequestMessage(HttpMethod.Put, BuildApiUri("api/v1/tenants/encryption"))
            {
                Content = JsonContent.Create(request)
            };

            var response = await SendAuthorizedAsync(message);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantEncryptionSettingsDto>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode && payload?.Success == true && payload.Data is not null)
            {
                _settings = payload.Data;
                _form = EncryptionFormModel.FromDto(payload.Data);
                _statusMessage = "Settings saved.";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Failed to save settings.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving settings: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }

        await LoadHistoryAsync();
    }

    private async Task TestAsync()
    {
        _isTesting = true;
        _statusMessage = null;
        _errorMessage = null;

        try
        {
            var message = new HttpRequestMessage(HttpMethod.Post, BuildApiUri("api/v1/tenants/encryption/test"));
            var response = await SendAuthorizedAsync(message);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<TenantEncryptionTestResultDto>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Session expired. Please sign in again.";
            }
            else if (payload?.Success == true && payload.Data is not null)
            {
                _statusMessage = $"✅ {_form.Provider} verified at {payload.Data.Timestamp:u}";
            }
            else
            {
                _errorMessage = payload?.Error ?? "Validation failed.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Validation failed: {ex.Message}";
        }
        finally
        {
            _isTesting = false;
            await LoadSettingsAsync();
            await LoadHistoryAsync();
        }
    }

    private async Task LoadHistoryAsync()
    {
        _isHistoryLoading = true;
        _historyError = null;
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/encryption/history?limit=20"));
            var response = await SendAuthorizedAsync(request);

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _historyError = "Session expired. Please sign in again.";
                return;
            }

            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<IReadOnlyList<TenantEncryptionHistoryItemDto>>>();
            _history.Clear();
            if (payload?.Success == true && payload.Data is not null)
            {
                _history.AddRange(payload.Data);
            }
            else
            {
                _historyError = payload?.Error ?? "Unable to load history.";
            }
        }
        catch (Exception ex)
        {
            _historyError = $"Failed to load history: {ex.Message}";
        }
        finally
        {
            _isHistoryLoading = false;
        }
    }

    private async Task LoadSecureKeyReleaseAsync()
    {
        _isSecureKeyReleaseLoading = true;
        _secureKeyReleaseError = null;
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/encryption/secure-key-release"));
            var response = await SendAuthorizedAsync(request);

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _secureKeyReleaseError = "Session expired. Please sign in again.";
                return;
            }

            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<SecureKeyReleasePolicyDto>>();
            if (payload?.Success == true && payload.Data is not null)
            {
                _secureKeyRelease = payload.Data;
                _secureKeyReleaseEditor = payload.Data.Policy ?? string.Empty;
            }
            else
            {
                _secureKeyRelease = new SecureKeyReleasePolicyDto(null, null, null, null);
                _secureKeyReleaseEditor = string.Empty;
                _secureKeyReleaseError = payload?.Error ?? "Unable to load Secure Key Release policy.";
            }
        }
        catch (Exception ex)
        {
            _secureKeyReleaseError = $"Failed to load Secure Key Release policy: {ex.Message}";
        }
        finally
        {
            _isSecureKeyReleaseLoading = false;
        }
    }

    private async Task LoadSecureKeyReleaseTemplateAsync()
    {
        _secureKeyReleaseError = null;
        _secureKeyReleaseStatus = null;
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, BuildApiUri("api/v1/tenants/encryption/secure-key-release/template"));
            var response = await SendAuthorizedAsync(request);

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _secureKeyReleaseError = "Session expired. Please sign in again.";
                return;
            }

            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<SecureKeyReleaseTemplateDto>>();
            if (payload?.Success == true && payload.Data is not null)
            {
                _secureKeyReleaseEditor = payload.Data.Policy;
                _secureKeyReleaseStatus = "Template loaded. Customize claims as needed before saving.";
            }
            else
            {
                _secureKeyReleaseError = payload?.Error ?? "Unable to load template.";
            }
        }
        catch (Exception ex)
        {
            _secureKeyReleaseError = $"Failed to load template: {ex.Message}";
        }
    }

    private async Task SaveSecureKeyReleaseAsync()
    {
        if (string.IsNullOrWhiteSpace(_secureKeyReleaseEditor))
        {
            _secureKeyReleaseError = "Policy JSON cannot be empty.";
            return;
        }

        _secureKeyReleaseError = null;
        _secureKeyReleaseStatus = null;
        _isSecureKeyReleaseSaving = true;

        try
        {
            var requestDto = new ConfigureSecureKeyReleaseRequest(_secureKeyReleaseEditor, _settings?.SecureKeyRelease.AttestationProvider);
            var request = new HttpRequestMessage(HttpMethod.Post, BuildApiUri("api/v1/tenants/encryption/secure-key-release"))
            {
                Content = JsonContent.Create(requestDto)
            };

            var response = await SendAuthorizedAsync(request);
            var payload = await response.Content.ReadFromJsonAsync<ApiResponse<SecureKeyReleasePolicyDto>>();

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _secureKeyReleaseError = "Session expired. Please sign in again.";
            }
            else if (payload?.Success == true && payload.Data is not null)
            {
                _secureKeyRelease = payload.Data;
                _secureKeyReleaseEditor = payload.Data.Policy ?? _secureKeyReleaseEditor;
                _secureKeyReleaseStatus = "Secure Key Release policy saved.";

                if (_settings is not null)
                {
                    _settings = _settings with
                    {
                        SecureKeyRelease = new SecureKeyReleaseDto(
                            true,
                            payload.Data.ConfiguredAt,
                            payload.Data.AttestationProvider,
                            payload.Data.Hash)
                    };
                }
            }
            else
            {
                _secureKeyReleaseError = payload?.Error ?? "Failed to save policy.";
            }
        }
        catch (Exception ex)
        {
            _secureKeyReleaseError = $"Failed to save policy: {ex.Message}";
        }
        finally
        {
            _isSecureKeyReleaseSaving = false;
        }
    }

    private async Task DeleteSecureKeyReleaseAsync()
    {
        _secureKeyReleaseError = null;
        _secureKeyReleaseStatus = null;
        _isSecureKeyReleaseSaving = true;

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Delete, BuildApiUri("api/v1/tenants/encryption/secure-key-release"));
            var response = await SendAuthorizedAsync(request);

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _secureKeyReleaseError = "Session expired. Please sign in again.";
            }
            else if (response.IsSuccessStatusCode)
            {
                _secureKeyRelease = new SecureKeyReleasePolicyDto(null, null, null, null);
                _secureKeyReleaseEditor = string.Empty;
                _secureKeyReleaseStatus = "Secure Key Release policy cleared.";

                if (_settings is not null)
                {
                    _settings = _settings with
                    {
                        SecureKeyRelease = new SecureKeyReleaseDto(false, null, null, null)
                    };
                }
            }
            else
            {
                var payload = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();
                _secureKeyReleaseError = payload?.Error ?? "Failed to clear policy.";
            }
        }
        catch (Exception ex)
        {
            _secureKeyReleaseError = $"Failed to clear policy: {ex.Message}";
        }
        finally
        {
            _isSecureKeyReleaseSaving = false;
        }
    }

    private async Task<HttpResponseMessage> SendAuthorizedAsync(HttpRequestMessage request)
    {
        var token = await AuthStateService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            throw new InvalidOperationException("You must be signed in to manage encryption settings.");
        }

        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
        return await Http.SendAsync(request);
    }

    private Uri BuildApiUri(string relativePath)
    {
        relativePath = relativePath.TrimStart('/');
        return new Uri(new Uri(Navigation.BaseUri), relativePath);
    }

    private async Task CopyToClipboardAsync(string label, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            _statusMessage = $"Nothing to copy for {label}.";
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", value);
            _statusMessage = $"{label} copied to clipboard.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to copy {label}: {ex.Message}";
        }
    }

    private string GetInstructionTabClass(string tab) =>
        $"btn btn-sm {(string.Equals(_activeInstructionTab, tab, StringComparison.OrdinalIgnoreCase) ? "btn-primary" : "btn-outline-secondary")}";

    private void SetInstructionTab(string tab) => _activeInstructionTab = tab;

    private string _activeInstructionTabDisplay => _activeInstructionTab switch
    {
        "aws" => "AWS",
        "offline" => "Offline",
        _ => "Azure"
    };

    private string DisplayExternalId => string.IsNullOrWhiteSpace(_settings?.Aws?.ExternalId)
        ? "Not generated yet"
        : _settings.Aws.ExternalId!;

    private string AzureScriptSnippet =>
        """
        pwsh scripts/tenant-keyvault-onboarding.ps1 `
            -ResourceGroup <rg-name> `
            -Region <azure-region> `
            -KeyVaultName <kv-name> `
            -EvermailManagedIdentityObjectId <object-id> `
            -KeyName evermail-tmk
        """.Trim();

    private const string EvermailAwsPrincipalPlaceholder = "<EvermailAWSPrincipal>";

    private string AwsTrustPolicySnippet
    {
        get
        {
            var externalId = string.IsNullOrWhiteSpace(_settings?.Aws?.ExternalId)
                ? "<ExternalId>"
                : _settings.Aws.ExternalId!;

            return @$"{{
  ""Version"": ""2012-10-17"",
  ""Statement"": [
    {{
      ""Effect"": ""Allow"",
      ""Principal"": {{ ""AWS"": ""{EvermailAwsPrincipalPlaceholder}"" }},
      ""Action"": ""sts:AssumeRole"",
      ""Condition"": {{
        ""StringEquals"": {{ ""sts:ExternalId"": ""{externalId}"" }}
      }}
    }}
  ]
}}".Trim();
        }
    }

    private string AwsPermissionPolicySnippet
    {
        get
        {
            var kmsArn = string.IsNullOrWhiteSpace(_form.Aws.KmsKeyArn)
                ? "<KmsKeyArn>"
                : _form.Aws.KmsKeyArn;

            return @$"{{
  ""Version"": ""2012-10-17"",
  ""Statement"": [
    {{
      ""Effect"": ""Allow"",
      ""Action"": [
        ""kms:GenerateDataKey"",
        ""kms:GenerateDataKeyWithoutPlaintext"",
        ""kms:Encrypt"",
        ""kms:Decrypt"",
        ""kms:DescribeKey""
      ],
      ""Resource"": ""{kmsArn}""
    }}
  ]
}}".Trim();
        }
    }

    private static string Truncate(string? value, int max = 12)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "—";
        }

        return value.Length <= max ? value : $"{value[..max]}…";
    }

    private sealed class EncryptionFormModel
    {
        public string Provider { get; set; } = AzureProvider;
        public AzureSettings Azure { get; set; } = new();
        public AwsSettings Aws { get; set; } = new();

        public static EncryptionFormModel FromDto(TenantEncryptionSettingsDto dto) =>
            new()
            {
                Provider = dto.Provider ?? AzureProvider,
                Azure = new AzureSettings
                {
                    KeyVaultUri = dto.Azure?.KeyVaultUri ?? string.Empty,
                    KeyVaultKeyName = dto.Azure?.KeyVaultKeyName ?? string.Empty,
                    KeyVaultKeyVersion = dto.Azure?.KeyVaultKeyVersion ?? string.Empty,
                    KeyVaultTenantId = dto.Azure?.KeyVaultTenantId ?? string.Empty,
                    ManagedIdentityObjectId = dto.Azure?.ManagedIdentityObjectId ?? string.Empty
                },
                Aws = new AwsSettings
                {
                    AccountId = dto.Aws?.AccountId ?? string.Empty,
                    Region = dto.Aws?.Region ?? "eu-west-1",
                    KmsKeyArn = dto.Aws?.KmsKeyArn ?? string.Empty,
                    IamRoleArn = dto.Aws?.IamRoleArn ?? string.Empty
                }
            };
    }

    private sealed class AzureSettings
    {
        public string KeyVaultUri { get; set; } = string.Empty;
        public string KeyVaultKeyName { get; set; } = string.Empty;
        public string KeyVaultKeyVersion { get; set; } = string.Empty;
        public string KeyVaultTenantId { get; set; } = string.Empty;
        public string ManagedIdentityObjectId { get; set; } = string.Empty;
    }

    private sealed class AwsSettings
    {
        public string AccountId { get; set; } = string.Empty;
        public string Region { get; set; } = "eu-west-1";
        public string KmsKeyArn { get; set; } = string.Empty;
        public string IamRoleArn { get; set; } = string.Empty;
    }
}

