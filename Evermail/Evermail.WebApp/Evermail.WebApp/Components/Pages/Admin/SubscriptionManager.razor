@page "/admin/subscriptions"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,SuperAdmin")]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject Evermail.Infrastructure.Data.EvermailDbContext DbContext
@inject Microsoft.AspNetCore.Identity.UserManager<Evermail.Domain.Entities.ApplicationUser> UserManager
@inject NavigationManager Navigation

<PageTitle>Manage Subscriptions - Evermail</PageTitle>

<AuthorizeView Roles="Admin,SuperAdmin">
    <Authorized>
        <div class="container mt-4">
            <h1>Subscription Manager</h1>
            <p class="text-muted">Change user subscription tiers for testing</p>

    <div class="card mt-4">
        <div class="card-body">
            <h5>Change Subscription Tier</h5>
            
            <div class="mb-3">
                <label class="form-label">User Email</label>
                <input type="email" 
                       class="form-control" 
                       @bind="_userEmail" 
                       placeholder="user@example.com" />
            </div>

            <div class="mb-3">
                <label class="form-label">New Subscription Tier</label>
                <select class="form-select" @bind="_selectedTier">
                    <option value="">-- Select Tier --</option>
                    @foreach (var plan in _plans)
                    {
                        <option value="@plan.Name">
                            @plan.DisplayName (@plan.MaxFileSizeGB GB max file, @plan.MaxStorageGB GB storage)
                        </option>
                    }
                </select>
            </div>

            @if (!string.IsNullOrEmpty(_message))
            {
                <div class="alert @(_isError ? "alert-danger" : "alert-success")">
                    @_message
                </div>
            }

            <button class="btn btn-primary" @onclick="ChangeSubscriptionAsync" disabled="@_isProcessing">
                @if (_isProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Change Subscription
            </button>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5>Current Subscription Plans</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>Max File Size</th>
                        <th>Total Storage</th>
                        <th>Max Users</th>
                        <th>Price (Monthly)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var plan in _plans)
                    {
                        <tr>
                            <td><strong>@plan.DisplayName</strong></td>
                            <td>@plan.MaxFileSizeGB GB</td>
                            <td>@plan.MaxStorageGB GB</td>
                            <td>@(plan.MaxUsers == int.MaxValue ? "Unlimited" : plan.MaxUsers.ToString())</td>
                            <td>€@plan.PriceMonthly</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <CheckAuthAndRedirect />
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Evermail.Domain.Entities.SubscriptionPlan> _plans = new();
    private string _userEmail = "";
    private string _selectedTier = "";
    private string _message = "";
    private bool _isError;
    private bool _isProcessing;

    protected override async Task OnInitializedAsync()
    {
        _plans = await DbContext.SubscriptionPlans
            .OrderBy(p => p.DisplayOrder)
            .ToListAsync();
    }

    private async Task ChangeSubscriptionAsync()
    {
        _isProcessing = true;
        _message = "";
        _isError = false;

        try
        {
            // Validate inputs
            if (string.IsNullOrWhiteSpace(_userEmail))
            {
                _message = "Please enter a user email address";
                _isError = true;
                return;
            }

            if (string.IsNullOrWhiteSpace(_selectedTier))
            {
                _message = "Please select a subscription tier";
                _isError = true;
                return;
            }

            // Find user by email
            var user = await UserManager.FindByEmailAsync(_userEmail);
            if (user == null)
            {
                _message = $"User with email '{_userEmail}' not found";
                _isError = true;
                return;
            }

            // Get user's tenant
            var tenant = await DbContext.Tenants
                .FirstOrDefaultAsync(t => t.Id == user.TenantId);
            
            if (tenant == null)
            {
                _message = "Tenant not found for user";
                _isError = true;
                return;
            }

            // Verify the selected tier exists
            var plan = _plans.FirstOrDefault(p => p.Name == _selectedTier);
            if (plan == null)
            {
                _message = "Invalid subscription tier selected";
                _isError = true;
                return;
            }

            // Update tenant's subscription tier
            var oldTier = tenant.SubscriptionTier;
            tenant.SubscriptionTier = _selectedTier;
            tenant.MaxStorageGB = plan.MaxStorageGB;
            tenant.MaxUsers = plan.MaxUsers;
            tenant.UpdatedAt = DateTime.UtcNow;

            await DbContext.SaveChangesAsync();

            _message = $"✅ Successfully changed {user.Email} from '{oldTier}' to '{_selectedTier}' tier";
            _isError = false;

            // Clear form
            _userEmail = "";
            _selectedTier = "";
        }
        catch (Exception ex)
        {
            _message = $"Error: {ex.Message}";
            _isError = true;
        }
        finally
        {
            _isProcessing = false;
        }
    }
}

