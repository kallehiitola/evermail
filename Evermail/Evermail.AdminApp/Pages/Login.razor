@page "/login"
@layout Evermail.AdminApp.Shared.EmptyLayout
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject IWebHostEnvironment Env

<PageTitle>Evermail Admin</PageTitle>

<AuthorizeView>
    <Authorized>
        @* If already authenticated, bounce to home *@
        <RedirectHome />
    </Authorized>
    <NotAuthorized>
        <div class="home-wrapper auth-wrapper">
            <div class="auth-grid">
                <section class="auth-hero-card auth-hero-card--gradient auth-hero-card--login">
                    <span class="auth-hero-card__eyebrow text-uppercase">Evermail Ops</span>
                    <h1>Admin portal</h1>
                    <p class="text-muted mb-3">
                        Internal-only access. OAuth + allowlist enforced. Every action is audited.
                    </p>

                    <div class="auth-pill-group">
                        <span class="auth-pill"><strong>RBAC</strong> Restricted access</span>
                        <span class="auth-pill"><strong>Key Vault</strong> Secrets-backed</span>
                        <span class="auth-pill"><strong>Zero-touch</strong> Ops dashboard</span>
                    </div>

                    <ul class="auth-highlights">
                        <li><i class="bi bi-shield-lock"></i> OAuth-only authentication</li>
                        <li><i class="bi bi-person-check"></i> Allowlist enforced on ticket</li>
                        <li><i class="bi bi-clipboard-data"></i> Operational actions audited</li>
                    </ul>

                    <div class="mt-4 d-flex align-items-center gap-2">
                        <img src="/evermail_logo.png" alt="Evermail" style="height: 28px;" />
                        <span class="evermail-logo__word">evermail</span>
                    </div>
                </section>

                <section class="auth-card">
                    <header class="auth-card__header">
                        <h2>Sign in</h2>
                        <p class="text-muted mb-0">Continue with a connected identity provider.</p>
                    </header>

                    <div class="auth-social">
                        @if (GoogleEnabled)
                        {
                            <a class="social-btn social-btn--google" href="@BuildLoginUrl("google")">
                                <i class="bi bi-google"></i>Continue with Google
                            </a>
                        }
                        @if (MicrosoftEnabled)
                        {
                            <a class="social-btn social-btn--microsoft" href="@BuildLoginUrl("microsoft")">
                                <i class="bi bi-microsoft"></i>Continue with Microsoft
                            </a>
                        }
                    </div>

                    @if (DevBypassEnabled)
                    {
                        <div class="mt-3">
                            <form method="post" action="@BuildDevBypassUrl()">
                                <button type="submit" class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="bi bi-lightning-charge me-2" aria-hidden="true"></i>Dev bypass (localhost only)
                                </button>
                            </form>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="alert alert-danger auth-alert">@_error</div>
                    }

                    <div class="auth-divider"><span>access policy</span></div>
                    <div class="small text-muted">
                        Access is restricted to allowlisted accounts (for example <code>@@evermail.ai</code>).
                    </div>

                    <div class="modern-card mt-4">
                        <h3 class="h6 mb-2">Redirect URIs (copy exactly)</h3>
                        <div class="small text-muted mb-3">
                            Add these to your OAuth clientâ€™s <strong>Authorized redirect URIs</strong>.
                        </div>

                        <div class="data-table">
                            <div class="data-row">
                                <div class="data-key">Google (http)</div>
                                <div class="data-value"><code>@GoogleRedirectHttp</code></div>
                                <div class="data-value" style="text-align:right;">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => CopyAsync(GoogleRedirectHttp)">Copy</button>
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-key">Google (https)</div>
                                <div class="data-value"><code>@GoogleRedirectHttps</code></div>
                                <div class="data-value" style="text-align:right;">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => CopyAsync(GoogleRedirectHttps)">Copy</button>
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-key">Microsoft (http)</div>
                                <div class="data-value"><code>@MicrosoftRedirectHttp</code></div>
                                <div class="data-value" style="text-align:right;">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => CopyAsync(MicrosoftRedirectHttp)">Copy</button>
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-key">Microsoft (https)</div>
                                <div class="data-value"><code>@MicrosoftRedirectHttps</code></div>
                                <div class="data-value" style="text-align:right;">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => CopyAsync(MicrosoftRedirectHttps)">Copy</button>
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(_copiedMessage))
                        {
                            <div class="small text-muted mt-2">@_copiedMessage</div>
                        }
                    </div>
                </section>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string? _error;
    private string _returnUrl = "/";
    private string? _copiedMessage;
    
    private bool GoogleEnabled =>
        !string.IsNullOrWhiteSpace(Configuration["Authentication:Google:ClientId"]) &&
        !string.IsNullOrWhiteSpace(Configuration["Authentication:Google:ClientSecret"]);

    private bool MicrosoftEnabled =>
        !string.IsNullOrWhiteSpace(Configuration["Authentication:Microsoft:ClientId"]) &&
        !string.IsNullOrWhiteSpace(Configuration["Authentication:Microsoft:ClientSecret"]);

    private bool DevBypassEnabled =>
        !Env.IsProduction() && Configuration.GetValue("AdminAuth:DevBypassEnabled", false);

    protected override void OnInitialized()
    {
        var uri = new Uri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        _error = query.TryGetValue("error", out var error) ? error.ToString() : null;
        _returnUrl = query.TryGetValue("returnUrl", out var returnUrl) ? returnUrl.ToString() : "/";
    }

    private string BuildLoginUrl(string provider)
    {
        var returnUrl = Uri.EscapeDataString(_returnUrl);
        return $"/auth/login/{provider}?returnUrl={returnUrl}";
    }

    private string BuildDevBypassUrl()
    {
        var returnUrl = Uri.EscapeDataString(_returnUrl);
        return $"/auth/dev-bypass?returnUrl={returnUrl}";
    }

    // AdminApp launchSettings typically exposes both:
    // - http://localhost:5152
    // - https://localhost:7241
    private static string GoogleRedirectHttp => "http://localhost:5152/signin-google-admin";
    private static string GoogleRedirectHttps => "https://localhost:7241/signin-google-admin";
    private static string MicrosoftRedirectHttp => "http://localhost:5152/signin-microsoft-admin";
    private static string MicrosoftRedirectHttps => "https://localhost:7241/signin-microsoft-admin";

    private async Task CopyAsync(string value)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", value);
        _copiedMessage = $"Copied: {value}";
    }
}


