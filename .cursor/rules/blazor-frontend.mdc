---
description: Blazor component design and frontend patterns
globs: ["**/Pages/**/*.razor", "**/Components/**/*.razor", "**/*.razor"]
alwaysApply: false
---

# Blazor Frontend Patterns

## Component Design

### Keep Components Small and Focused

```razor
@* Good ✅ - Single responsibility *@
<EmailListItem Email="@Email" OnClick="@OnEmailClicked" />

@* Bad ❌ - Too many responsibilities *@
<EmailList>
    @* Contains search, filters, pagination, item rendering *@
</EmailList>
```

### Component Structure

```razor
@* EmailListItem.razor *@
@using Evermail.Common.DTOs

<MudPaper Class="mb-2 pa-4 cursor-pointer" @onclick="HandleClick">
    <div class="d-flex justify-space-between">
        <div class="flex-grow-1">
            <MudText Typo="Typo.subtitle1" Class="font-weight-bold">
                @Email.Subject
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                From: @Email.FromAddress | @Email.Date.ToString("MMM dd, yyyy")
            </MudText>
            <MudText Typo="Typo.body2" Class="mt-2">
                @Email.Snippet
            </MudText>
        </div>
        @if (Email.HasAttachments)
        {
            <MudIcon Icon="@Icons.Material.Filled.AttachFile" />
        }
    </div>
</MudPaper>

@code {
    [Parameter, EditorRequired]
    public EmailDto Email { get; set; } = null!;

    [Parameter]
    public EventCallback<Guid> OnClick { get; set; }

    private async Task HandleClick()
    {
        await OnClick.InvokeAsync(Email.Id);
    }
}
```

## Render Mode

```razor
@* For WebAssembly (interactive) *@
@rendermode InteractiveWebAssembly

@* For Server (real-time) *@
@rendermode InteractiveServer

@* For Admin Dashboard (Server) *@
@page "/admin/dashboard"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
```

## State Management

### Service-Based State

```csharp
public class EmailSearchState
{
    private string _searchQuery = string.Empty;
    private List<EmailDto> _results = new();

    public string SearchQuery
    {
        get => _searchQuery;
        set
        {
            _searchQuery = value;
            OnStateChanged?.Invoke();
        }
    }

    public IReadOnlyList<EmailDto> Results => _results.AsReadOnly();

    public event Action? OnStateChanged;

    public void SetResults(List<EmailDto> results)
    {
        _results = results;
        OnStateChanged?.Invoke();
    }
}

// Register as scoped
builder.Services.AddScoped<EmailSearchState>();
```

### Component Usage

```razor
@inject EmailSearchState SearchState
@implements IDisposable

<MudTextField @bind-Value="SearchState.SearchQuery" 
              Label="Search emails"
              Immediate="true" />

<div class="mt-4">
    @foreach (var email in SearchState.Results)
    {
        <EmailListItem Email="@email" OnClick="@NavigateToEmail" />
    }
</div>

@code {
    protected override void OnInitialized()
    {
        SearchState.OnStateChanged += StateHasChanged;
    }

    public void Dispose()
    {
        SearchState.OnStateChanged -= StateHasChanged;
    }

    private void NavigateToEmail(Guid emailId)
    {
        NavigationManager.NavigateTo($"/emails/{emailId}");
    }
}
```

## HTTP Client Configuration

```csharp
// Program.cs
builder.Services.AddHttpClient("EverMailAPI", client =>
{
    client.BaseAddress = new Uri(builder.Configuration["ApiBaseUrl"]!);
})
.AddHttpMessageHandler<AuthenticationHandler>();

// AuthenticationHandler.cs
public class AuthenticationHandler : DelegatingHandler
{
    private readonly ILocalStorageService _localStorage;

    public AuthenticationHandler(ILocalStorageService localStorage)
    {
        _localStorage = localStorage;
    }

    protected override async Task<HttpResponseMessage> SendAsync(
        HttpRequestMessage request,
        CancellationToken cancellationToken)
    {
        var token = await _localStorage.GetItemAsync<string>("authToken");
        
        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = 
                new AuthenticationHeaderValue("Bearer", token);
        }

        return await base.SendAsync(request, cancellationToken);
    }
}
```

## API Service Pattern

```csharp
public interface IEmailService
{
    Task<ApiResponse<PagedResult<EmailDto>>> SearchAsync(
        string query,
        int page = 1,
        CancellationToken cancellationToken = default
    );
    Task<ApiResponse<EmailDto>> GetByIdAsync(Guid id);
}

public class EmailService : IEmailService
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly ILogger<EmailService> _logger;

    public EmailService(
        IHttpClientFactory httpClientFactory,
        ILogger<EmailService> logger)
    {
        _httpClientFactory = httpClientFactory;
        _logger = logger;
    }

    public async Task<ApiResponse<PagedResult<EmailDto>>> SearchAsync(
        string query,
        int page = 1,
        CancellationToken cancellationToken = default)
    {
        var client = _httpClientFactory.CreateClient("EverMailAPI");
        
        try
        {
            var response = await client.GetFromJsonAsync<ApiResponse<PagedResult<EmailDto>>>(
                $"/api/v1/emails/search?q={Uri.EscapeDataString(query)}&page={page}",
                cancellationToken
            );

            return response ?? new ApiResponse<PagedResult<EmailDto>>(
                Success: false,
                Error: "No response from server"
            );
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "HTTP error searching emails");
            return new ApiResponse<PagedResult<EmailDto>>(
                Success: false,
                Error: "Network error. Please try again."
            );
        }
    }
}
```

## MudBlazor Usage

```razor
@using MudBlazor

@* Dialog *@
<MudDialog>
    <DialogContent>
        <MudText>Are you sure you want to delete this mailbox?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="Confirm">
            Delete
        </MudButton>
    </DialogActions>
</MudDialog>

@* Loading State *@
@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_emails?.Any() == true)
{
    @foreach (var email in _emails)
    {
        <EmailListItem Email="@email" />
    }
}
else
{
    <MudText Typo="Typo.body1" Color="Color.Secondary">
        No emails found
    </MudText>
}

@* Snackbar for notifications *@
@inject ISnackbar Snackbar

@code {
    private async Task DeleteMailbox()
    {
        var result = await MailboxService.DeleteAsync(mailboxId);
        
        if (result.Success)
        {
            Snackbar.Add("Mailbox deleted successfully", Severity.Success);
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to delete mailbox", Severity.Error);
        }
    }
}
```

## Form Handling

```razor
<EditForm Model="@_model" OnValidSubmit="@HandleSubmit">
    <DataAnnotationsValidator />
    
    <MudTextField Label="Email"
                  @bind-Value="_model.Email"
                  For="@(() => _model.Email)"
                  Required="true" />
    
    <MudTextField Label="Password"
                  @bind-Value="_model.Password"
                  For="@(() => _model.Password)"
                  InputType="InputType.Password"
                  Required="true" />
    
    <MudButton ButtonType="ButtonType.Submit"
               Variant="Variant.Filled"
               Color="Color.Primary"
               Disabled="@_isSubmitting">
        @if (_isSubmitting)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            <MudText Class="ml-2">Logging in...</MudText>
        }
        else
        {
            <MudText>Login</MudText>
        }
    </MudButton>
</EditForm>

@code {
    private LoginModel _model = new();
    private bool _isSubmitting;

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        
        try
        {
            var result = await AuthService.LoginAsync(_model);
            
            if (result.Success)
            {
                await LocalStorage.SetItemAsync("authToken", result.Data!.Token);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                Snackbar.Add(result.Error ?? "Login failed", Severity.Error);
            }
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    public class LoginModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(12)]
        public string Password { get; set; } = string.Empty;
    }
}
```

## Error Boundaries

```razor
<ErrorBoundary>
    <ChildContent>
        @* Your components here *@
        <EmailList />
    </ChildContent>
    <ErrorContent Context="exception">
        <MudAlert Severity="Severity.Error">
            <MudText Typo="Typo.h6">An error occurred</MudText>
            <MudText Typo="Typo.body2">@exception.Message</MudText>
        </MudAlert>
    </ErrorContent>
</ErrorBoundary>
```

## Performance Optimization

### Virtualization for Large Lists

```razor
<Virtualize Items="@_emails" Context="email">
    <EmailListItem Email="@email" />
</Virtualize>
```

### ShouldRender Override

```csharp
@code {
    private string _lastSearchQuery = string.Empty;

    protected override bool ShouldRender()
    {
        // Only re-render if search query changed
        if (_lastSearchQuery != SearchQuery)
        {
            _lastSearchQuery = SearchQuery;
            return true;
        }
        return false;
    }
}
```
